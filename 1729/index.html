<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="loilo.ico" type="image/x-icon">
    <title>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆ ã‚¹ã‚¯ãƒ¼ãƒ«</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "BIZ UDGothic", sans-serif; overflow: hidden; height: 100vh; user-select: none; color: #333; background: #fff; }
        input, button, textarea { font-family: "BIZ UDGothic", sans-serif; }
        
        /* å…±é€šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #12264d; z-index: 2500; 
            display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }

        /* --- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« (ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢) --- */
        #view-portal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #12264d; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        .portal-logo-img { max-width: 300px; height: auto; margin-bottom: 30px; }
        .portal-btn {
            background: #fff; color: #333; width: 320px; height: 50px; border-radius: 4px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1rem;
            border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: opacity 0.2s;
        }
        .portal-btn:hover { opacity: 0.9; }
        .btn-icon-img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }
        .portal-links { margin-top: 10px; text-align: center; font-size: 0.9rem; }
        .portal-links a { color: #fff; text-decoration: underline; cursor: pointer; display: block; margin-bottom: 8px; }
        .portal-footer { margin-top: 40px; font-size: 0.8rem; opacity: 0.8; }
        .portal-footer span { margin: 0 5px; cursor: pointer; }

        /* å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ç³» */
        .login-box {
            background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 16px; text-align: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .pass-input-field { padding: 10px; font-size: 1.2rem; border-radius: 8px; border: none; text-align: center; width: 200px; margin-bottom: 20px; }
        .login-action-btn { padding: 10px 30px; font-size: 1.1rem; background: #007aff; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .back-link { margin-top: 20px; color: #aaa; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }
        .login-error-msg { color: #ff6b6b; margin-top: 15px; font-weight: bold; min-height: 20px; white-space: pre-wrap; line-height: 1.5; }

        /* --- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ --- */
        #view-list { display: none; width: 100%; height: 100%; background-color: #fff; }
        .list-sidebar { width: 260px; background-color: #f5f5f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding-top: 20px; }
        .class-title { padding: 0 20px 15px 20px; font-weight: bold; color: #555; font-size: 1rem; }
        .subject-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .subject-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 1rem; border-radius: 8px; transition: background 0.1s; }
        .subject-item:hover { background-color: rgba(0,0,0,0.05); }
        .subject-active { background-color: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .subject-menu-icon { color: #aaa; font-size: 1.2rem; font-weight: bold; }
        .sidebar-bottom { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f5f5f7; }
        .bottom-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; cursor: pointer; font-size: 0.95rem; color: #444; font-weight: bold; }
        .bottom-item img { width: 24px; height: 24px; object-fit: contain; }
        .code-item { color: #0099ff; } 
        .list-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .list-header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; position: relative; }
        .tab-container { display: flex; gap: 10px; margin: 0 auto; transform: translateX(50px); }
        .tab-btn { display: flex; align-items: center; gap: 6px; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: #666; }
        .tab-active { background-color: #e6f2ff; color: #007aff; }
        .tab-icon { width: 20px; height: 20px; object-fit: contain; }
        .header-right-area { display: flex; align-items: center; gap: 15px; color: #007aff; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .list-toolbar-area { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; }
        .new-note-btn { display: flex; align-items: center; gap: 8px; color: #0099ff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .plus-icon-img { width: 28px; height: 28px; }
        .tool-icons-right { display: flex; gap: 15px; align-items: center; }
        .tool-icon { width: 28px; height: 28px; cursor: pointer; opacity: 0.7; }
        .notes-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .note-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
        .note-item:hover { background-color: #f9f9f9; }
        .note-thumb { width: 60px; height: 45px; background-color: #12264d; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; }
        .note-info { flex: 1; }
        .note-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 4px; }
        .note-date { font-size: 0.85rem; color: #999; }
        .note-menu-dots { color: #bbb; font-size: 1.5rem; font-weight: bold; margin-left: 10px; }

        /* --- ç”»é¢2: ç·¨é›†ç”»é¢ --- */
        #view-edit { display: none; width: 100%; height: 100%; background-color: #12264d; color: #333; position: relative; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 70px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-upper { background-color: #f4f5f7; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .back-nav { width: 100%; display: flex; align-items: center; justify-content: center; color: #007aff; font-weight: bold; font-size: 0.8rem; cursor: pointer; margin: 10px 0; }
        .back-nav span { font-size: 1.1rem; margin-right: 2px; font-weight: normal; }
        .icon-btn { width: 54px; height: 54px; margin-bottom: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.1s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-lower { background-color: transparent; width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; gap: 12px; }
        .circle-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .circle-icon { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #fff; position: relative; z-index: 2; }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }
        .circle-wrapper::after { content: "â—€"; color: #fff; font-size: 0.9rem; position: absolute; right: -18px; top: 12px; font-weight: bold; }
        .icon-label-white { color: #fff; font-size: 0.65rem; margin-top: 3px; font-weight: bold; }
        .header-info-edit { position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .user-name-area { font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; position: relative;}
        .user-name-area:hover { background: rgba(255,255,255,0.2); }
        .class-info-edit { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        .trash-area { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; color: #666; z-index: 50; cursor: pointer; transition: transform 0.1s; }
        .trash-area:active { transform: scale(0.95); }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge { background: #333; color: #fff; border: 1px solid #777; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px; }

        /* ----------------------------------------------------
           â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
           ---------------------------------------------------- */
        .user-menu-dropdown {
            position: fixed; top: 60px; right: 20px; 
            background: #fff; color: #333;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 320px; display: none; z-index: 9999;
            overflow: hidden; border: 1px solid #ddd;
            font-family: "BIZ UDGothic", sans-serif;
            text-align: center;
        }
        .menu-header-info { padding: 20px; border-bottom: 1px solid #eee; background: #fcfcfc; }
        .p-school { font-size: 0.9rem; color: #555; margin-bottom: 8px; }
        .p-id { font-size: 1rem; color: #666; margin-bottom: 8px; font-family: monospace; }
        .p-name { font-size: 1.4rem; font-weight: bold; color: #333; }
        
        .profile-menu-item { padding: 15px 0; border-bottom: 1px solid #eee; color: #007aff; font-weight: bold; cursor: pointer; transition: background 0.1s; }
        .profile-menu-item:hover { background: #f0f8ff; }
        .profile-menu-item:last-child { border-bottom: none; }
        .sub-status { font-size: 0.7rem; color: #f00; font-weight: normal; margin-top: 3px; }

        /* ----------------------------------------------------
           â˜… ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
           ---------------------------------------------------- */
        #view-settings {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 4000;
            display: none; align-items: center; justify-content: center;
        }
        .settings-modal {
            width: 600px; height: 80%; background: #f5f5f7;
            border-radius: 12px; display: flex; flex-direction: column;
            overflow: hidden; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .settings-header {
            background: #f5f5f7; padding: 15px; border-bottom: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
        }
        .settings-title { font-weight: bold; font-size: 1.1rem; flex: 1; text-align: center; }
        .settings-close-btn { color: #007aff; cursor: pointer; font-weight: bold; }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-section-title { font-size: 0.85rem; color: #666; margin: 20px 0 5px 15px; }
        .settings-group { background: #fff; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .settings-row {
            padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1rem;
        }
        .settings-row:last-child { border-bottom: none; }
        .toggle-switch { position: relative; width: 50px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34c759; } 
        input:checked + .slider:before { transform: translateX(20px); }
        .range-container { display: flex; align-items: center; gap: 10px; width: 50%; }
        .range-slider { width: 100%; }
        .setting-val { color: #666; }
        .version-text { color: #888; font-size: 0.9rem; margin-top: 20px; text-align: center; }

        /* ãƒãƒ£ãƒƒãƒˆ (æå‡ºç®±) */
        #chat-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 75%; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; overflow: hidden; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; font-size: 1.1rem; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; transition: background 0.2s; border-radius: 8px;}
        .wrapper-mine { align-self: flex-end; align-items: flex-end; }
        .wrapper-other { align-self: flex-start; align-items: flex-start; }
        .msg-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; border: 1px solid #eee; position: relative; width: 100%; cursor: pointer; transition: transform 0.1s; }
        .msg-card:active { transform: scale(0.98); }
        .msg-mine { background: #e6f2ff; border: 1px solid #cce5ff; }
        .msg-other { background: #fff; }
        .reply-ref { background: rgba(0,0,0,0.05); border-left: 3px solid #007aff; padding: 4px 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.8rem; color: #555; }
        #reply-status-bar { background: #e6f2ff; padding: 5px 15px; font-size: 0.8rem; display: none; justify-content: space-between; align-items: center; border-top: 1px solid #ccc; color: #007aff; font-weight: bold; }
        .cancel-reply { cursor: pointer; color: #f00; margin-left: 10px; font-weight: bold; }
        .input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; align-items: center; flex-direction: column; }
        .input-row { display: flex; width: 100%; gap: 10px; align-items: center; }
        #chat-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; padding: 0 20px; border:none; height:44px; border-radius:8px;}
        #loading-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #007aff; animation: load 1s infinite linear; display: none; z-index: 300; }
        @keyframes load { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }
        .read-label { font-size: 0.7rem; color: #888; margin-top: 2px; font-weight: bold; text-align: right; cursor: help; }

        /* ç®¡ç†è€…ãƒ‘ãƒãƒ« */
        #view-admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; color: #333; }
        .admin-header { background: #333; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.2rem; }
        .admin-close-btn { background: #555; border: 1px solid #777; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        
        .admin-layout { display: flex; flex: 1; overflow: hidden; }
        .admin-left-col { flex: 7; display: flex; flex-direction: column; border-right: 1px solid #eee; }
        .admin-log-viewer { flex: 3; padding: 20px; overflow-y: auto; background: #f9f9f9; border-left: 1px solid #ddd; }
        
        .add-user-area { padding: 20px; background: #eef2f5; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
        .admin-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .admin-btn { padding: 8px 16px; background: #007aff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .admin-btn-secondary { padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .admin-btn.del { background: #ff3b30; }

        .admin-user-list { flex: 1; overflow-y: auto; padding: 20px; }
        .user-control-row { width: 100%; display: flex; flex-direction: column; padding: 15px; border-bottom: 1px solid #eee; gap: 10px; }
        .user-info-row { display: flex; justify-content: space-between; align-items: center; }
        .user-settings-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        .user-info-admin { font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .edit-icon, .delete-icon { cursor: pointer; font-size: 1.2rem; opacity: 0.6; }
        .edit-icon:hover, .delete-icon:hover { opacity: 1; }
        
        .device-info { font-size: 0.8rem; color: #666; font-weight: normal; margin-left: 10px; }
        .setting-block { display: flex; align-items: center; gap: 8px; background: #f5f5f7; padding: 5px 10px; border-radius: 6px; border: 1px solid #ddd; }
        .status-label { font-size: 0.8rem; font-weight: bold; color: #555; }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        .log-entry { font-family: monospace; font-size: 0.8rem; border-bottom: 1px solid #e0e0e0; padding: 6px 0; line-height: 1.4; }
        .log-time { color: #007aff; font-weight: bold; margin-right: 8px; }
        .log-type { display: inline-block; padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 0.7rem; margin-right: 5px; }
        .log-login { background: #4caf50; } .log-warn { background: #ff9800; } .log-del { background: #f44336; } .log-change { background: #2196f3; } .log-chat { background: #9c27b0; } .log-add { background: #00bcd4; }

        /* ãã®ä»–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #camera-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #webcam-video { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        #camera-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; pading: 20px; }
        .cam-controls { pointer-events: auto; position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .cam-shutter { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #ccc; display: inline-block; cursor: pointer; }
        .cam-close { pointer-events: auto; position: absolute; bottom: 40px; right: 40px; background: #444; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        #color-picker-overlay { position: fixed; top: 0; left: 70px; width: 300px; height: auto; background: #fff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 400; display: none; padding: 10px; border: 1px solid #ccc; }
        .color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .color-opt { height: 60px; border: 1px solid #ccc; cursor: pointer; }
        .c-pink { background: #ffcdd2; } .c-red { background: #ef5350; } .c-yellow { background: #fff9c4; } .c-orange { background: #ffca28; } .c-green-l { background: #c8e6c9; } .c-green-d { background: #00897b; } .c-blue-l { background: #b3e5fc; } .c-blue-d { background: #1565c0; } .c-white { background: #fff; } .c-black { background: #000; }
        
        #card-editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffcdd2; z-index: 450; display: none; flex-direction: column; }
        .editor-toolbar { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .editor-tools-center { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 30px; }
        .et-icon { width: 36px; height: 36px; border-radius: 50%; background: #666; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .et-icon.active { background: #00bcd4; }
        .editor-send-btn { background: transparent; border: 2px solid #fff; border-radius: 20px; color: #fff; font-weight: bold; padding: 5px 20px; cursor: pointer; }
        .editor-back-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; color: #fff; cursor: pointer; font-size: 1.2rem; }
        .editor-main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #card-textarea { width: 80%; height: 80%; background: transparent; border: none; outline: none; font-size: 2rem; font-family: inherit; resize: none; text-align: center; color: #333; }

    </style>
</head>
<body>

    <!-- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« -->
    <div id="view-portal">
        <img src="loilo.png" alt="LOILONOTE SCHOOL" class="portal-logo-img">
        <button class="portal-btn" onclick="goToUserLogin()"><img src="loi.png" class="btn-icon-img" alt=""> ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="google.png" class="btn-icon-img" alt=""> Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="mic.png" class="btn-icon-img" alt=""> Microsoftã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div class="portal-links">
            <a>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‹ã‚‰ãªã„å ´åˆ</a><br>
            <a onclick="goToAdminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
            <a>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã¨ã¯ï¼Ÿ</a>
        </div>
        <div class="portal-footer">
            <span style="text-decoration: underline;">æ—¥æœ¬èª</span> <span>ã²ã‚‰ãŒãª</span> <span>English</span> <span>ç¹é«”ä¸­æ–‡</span> <span>ç®€ä½“ä¸­æ–‡</span>
        </div>
    </div>

    <!-- ç”»é¢0.5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-user-login" class="overlay-screen">
        <div class="login-box">
            <div class="login-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div><br>
            <input type="password" id="user-pass-input" class="pass-input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="user-login-btn" class="login-action-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="user-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backToPortal()">æˆ»ã‚‹</div>
        </div>
    </div>

    <!-- ç”»é¢0.6: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-admin-login" class="overlay-screen">
        <div class="login-box" style="border: 2px solid #ffcc00;">
            <div class="login-title">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div><br>
            <input type="password" id="admin-pass-input" class="pass-input-field" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="admin-login-btn" class="login-action-btn">ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="admin-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backFromAdmin()">æˆ»ã‚‹</div>
        </div>
    </div>

    <!-- ç”»é¢0.7: ç®¡ç†è€…ãƒ‘ãƒãƒ« (æ‹¡å¼µ) -->
    <div id="view-admin-panel">
        <div class="admin-header">
            <span>ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
            <div>
                <button class="admin-btn-secondary" onclick="toggleIdVisibility()">IDè¡¨ç¤º</button>
                <span class="admin-close-btn" onclick="closeAdminPanel()">é–‰ã˜ã‚‹</span>
            </div>
        </div>
        
        <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ã‚¨ãƒªã‚¢ (é€šå¸¸ç®¡ç†è€…ã¯éè¡¨ç¤ºã«ã•ã‚Œã‚‹) -->
        <div class="add-user-area" id="admin-add-area">
            <strong>æ–°è¦è¿½åŠ :</strong>
            <input type="text" id="new-user-id" class="admin-input" placeholder="ID (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)" style="width:120px;">
            <input type="text" id="new-user-name" class="admin-input" placeholder="åå‰" style="width:150px;">
            <button class="admin-btn" onclick="addNewUser()">è¿½åŠ </button>
            <div style="flex:1;"></div>
            <button id="admin-delete-all-btn" class="admin-btn del">âš  å…¨å±¥æ­´æ¶ˆå»</button>
        </div>

        <div class="admin-layout">
            <div class="admin-left-col">
                <div class="admin-user-list" id="admin-user-list">
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>
            <div class="admin-log-viewer">
                <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>
                <div id="system-log-container">
                    <!-- ãƒ­ã‚°ãŒã“ã“ã«å…¥ã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <div id="view-list">
        <div class="list-sidebar">
            <div class="class-title">2å¹´6çµ„</div>
            <div class="subject-list">
                <div class="subject-item subject-active">è‹±èªA <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">éŸ³æ¥½ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å®¶åº­ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å­¦æ´» <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æŠ€è¡“ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å›½èª <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç¤¾ä¼š <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æ•°å­¦ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç·åˆ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ä½“è‚² <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">é“å¾³ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç†ç§‘ <span class="subject-menu-icon">...</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="bottom-item code-item"><img src="purasu.png" alt="+"> ã‚¯ãƒ©ã‚¹å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
                <div class="bottom-item"><img src="hei.png" alt="é–‰è¬›"> é–‰è¬›ã—ãŸæˆæ¥­</div>
                <div class="bottom-item"><img src="jisyu.png" alt="è‡ªä¸»"> è‡ªä¸»å­¦ç¿’</div>
                <div class="bottom-item"><img src="sin.png" alt="æ–°"> æ–°æ©Ÿèƒ½</div>
                <div class="bottom-item"><img src="roiro.png" alt="i"> ãƒ­ã‚¤ãƒ­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
            </div>
        </div>
        <div class="list-main">
            <div class="list-header-top">
                <div class="tab-container">
                    <div class="tab-btn tab-active"><img src="no.png" class="tab-icon">ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="kyo.png" class="tab-icon">å…±æœ‰ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="tei.png" class="tab-icon">æå‡ºç®±</div>
                    <div class="tab-btn"><img src="tai.png" class="tab-icon">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
                </div>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="header-right-area" id="header-user-area">
                    <span class="user-icon-mini"></span> 
                    <span class="display-name-ref">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span>âˆ¨</span>
                </div>
            </div>
            <div class="list-toolbar-area">
                <div class="new-note-btn"><img src="purasu.png" class="plus-icon-img" alt="+">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œã‚‹</div>
                <div class="tool-icons-right">
                    <img src="sika.png" class="tool-icon" title="ã‚°ãƒªãƒƒãƒ‰">
                    <img src="yaji.png" class="tool-icon" title="ä¸¦ã³æ›¿ãˆ">
                    <img src="riro.png" class="tool-icon" title="æ›´æ–°">
                    <img src="ten.png" class="tool-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                </div>
            </div>
            <div class="notes-container">
                <div class="note-item" onclick="goToEditMode()">
                    <div class="note-thumb"></div>
                    <div class="note-info"><div class="note-title">2025å¹´12æœˆ4æ—¥ã®ãƒãƒ¼ãƒˆ</div><div class="note-date">2025å¹´12æœˆ4æ—¥(æœ¨) 10:18</div></div>
                    <div class="note-menu-dots">...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢2: ç·¨é›†ç”»é¢ -->
    <div id="view-edit">
        <div class="sidebar">
            <div class="sidebar-upper">
                <div class="back-nav" onclick="goToListMode()"><span>ï¼œ</span> æˆ»ã‚‹</div>
                <div class="icon-btn" id="btn-camera"><img src="kamera.png" alt="ã‚«ãƒ¡ãƒ©"></div>
                <div class="icon-btn" id="btn-text"><img src="text.png" alt="ãƒ†ã‚­ã‚¹ãƒˆ"></div>
                <div class="icon-btn" onclick="window.open('https://school.loilo.tv/jp/web.html', '_blank')"><img src="web.png" alt="Web"></div>
                <div class="icon-btn" onclick="document.getElementById('file-input').click()"><img src="file.png" alt="ãƒ•ã‚¡ã‚¤ãƒ«"></div>
                <div class="icon-btn"><img src="think.png" alt="ãƒ„ãƒ¼ãƒ«"></div>
                <div class="icon-btn"><img src="test.png" alt="ãƒ†ã‚¹ãƒˆ"></div>
            </div>
            <div class="sidebar-lower">
                <div class="circle-wrapper" onclick="window.open('https://copilot.microsoft.com', '_blank')">
                    <div class="circle-icon"><img src="si.png" alt="è³‡æ–™ç®±"></div><div class="icon-label-white">è³‡æ–™ç®±</div>
                </div>
                <div class="circle-wrapper" id="toggle-chat-btn"><div class="circle-icon"><img src="te.png" alt="æå‡º"></div><div class="icon-label-white">æå‡º</div></div>
                <div class="circle-wrapper" onclick="window.location.href='https://loilonote.app/_/'">
                    <div class="circle-icon"><img src="o.png" alt="é€ã‚‹"></div><div class="icon-label-white">é€ã‚‹</div>
                </div>
            </div>
        </div>
        <div class="header-info-edit">
            <div class="user-name-area" id="user-name-display"><span id="current-name">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span style="font-size:0.8rem; margin-left:5px;">âˆ¨</span></div>
            <div class="class-info-edit">2å¹´6çµ„ / è‹±èªA<br><span id="current-date">--</span></div>
        </div>
        <div class="trash-area" id="trash-btn" title="ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚µãƒ¼ãƒãƒ¼å®¹é‡ã‚’ç©ºã‘ã‚‹"><img src="gomi.png" class="trash-img" alt="ã‚´ãƒŸç®±"><div class="saved-badge">ä¿å­˜æ¸ˆã¿</div></div>

        <!-- æå‡ºç®± -->
        <div id="chat-overlay">
            <div id="loading-indicator"></div>
            <div class="chat-header">æå‡ºç®±ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼‰<span class="close-btn" id="close-chat-x">Ã—</span></div>
            <div id="msg-list"></div>
            <div class="input-area">
                <div id="reply-status-bar" style="width:100%; display:none; justify-content:space-between; margin-bottom:5px;">
                    <span id="reply-target-text">è¿”ä¿¡å…ˆ...</span><span class="cancel-reply" onclick="cancelReply()">Ã—</span>
                </div>
                <div class="input-row">
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <button id="photo-btn" title="å†™çœŸã‚’è¿½åŠ " style="display:none;">ğŸ“·</button>
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." autocomplete="off">
                    <button id="send-btn">é€ä¿¡</button>
                </div>
            </div>
        </div>

        <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½ç¾¤ -->
        <div id="camera-overlay"><video id="webcam-video" autoplay playsinline></video><div id="camera-ui-layer"><div class="cam-controls"><div class="cam-shutter"></div></div><div class="cam-close" id="close-camera-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>
        <div id="color-picker-overlay"><div class="color-grid"><div class="color-opt c-pink" onclick="openEditor('#ffcdd2')"></div><div class="color-opt c-red" onclick="openEditor('#ef5350')"></div><div class="color-opt c-yellow" onclick="openEditor('#fff9c4')"></div><div class="color-opt c-orange" onclick="openEditor('#ffca28')"></div><div class="color-opt c-green-l" onclick="openEditor('#c8e6c9')"></div><div class="color-opt c-green-d" onclick="openEditor('#00897b')"></div><div class="color-opt c-blue-l" onclick="openEditor('#b3e5fc')"></div><div class="color-opt c-blue-d" onclick="openEditor('#1565c0')"></div><div class="color-opt c-white" onclick="openEditor('#fff')"></div><div class="color-opt c-black" onclick="openEditor('#222')"></div></div></div>
        <div id="card-editor-overlay">
            <div class="editor-toolbar"><div class="editor-back-btn" onclick="closeEditor()">â†</div><div class="editor-tools-center"><div class="et-icon">ğŸ‘†</div><div class="et-icon">ğŸ–Šï¸</div><div class="et-icon active">ã‚</div><div class="et-icon">ğŸ¤</div><div class="et-icon">â¹ï¸</div></div><div style="display:flex; gap:10px;"><div class="et-icon">...</div><button class="editor-send-btn" onclick="sendCardFromEditor()">é€ã‚‹</button></div></div>
            <div class="editor-main"><textarea id="card-textarea" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea></div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="user-menu-dropdown" class="user-menu-dropdown">
        <div class="menu-header-info">
            <div class="p-school">æ¨ªæµœå¸‚ç«‹å¸‚å ´ä¸­å­¦æ ¡</div>
            <div class="p-id" id="p-user-id">---</div>
            <div class="p-name" id="p-user-realname">---</div>
        </div>
        <div class="profile-menu-item" onclick="window.open('https://help.loilonote.app/', '_blank')">ã‚µãƒãƒ¼ãƒˆ</div>
        <div class="profile-menu-item">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã‚‹</div>
        <div class="profile-menu-item" onclick="openSettings()">ã‚¢ãƒ—ãƒªè¨­å®š</div>
        <div class="profile-menu-item" onclick="alert('ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚\nå¿œç­”æ™‚é–“: 12ms')">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³<div class="sub-status">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šãŒã‚ã‚Šã¾ã™</div></div>
        <div class="profile-menu-item" id="menu-change-name" onclick="changeNameAction()">åå‰ã‚’å¤‰æ›´</div>
        <div class="profile-menu-item" onclick="goToAdminLoginFromMenu()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="profile-menu-item" onclick="location.reload()" style="color:#ff3b30;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="view-settings">
        <div class="settings-modal">
            <div class="settings-header">
                <span class="settings-close-btn" onclick="closeSettings()">é–‰ã˜ã‚‹</span>
                <span class="settings-title">ã‚¢ãƒ—ãƒªè¨­å®š</span>
                <span style="width:40px;"></span>
            </div>
            <div class="settings-content">
                <div class="settings-section-title">æ‹¡å¤§ãƒ»ç¸®å°</div>
                <div class="settings-group">
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã®æ–¹å‘ã‚’åè»¢ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div>
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                    <div class="settings-row"><span>ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                </div>
                <div class="settings-section-title">è¨€èªè¨­å®š</div>
                <div class="settings-group"><div class="settings-row"><span>æ—¥æœ¬èª</span><span style="color:#007aff; cursor:pointer;">å¤‰æ›´ âˆ¨</span></div></div>
                <div class="settings-section-title">æ‰‹æ›¸ã</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒšãƒ³å„ªå…ˆãƒ¢ãƒ¼ãƒ‰</span><label class="toggle-switch"><input type="checkbox" checked><span class="slider"></span></label></div></div>
                <div class="settings-section-title">éŒ²éŸ³ãƒ»éŒ²ç”»</div>
                <div class="settings-group"><div class="settings-row"><span>é›‘éŸ³ã‚’ä½æ¸›ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="settings-section-title">ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’</span><span style="color:#ccc;">></span></div></div>
                <div class="settings-section-title">è©¦é¨“ä¸­ã®æ©Ÿèƒ½</div>
                <div class="settings-group"><div class="settings-row"><span>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="version-text">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v5.28</div>
                <div class="version-text">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDocs, deleteDoc, setDoc, limit, getDoc, deleteField } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyC9UgkUd62D79QfweQA1i0akH04kxwItD4",
          authDomain: "newchat-90c71.firebaseapp.com",
          projectId: "newchat-90c71",
          storageBucket: "newchat-90c71.firebasestorage.app",
          messagingSenderId: "633675964296",
          appId: "1:633675964296:web:89ea68a0c7de516a29a43d",
          measurementId: "G-7SM0B9KDXE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
        const INITIAL_USERS = {
            "1726": { name: "ç”°ä¸­å¤§æ¨¹", isAllowed: true, isAdmin: true, canChangeName: true, showNickname: true },
            "6351": { name: "è¥¿å°¾é’è‘‰", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "7253": { name: "è¥¿æ‘æ‚ ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "8712": { name: "é´«åŸå®—æ¬¡éƒ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "8827": { name: "å¯Œæ°¸æ‚ æœˆ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "sample12": { name: "ã‚µãƒ³ãƒ—ãƒ«1", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "sample25": { name: "ã‚µãƒ³ãƒ—ãƒ«2", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "sample726": { name: "ã‚µãƒ³ãƒ—ãƒ«3", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true },
            "admin": { name: "ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ", isAllowed: true, isAdmin: true, canChangeName: false, showNickname: false }
        };
        // ä¿è­·å¯¾è±¡ID
        const PROTECTED_IDS = ["1726", "admin"];
        const SUPER_ADMIN_PASS = ["1726", "admin"];

        // å¤‰æ•°
        let currentStream = null;
        let selectedColor = '#ffcdd2';
        let myName = localStorage.getItem('loilo_v2_name') || "ã“ã“ã«åå‰ã‚’å…¥åŠ›";
        let realName = "";
        let currentLoginId = ""; 
        let replyTargetId = null;
        let myPermissions = { isAllowed: true, isAdmin: false, canChangeName: true }; 
        let currentAdminSessionType = 'none'; // 'super' | 'user' | 'none'
        let areIdsVisible = false;

        // ç”»é¢è¦ç´ 
        const viewPortal = document.getElementById("view-portal");
        const viewUserLogin = document.getElementById("view-user-login");
        const viewAdminLogin = document.getElementById("view-admin-login");
        const viewAdminPanel = document.getElementById("view-admin-panel");
        const viewList = document.getElementById("view-list");
        const viewEdit = document.getElementById("view-edit");
        const viewSettings = document.getElementById("view-settings");

        const headerUserArea = document.getElementById("header-user-area");
        const editUserArea = document.getElementById("user-name-display");
        const userMenu = document.getElementById("user-menu-dropdown");
        const pUserId = document.getElementById("p-user-id");
        const pUserRealName = document.getElementById("p-user-realname");
        const menuChangeName = document.getElementById("menu-change-name");
        const adminAddArea = document.getElementById("admin-add-area");

        // --- åˆæœŸåŒ–å‡¦ç† (DBã«ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°æ›¸ãè¾¼ã‚€) ---
        async function initDB() {
            try {
                const docRef = doc(db, "config", "users");
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await setDoc(docRef, INITIAL_USERS);
                    console.log("åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ");
                }
            } catch(e) { console.error("DBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", e); }
        }
        initDB();

        // ç”»é¢é·ç§»
        window.goToUserLogin = function() { viewPortal.style.display = "none"; viewUserLogin.style.display = "flex"; document.getElementById("user-pass-input").focus(); };
        window.goToAdminLogin = function() { viewPortal.style.display = "none"; viewAdminLogin.style.display = "flex"; document.getElementById("admin-pass-input").focus(); };
        
        window.backToPortal = function() { 
            viewUserLogin.style.display = "none"; 
            viewAdminLogin.style.display = "none"; 
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {} else { viewList.style.display = "flex"; }
            } else {
                viewPortal.style.display = "flex"; 
            }
            document.getElementById("user-pass-input").value = "";
            document.getElementById("admin-pass-input").value = "";
            document.getElementById("user-login-error").textContent = "";
            document.getElementById("admin-login-error").textContent = "";
        };
        
        window.backFromAdmin = function() {
            viewAdminLogin.style.display = "none";
            document.getElementById("admin-login-error").textContent = "";
            document.getElementById("admin-pass-input").value = "";
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {} else { viewList.style.display = "flex"; }
            } else {
                viewPortal.style.display = "flex";
            }
        };
        
        window.goToEditMode = function() { document.getElementById('view-list').style.display = 'none'; document.getElementById('view-edit').style.display = 'block'; };
        window.goToListMode = function() { document.getElementById('view-edit').style.display = 'none'; document.getElementById('view-list').style.display = 'flex'; toggleChat(false); closeCamera(); closeColorPicker(); closeEditor(); };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById("user-login-btn").addEventListener("click", performUserLogin);
        document.getElementById("user-pass-input").addEventListener("keypress", (e) => { if(e.key === "Enter") performUserLogin(); });

        async function performUserLogin() {
            const val = document.getElementById("user-pass-input").value;
            
            // DBã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const docRef = doc(db, "config", "users");
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const allUsers = docSnap.data();
                const user = allUsers[val];
                
                if (user) {
                    if(user.isAllowed === false) {
                        document.getElementById("user-login-error").textContent = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™";
                        return;
                    }
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
                    currentUserData = user;
                    currentLoginId = val;
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
                    startUserListener(val);
                    logSystemEvent("ãƒ­ã‚°ã‚¤ãƒ³", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ", val);

                    viewUserLogin.style.display = "none";
                    viewList.style.display = "flex";
                    updateNameDisplay();
                    return;
                }
            }
            
            document.getElementById("user-login-error").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            document.getElementById("user-pass-input").value = "";
        }

        // â–¼â–¼â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦– (å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€æ¨©é™åæ˜ ) â–¼â–¼â–¼
        let currentUserData = null; 
        function startUserListener(loginId) {
            onSnapshot(doc(db, "config", "users"), (docSnap) => {
                if (docSnap.exists()) {
                    const allUsers = docSnap.data();
                    const me = allUsers[loginId];
                    
                    if (!me) return; 

                    currentUserData = me; 
                    myPermissions = me; 

                    // 1. ãƒ­ã‚°ã‚¤ãƒ³ç¦æ­¢ãƒã‚§ãƒƒã‚¯
                    if (me.isAllowed === false) {
                        alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚\nå†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
                        location.reload(); 
                    }

                    // 2. åå‰å¤‰æ›´ãƒœã‚¿ãƒ³åˆ¶å¾¡
                    if (me.canChangeName === false) {
                        menuChangeName.style.display = "none";
                    } else {
                        menuChangeName.style.display = "block";
                    }
                    
                    updateNameDisplay();
                }
            });
            updateDeviceInfo(loginId, navigator.userAgent);
        }
        
        async function updateDeviceInfo(id, ua) {
            try {
                await setDoc(doc(db, "config", "users"), {
                    [id]: { lastDevice: ua }
                }, { merge: true });
            } catch(e) {}
        }

        async function logSystemEvent(type, msg, user) {
            try {
                await addDoc(collection(db, "system_logs"), {
                    type: type,
                    message: msg,
                    user: user, 
                    timestamp: serverTimestamp()
                });
            } catch(e) {}
        }

        // åå‰æ›´æ–°
        const currentNameSpan = document.getElementById("current-name");
        const nameRefs = document.querySelectorAll(".display-name-ref");
        const dateSpan = document.getElementById("current-date");
        const now = new Date();
        dateSpan.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ã®ãƒãƒ¼ãƒˆ`;

        function updateNameDisplay() {
            if(!currentUserData) return;
            
            let displayName = currentUserData.name;
            if (currentUserData.showNickname && myName) {
                displayName = `${myName}ãƒ»${currentUserData.name}`;
            }

            currentNameSpan.textContent = displayName;
            nameRefs.forEach(el => el.textContent = displayName);
            pUserId.textContent = currentLoginId; 
            pUserRealName.textContent = currentUserData.name;
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
        headerUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        editUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        function toggleUserMenu() { const isVisible = userMenu.style.display === 'block'; userMenu.style.display = isVisible ? 'none' : 'block'; }
        document.addEventListener('click', () => { userMenu.style.display = 'none'; });
        userMenu.addEventListener('click', (e) => { e.stopPropagation(); });

        window.changeNameAction = function() {
            userMenu.style.display = 'none';
            if (myPermissions.canChangeName === false) {
                alert("åå‰ã®å¤‰æ›´ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            const newName = prompt("è¡¨ç¤ºåã‚’å¤‰æ›´:", myName);
            if(newName && newName.trim() !== ""){
                myName = newName; localStorage.setItem('loilo_v2_name', myName); updateNameDisplay();
            }
        };
        window.openSettings = function() { userMenu.style.display = 'none'; viewSettings.style.display = "flex"; };
        window.closeSettings = function() { viewSettings.style.display = "none"; };
        window.goToAdminLoginFromMenu = function() {
            userMenu.style.display = 'none';
            viewList.style.display = 'none'; viewEdit.style.display = 'none'; viewAdminLogin.style.display = 'flex';
        }

        window.openTestLinks = function() {
            window.open('https://wq376.github.io/loilonote/1729/kouki.png', '_blank');
            window.open('https://wq376.github.io/loilonote/1729/reiwa7.png', '_blank');
        };

        // --- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ (ãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–) ---
        document.getElementById("admin-login-btn").addEventListener("click", performAdminLogin);
        async function performAdminLogin() {
            const inputId = document.getElementById("admin-pass-input").value;
            
            // 1. ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (1726, admin) ã§ã®ãƒ­ã‚°ã‚¤ãƒ³
            if (SUPER_ADMIN_PASS.includes(inputId)) {
                currentAdminSessionType = 'super';
                viewAdminLogin.style.display = "none"; viewAdminPanel.style.display = "flex"; 
                adminAddArea.style.display = "flex"; // è¿½åŠ ã‚¨ãƒªã‚¢è¡¨ç¤º
                areIdsVisible = false; 
                renderAdminList(); renderSystemLogs();
                logSystemEvent("ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹", "ç‰¹æ¨©ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³", "SUPER_ADMIN");
                return;
            }

            // 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã®ãƒ­ã‚°ã‚¤ãƒ³
            try {
                const docRef = doc(db, "config", "users");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const allUsers = docSnap.data();
                    const user = allUsers[inputId];

                    if (user) {
                        if (user.isAdmin === true) {
                            // é€šå¸¸ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                            currentAdminSessionType = 'user';
                            viewAdminLogin.style.display = "none"; viewAdminPanel.style.display = "flex"; 
                            adminAddArea.style.display = "none"; // è¿½åŠ ã‚¨ãƒªã‚¢éè¡¨ç¤º
                            areIdsVisible = false;
                            renderAdminList(); renderSystemLogs();
                            logSystemEvent("ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹", "ç®¡ç†è€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³", inputId);
                        } else {
                            document.getElementById("admin-login-error").innerText = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é€šå¸¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚\nç®¡ç†è€…æ¨©é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                            logSystemEvent("è­¦å‘Š", "æ¨©é™ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ", inputId);
                        }
                        return;
                    }
                }
            } catch(e) { console.error(e); }

            document.getElementById("admin-login-error").innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
        }
        
        window.closeAdminPanel = function() { 
            viewAdminPanel.style.display = "none"; 
            document.getElementById("admin-pass-input").value = "";
            currentAdminSessionType = 'none';
            if(currentLoginId) { viewList.style.display = "flex"; } else { viewPortal.style.display = "flex"; }
        };

        // --- ç®¡ç†è€…ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ ãƒ»å‰Šé™¤ ---
        window.addNewUser = async function() {
            if (currentAdminSessionType !== 'super') { alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            const newId = document.getElementById("new-user-id").value.trim();
            const newName = document.getElementById("new-user-name").value.trim();
            if(!newId || !newName) { alert("IDã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            
            try {
                const newUser = {
                    name: newName,
                    isAllowed: true,
                    isAdmin: false,
                    canChangeName: true,
                    showNickname: true,
                    lastDevice: ""
                };
                
                await setDoc(doc(db, "config", "users"), {
                    [newId]: newUser
                }, { merge: true });
                
                document.getElementById("new-user-id").value = "";
                document.getElementById("new-user-name").value = "";
                logSystemEvent("è¨­å®šå¤‰æ›´", `æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ : ${newName} (${newId})`, currentLoginId || "admin");
            } catch(e) { alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: "+e.message); }
        };

        window.deleteUser = async function(id) {
            if (currentAdminSessionType !== 'super') { alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            if (PROTECTED_IDS.includes(id)) { alert("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
            if(!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${id} ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            
            try {
                await updateDoc(doc(db, "config", "users"), {
                    [id]: deleteField()
                });
                logSystemEvent("è¨­å®šå¤‰æ›´", `ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤: ${id}`, currentLoginId || "admin");
            } catch(e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+e.message); }
        };
        
        window.editUserName = async function(id, currentName) {
            // é€šå¸¸ç®¡ç†è€…ã¯ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ã‚’ç·¨é›†ä¸å¯
            if (PROTECTED_IDS.includes(id) && currentAdminSessionType !== 'super') {
                alert("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã¯å¤‰æ›´ã§ãã¾ã›ã‚“"); return;
            }

            const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›:", currentName);
            if(newName && newName !== currentName) {
                 await setDoc(doc(db, "config", "users"), {
                    [id]: { name: newName }
                }, { merge: true });
            }
        };

        // â–¼â–¼â–¼ IDè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ â–¼â–¼â–¼
        window.toggleIdVisibility = function() {
            if(areIdsVisible) {
                areIdsVisible = false;
                renderAdminList(); 
                return;
            }
            
            const pass = prompt("IDè¡¨ç¤ºç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
            if (pass === "2012") {
                areIdsVisible = true;
                renderAdminList(); 
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            }
        };

        // â–¼â–¼â–¼ ç®¡ç†è€…ãƒªã‚¹ãƒˆè¡¨ç¤º â–¼â–¼â–¼
        async function renderAdminList() {
            const listDiv = document.getElementById("admin-user-list"); 
            listDiv.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            
            onSnapshot(doc(db, "config", "users"), (docSnap) => {
                listDiv.innerHTML = "";
                const allUsers = docSnap.exists() ? docSnap.data() : {};
                
                const sortedIds = Object.keys(allUsers).sort();
                
                for (let id of sortedIds) {
                    const u = allUsers[id];
                    // ãƒ‡ãƒ¼ã‚¿è£œæ­£
                    if (typeof u === 'boolean') { /*æ—§ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ*/ }
                    if (u.canChangeName === undefined) u.canChangeName = true;
                    if (u.showNickname === undefined) u.showNickname = true;

                    // ã‚¹ãƒ¼ãƒ‘ãƒ¼ç®¡ç†è€…ä¿è­·ãƒ­ã‚¸ãƒƒã‚¯
                    const isTargetProtected = PROTECTED_IDS.includes(id);
                    const canEditProtected = (currentAdminSessionType === 'super');
                    
                    // ãƒ­ãƒƒã‚¯çŠ¶æ…‹
                    const isLocked = isTargetProtected && !canEditProtected;
                    const disabledAttr = isLocked ? "disabled" : "";
                    const opacityStyle = isLocked ? "opacity:0.5; cursor:not-allowed;" : "";
                    const clickAction = isLocked ? `onclick="alert('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ¨©é™ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); return false;"` : "";

                    // IDãƒã‚¹ã‚¯
                    const displayId = areIdsVisible ? id : "****";

                    // å‰Šé™¤ãƒœã‚¿ãƒ³ (é€šå¸¸ç®¡ç†è€…ã¯è‡ªåˆ†ä»¥å¤–æ¶ˆã›ã‚‹ãŒã€ä¿è­·å¯¾è±¡ã¯æ¶ˆã›ãªã„)
                    let deleteBtnHtml = "";
                    if (currentAdminSessionType === 'super' || !isTargetProtected) {
                         deleteBtnHtml = `<span class="delete-icon" onclick="deleteUser('${id}')">ğŸ—‘ï¸</span>`;
                    }

                    const row = document.createElement("div"); row.className = "user-control-row";
                    
                    row.innerHTML = `
                        <div class="user-info-row">
                            <div class="user-info-admin">
                                ${escapeHtml(u.name)} (${displayId}) 
                                <span class="edit-icon" onclick="editUserName('${id}', '${escapeHtml(u.name)}')">âœï¸</span>
                                ${deleteBtnHtml}
                                <br><span class="device-info">ç«¯æœ«: ${u.lastDevice || "ä¸æ˜"}</span>
                            </div>
                        </div>
                        <div class="user-settings-row">
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}>
                                <span class="status-label">ãƒ­ã‚°ã‚¤ãƒ³</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${u.isAllowed ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'isAllowed', this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}>
                                <span class="status-label">ç®¡ç†è€…æ¨©é™</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${u.isAdmin ? "checked" : ""} ${disabledAttr} 
                                    onchange="togglePerm('${id}', 'isAdmin', this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}>
                                <span class="status-label">åå‰å¤‰æ›´</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${u.canChangeName ? "checked" : ""} ${disabledAttr}
                                    onchange="togglePerm('${id}', 'canChangeName', this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}>
                                <span class="status-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </span>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${u.showNickname ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'showNickname', this)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `;
                    listDiv.appendChild(row);
                }
            });
        }

        // â–¼â–¼â–¼ æ¨©é™åˆ‡ã‚Šæ›¿ãˆ â–¼â–¼â–¼
        window.togglePerm = async function(id, type, checkbox) {
            const val = checkbox.checked;
            
            // ä¿è­·ãƒã‚§ãƒƒã‚¯ (JSãƒ¬ãƒ™ãƒ«ã§ã®äºŒé‡ã‚¬ãƒ¼ãƒ‰)
            if (PROTECTED_IDS.includes(id) && currentAdminSessionType !== 'super') {
                checkbox.checked = !val; // å…ƒã«æˆ»ã™
                return;
            }

            try {
                await setDoc(doc(db, "config", "users"), {
                    [id]: { [type]: val }
                }, { merge: true });
                
                logSystemEvent("è¨­å®šå¤‰æ›´", `${id} ã® ${type} ã‚’ ${val} ã«å¤‰æ›´`, currentLoginId || "admin");
            } catch(e) {
                alert("ä¿å­˜å¤±æ•—: " + e.message);
                checkbox.checked = !val; 
            }
        };

        function renderSystemLogs() {
            const logDiv = document.getElementById("system-log-container");
            logDiv.innerHTML = "ãƒ­ã‚°èª­ã¿è¾¼ã¿ä¸­...";
            const q = query(collection(db, "system_logs"), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (snap) => {
                logDiv.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : "---";
                    let typeClass = "log-info";
                    if(data.type === "ãƒ­ã‚°ã‚¤ãƒ³") typeClass = "log-login";
                    if(data.type === "è­¦å‘Š") typeClass = "log-warn";
                    if(data.type === "å‰Šé™¤") typeClass = "log-del";
                    if(data.type === "è¨­å®šå¤‰æ›´") typeClass = "log-change";
                    
                    const el = document.createElement("div");
                    el.className = "log-entry";
                    el.innerHTML = `<span class="log-time">[${date}]</span> <span class="log-type ${typeClass}">${escapeHtml(data.type)}</span> <span class="log-user">${escapeHtml(data.user)}</span> : ${escapeHtml(data.message)}`;
                    logDiv.appendChild(el);
                });
            });
        }

        // ãƒãƒ£ãƒƒãƒˆ & Firebase
        const chatOverlay = document.getElementById("chat-overlay");
        const msgList = document.getElementById("msg-list");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-btn");
        const replyStatusBar = document.getElementById("reply-status-bar");
        const replyTargetText = document.getElementById("reply-target-text");
        const myUid = localStorage.getItem('loilo_v2_uid') || Math.random().toString(36).substring(7); localStorage.setItem('loilo_v2_uid', myUid);

        document.getElementById("toggle-chat-btn").addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        document.getElementById("close-chat-x").addEventListener("click", () => toggleChat(false));

        function toggleChat(force) {
            let show = (chatOverlay.style.display === "flex");
            if (force !== undefined) show = !force;
            chatOverlay.style.display = show ? "none" : "flex";
            if (!show) window.cancelReply();
            else msgList.scrollTop = msgList.scrollHeight;
        }

        window.cancelReply = function() { replyTargetId = null; replyStatusBar.style.display = "none"; }

        async function sendPayload(text="", file=null) {
            if(!text && !file) return;
            let imageUrl = null;
            if(file) {
                imageUrl = await new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});
            }
            
            // æŠ•ç¨¿è€…åã®æ±ºå®š
            let senderName = currentUserData ? currentUserData.name : "Unknown";
            if (currentUserData && currentUserData.showNickname && myName) {
                senderName = `${myName}ãƒ»${currentUserData.name}`;
            }

            const payload = { text, imageUrl, name: senderName, uid: myUid, createdAt: serverTimestamp(), readBy: [] };
            if(replyTargetId) payload.replyTo = replyTargetId;
            await addDoc(collection(db, "fake_loilo_v2"), payload);
            
            chatInput.value = ""; window.cancelReply();
        }
        sendBtn.addEventListener("click", ()=>sendPayload(chatInput.value));
        chatInput.addEventListener("keypress", (e)=>{if(e.key==="Enter")sendPayload(chatInput.value)});
        document.getElementById("file-input").addEventListener("change", (e)=>sendPayload("", e.target.files[0]));

        // å—ä¿¡
        const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
            msgList.innerHTML = ""; const idMap = {};
            snap.forEach(d => idMap[d.id] = d.data().text || "ç”»åƒ");
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const docId = docSnap.id;
                if (data.uid !== myUid && (!data.readBy || !data.readBy.includes(myUid))) {
                    updateDoc(doc(db, "fake_loilo_v2", docId), { readBy: arrayUnion(myUid) });
                }
                const wrapper = document.createElement("div"); wrapper.className = "msg-wrapper " + (data.uid===myUid?"wrapper-mine":"wrapper-other");
                const card = document.createElement("div"); card.className = "msg-card " + (data.uid===myUid?"msg-mine":"msg-other");
                card.id = "msg-"+docId;
                card.addEventListener("dblclick", ()=>{ replyTargetId=docId; replyTargetText.textContent="è¿”ä¿¡å…ˆ: "+(data.text||"ç”»åƒ"); replyStatusBar.style.display="flex"; chatInput.focus(); });
                let html = "";
                if(data.replyTo && idMap[data.replyTo]) html += `<div class="reply-ref" onclick="document.getElementById('msg-${data.replyTo}').scrollIntoView({behavior:'smooth'});">â†© ${escapeHtml(idMap[data.replyTo])}</div>`;
                if(data.imageUrl) html += `<img src="${data.imageUrl}" onclick="window.open(this.src)">`;
                if(data.text) html += `<div>${escapeHtml(data.text)}</div>`;
                card.innerHTML = `<div class="msg-name">${escapeHtml(data.name)}</div><div class="msg-content">${html}</div>`;
                wrapper.appendChild(card);
                if(data.uid === myUid && data.readBy && data.readBy.length > 0) {
                    const read = document.createElement("div"); read.className = "read-label"; 
                    const count = data.readBy.length; read.textContent = "æ—¢èª­ " + count;
                    // åå‰è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯(ç°¡æ˜“)
                    // æœ¬å½“ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã ãŒã€ã¨ã‚Šã‚ãˆãšäººæ•°ã®ã¿
                    read.title = "æ—¢èª­æ•°: " + count;
                    wrapper.appendChild(read);
                }
                msgList.appendChild(wrapper);
            });
            msgList.scrollTop = msgList.scrollHeight;
        });

        // ãƒ„ãƒ¼ãƒ«é¡
        const btnText = document.getElementById("btn-text");
        const colorPicker = document.getElementById("color-picker-overlay");
        const cardEditor = document.getElementById("card-editor-overlay");
        const cardTextarea = document.getElementById("card-textarea");
        
        const btnCamera = document.getElementById("btn-camera");
        const cameraOverlay = document.getElementById("camera-overlay");
        const videoEl = document.getElementById("webcam-video");
        const closeCameraBtn = document.getElementById("close-camera-btn");
        btnCamera.addEventListener("click", async () => {
            cameraOverlay.style.display = "flex";
            try { currentStream = await navigator.mediaDevices.getUserMedia({ video: true }); videoEl.srcObject = currentStream; } 
            catch (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼"); cameraOverlay.style.display = "none"; }
        });
        window.closeCamera = function() {
            cameraOverlay.style.display = "none";
            if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; }
        };
        closeCameraBtn.addEventListener("click", closeCamera);

        btnText.addEventListener("click", (e) => { e.stopPropagation(); colorPicker.style.display = "block"; });
        window.openEditor = function(c) { selectedColor=c; colorPicker.style.display="none"; cardEditor.style.background=c; cardEditor.style.display="flex"; cardTextarea.value=""; cardTextarea.focus(); };
        window.closeEditor = function() { cardEditor.style.display="none"; };
        window.sendCardFromEditor = function() { if(cardTextarea.value.trim()){ closeEditor(); toggleChat(true); sendPayload(cardTextarea.value); } };
        document.body.addEventListener("click", (e) => { if(!colorPicker.contains(e.target)&&!btnText.contains(e.target)) colorPicker.style.display="none"; });

        // --- å…¨æ¶ˆå» (Trash Bin) ---
        const trashBtn = document.getElementById("trash-btn");
        trashBtn.addEventListener("dblclick", async () => {
            if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const q = query(collection(db, "fake_loilo_v2"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((document) => { deletePromises.push(deleteDoc(document.ref)); });
                await Promise.all(deletePromises);
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
                logSystemEvent("å‰Šé™¤", "å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤(ã‚´ãƒŸç®±)", currentLoginId);
            } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        });

        // --- ç®¡ç†è€…ç”¨ï¼šå±¥æ­´å…¨æ¶ˆå»ãƒœã‚¿ãƒ³ ---
        document.getElementById("admin-delete-all-btn").addEventListener("click", async () => {
            if (!confirm("ã€è­¦å‘Šã€‘\nã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¨ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
            if (!confirm("å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                const q = query(collection(db, "fake_loilo_v2"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((document) => { deletePromises.push(deleteDoc(document.ref)); });
                await Promise.all(deletePromises);
                alert("å±¥æ­´ã‚’å…¨æ¶ˆå»ã—ã¾ã—ãŸã€‚");
                logSystemEvent("å‰Šé™¤", "å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤(ç®¡ç†è€…)", currentLoginId);
            } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        });

        function escapeHtml(str) { if(!str)return""; return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    </script>
</body>
</html>
