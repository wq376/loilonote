<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="loilo.ico" type="image/x-icon">
    <!-- UD„Éï„Ç©„É≥„Éà -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    
    <title>„É≠„Ç§„É≠„Éé„Éº„Éà „Çπ„ÇØ„Éº„É´ (Copilot Link)</title>
    <style>
        /* --- „Éô„Éº„ÇπË®≠ÂÆö --- */
        body { margin: 0; padding: 0; font-family: "BIZ UDGothic", sans-serif; overflow: hidden; height: 100vh; user-select: none; color: #333; }
        
        /* ÁîªÈù¢1: „Éé„Éº„Éà‰∏ÄË¶ßÁîªÈù¢ */
        #view-list { display: flex; width: 100%; height: 100%; background-color: #fff; }
        .list-sidebar { width: 260px; background-color: #f5f5f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding-top: 20px; }
        .class-title { padding: 0 20px 15px 20px; font-weight: bold; color: #555; font-size: 1rem; }
        .subject-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .subject-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 1rem; border-radius: 8px; transition: background 0.1s; }
        .subject-item:hover { background-color: rgba(0,0,0,0.05); }
        .subject-active { background-color: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .subject-menu-icon { color: #aaa; font-size: 1.2rem; font-weight: bold; }
        .sidebar-bottom { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f5f5f7; }
        .bottom-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; cursor: pointer; font-size: 0.95rem; color: #444; font-weight: bold; }
        .bottom-item img { width: 24px; height: 24px; object-fit: contain; }
        .code-item { color: #0099ff; } 
        .list-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .list-header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; }
        .tab-container { display: flex; gap: 10px; margin: 0 auto; transform: translateX(50px); }
        .tab-btn { display: flex; align-items: center; gap: 6px; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: #666; }
        .tab-active { background-color: #e6f2ff; color: #007aff; }
        .tab-icon { width: 20px; height: 20px; object-fit: contain; }
        .header-right-area { display: flex; align-items: center; gap: 15px; color: #007aff; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .list-toolbar-area { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; }
        .new-note-btn { display: flex; align-items: center; gap: 8px; color: #0099ff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .plus-icon-img { width: 28px; height: 28px; }
        .tool-icons-right { display: flex; gap: 15px; align-items: center; }
        .tool-icon { width: 28px; height: 28px; cursor: pointer; opacity: 0.7; }
        .tool-icon:hover { opacity: 1; }
        .notes-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .note-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
        .note-item:hover { background-color: #f9f9f9; }
        .note-thumb { width: 60px; height: 45px; background-color: #12264d; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; }
        .note-info { flex: 1; }
        .note-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 4px; }
        .note-date { font-size: 0.85rem; color: #999; }
        .note-menu-dots { color: #bbb; font-size: 1.5rem; font-weight: bold; margin-left: 10px; }

        /* ÁîªÈù¢2: Á∑®ÈõÜÔºà„ÉÅ„É£„ÉÉ„ÉàÔºâÁîªÈù¢ */
        #view-edit { display: none; width: 100%; height: 100%; background-color: #12264d; color: #333; position: relative; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 70px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-upper { background-color: #f4f5f7; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .back-nav { width: 100%; display: flex; align-items: center; justify-content: center; color: #007aff; font-weight: bold; font-size: 0.8rem; cursor: pointer; margin: 10px 0; }
        .back-nav span { font-size: 1.1rem; margin-right: 2px; font-weight: normal; }
        .icon-btn { width: 54px; height: 54px; margin-bottom: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.1s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-lower { background-color: transparent; width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; gap: 12px; }
        .circle-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .circle-icon { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #fff; position: relative; z-index: 2; }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }
        .circle-wrapper::after { content: "‚óÄ"; color: #fff; font-size: 0.9rem; position: absolute; right: -18px; top: 12px; font-weight: bold; }
        .icon-label-white { color: #fff; font-size: 0.65rem; margin-top: 3px; font-weight: bold; }
        .header-info-edit { position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .user-name-area { font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        .user-name-area:hover { background: rgba(255,255,255,0.2); }
        .class-info-edit { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        .trash-area { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; color: #666; z-index: 50; cursor: pointer; transition: transform 0.1s; }
        .trash-area:active { transform: scale(0.95); }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge { background: #333; color: #fff; border: 1px solid #777; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px; }

        /* ÊèêÂá∫ÁÆ±„ÉÄ„Éü„Éº */
        #chat-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 75%; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; overflow: hidden; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; font-size: 1.1rem; }
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .wrapper-mine { align-self: flex-end; align-items: flex-end; }
        .msg-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; border: 1px solid #eee; position: relative; width: 100%; }
        .msg-mine { background: #e6f2ff; border: 1px solid #cce5ff; }
        .input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; align-items: center; }
        #chat-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; padding: 0 20px; border:none; height:44px; border-radius:8px; cursor:pointer;}
        #photo-btn { background: #f0f0f0; border: none; width: 44px; height: 44px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }

        /* „Ç´„É°„É© */
        #camera-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #webcam-video { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        #camera-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; pading: 20px; }
        .cam-controls { pointer-events: auto; position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .cam-shutter { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #ccc; display: inline-block; cursor: pointer; }
        .cam-close { pointer-events: auto; position: absolute; bottom: 40px; right: 40px; background: #444; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        /* Ëâ≤ÈÅ∏Êäû */
        #color-picker-overlay { position: fixed; top: 0; left: 70px; width: 300px; height: auto; background: #fff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 400; display: none; padding: 10px; border: 1px solid #ccc; }
        .color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .color-opt { height: 60px; border: 1px solid #ccc; cursor: pointer; }
        .c-pink { background: #ffcdd2; } .c-red { background: #ef5350; } .c-yellow { background: #fff9c4; } .c-orange { background: #ffca28; } .c-green-l { background: #c8e6c9; } .c-green-d { background: #00897b; } .c-blue-l { background: #b3e5fc; } .c-blue-d { background: #1565c0; } .c-white { background: #fff; } .c-black { background: #000; }
        
        /* „Ç´„Éº„Éâ„Ç®„Éá„Ç£„Çø */
        #card-editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffcdd2; z-index: 450; display: none; flex-direction: column; }
        .editor-toolbar { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .editor-tools-center { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 30px; }
        .et-icon { width: 36px; height: 36px; border-radius: 50%; background: #666; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .et-icon.active { background: #00bcd4; }
        .editor-send-btn { background: transparent; border: 2px solid #fff; border-radius: 20px; color: #fff; font-weight: bold; padding: 5px 20px; cursor: pointer; }
        .editor-back-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; color: #fff; cursor: pointer; font-size: 1.2rem; }
        .editor-main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #card-textarea { width: 80%; height: 80%; background: transparent; border: none; outline: none; font-size: 2rem; font-family: inherit; resize: none; text-align: center; color: #333; }
    </style>
</head>
<body>

    <!-- ÁîªÈù¢1: „Éé„Éº„Éà‰∏ÄË¶ß -->
    <div id="view-list">
        <div class="list-sidebar">
            <div class="class-title">2Âπ¥6ÁµÑ</div>
            <div class="subject-list">
                <div class="subject-item subject-active">Ëã±Ë™ûA <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">Èü≥Ê•Ω <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ÂÆ∂Â∫≠ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">Â≠¶Ê¥ª <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ÊäÄË°ì <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ÂõΩË™û <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">Á§æ‰ºö <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">Êï∞Â≠¶ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">Á∑èÂêà <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">‰ΩìËÇ≤ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ÈÅìÂæ≥ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ÁêÜÁßë <span class="subject-menu-icon">...</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="bottom-item code-item"><img src="purasu.png" alt="+"> „ÇØ„É©„ÇπÂèÇÂä†„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ</div>
                <div class="bottom-item"><img src="hei.png" alt="ÈñâË¨õ"> ÈñâË¨õ„Åó„ÅüÊéàÊ•≠</div>
                <div class="bottom-item"><img src="jisyu.png" alt="Ëá™‰∏ª"> Ëá™‰∏ªÂ≠¶Áøí</div>
                <div class="bottom-item"><img src="sin.png" alt="Êñ∞"> Êñ∞Ê©üËÉΩ</div>
                <div class="bottom-item"><img src="roiro.png" alt="i"> „É≠„Ç§„É≠„Åã„Çâ„ÅÆ„ÅäÁü•„Çâ„Åõ</div>
            </div>
        </div>
        <div class="list-main">
            <div class="list-header-top">
                <div class="tab-container">
                    <div class="tab-btn tab-active"><img src="no.png" class="tab-icon">„Éé„Éº„Éà</div>
                    <div class="tab-btn"><img src="kyo.png" class="tab-icon">ÂÖ±Êúâ„Éé„Éº„Éà</div>
                    <div class="tab-btn"><img src="tei.png" class="tab-icon">ÊèêÂá∫ÁÆ±</div>
                    <div class="tab-btn"><img src="tai.png" class="tab-icon">„Çø„Ç§„É†„É©„Ç§„É≥</div>
                </div>
                <div class="header-right-area"><span class="user-icon-mini"></span> <span class="display-name-ref">„Åì„Åì„Å´ÂêçÂâç„ÇíÂÖ•Âäõ</span> <span>‚à®</span></div>
            </div>
            <div class="list-toolbar-area">
                <div class="new-note-btn"><img src="purasu.png" class="plus-icon-img" alt="+">Êñ∞„Åó„ÅÑ„Éé„Éº„Éà„Çí‰Ωú„Çã</div>
                <div class="tool-icons-right">
                    <img src="sika.png" class="tool-icon" title="„Ç∞„É™„ÉÉ„Éâ">
                    <img src="yaji.png" class="tool-icon" title="‰∏¶„Å≥Êõø„Åà">
                    <img src="riro.png" class="tool-icon" title="Êõ¥Êñ∞">
                    <img src="ten.png" class="tool-icon" title="„É°„Éã„É•„Éº">
                </div>
            </div>
            <div class="notes-container">
                <div class="note-item" onclick="goToEditMode()">
                    <div class="note-thumb"></div>
                    <div class="note-info"><div class="note-title">2025Âπ¥12Êúà4Êó•„ÅÆ„Éé„Éº„Éà</div><div class="note-date">2025Âπ¥12Êúà4Êó•(Êú®) 10:18</div></div>
                    <div class="note-menu-dots">...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÁîªÈù¢2: „Éé„Éº„ÉàÁ∑®ÈõÜÔºà„ÉÅ„É£„ÉÉ„ÉàÔºâÁîªÈù¢ -->
    <div id="view-edit">
        <div class="sidebar">
            <div class="sidebar-upper">
                <div class="back-nav" onclick="goToListMode()"><span>Ôºú</span> Êàª„Çã</div>
                <div class="icon-btn" id="btn-camera"><img src="kamera.png" alt="„Ç´„É°„É©"></div>
                <div class="icon-btn" id="btn-text"><img src="text.png" alt="„ÉÜ„Ç≠„Çπ„Éà"></div>
                <div class="icon-btn" onclick="window.open('https://school.loilo.tv/jp/web.html', '_blank')"><img src="web.png" alt="Web"></div>
                <div class="icon-btn" onclick="document.getElementById('file-input').click()"><img src="file.png" alt="„Éï„Ç°„Ç§„É´"></div>
                <div class="icon-btn"><img src="think.png" alt="„ÉÑ„Éº„É´"></div>
                <div class="icon-btn"><img src="test.png" alt="„ÉÜ„Çπ„Éà"></div>
            </div>
            <div class="sidebar-lower">
                <!-- Ë≥áÊñôÁÆ± -> Copilot„Çµ„Ç§„Éà„ÇíÈñã„Åè -->
                <div class="circle-wrapper" onclick="window.open('https://copilot.microsoft.com', '_blank')">
                    <div class="circle-icon"><img src="si.png" alt="Ë≥áÊñôÁÆ±"></div>
                    <div class="icon-label-white">Ë≥áÊñôÁÆ±</div>
                </div>
                <!-- ÊèêÂá∫„Éú„Çø„É≥ -->
                <div class="circle-wrapper" id="toggle-chat-btn"><div class="circle-icon"><img src="te.png" alt="ÊèêÂá∫"></div><div class="icon-label-white">ÊèêÂá∫</div></div>
                <!-- ÈÄÅ„Çã -->
                <div class="circle-wrapper" onclick="window.location.href='https://loilonote.app/_/'">
                    <div class="circle-icon"><img src="o.png" alt="ÈÄÅ„Çã"></div>
                    <div class="icon-label-white">ÈÄÅ„Çã</div>
                </div>
            </div>
        </div>
        <div class="header-info-edit">
            <div class="user-name-area" id="user-name-display"><span id="current-name">„Åì„Åì„Å´ÂêçÂâç„ÇíÂÖ•Âäõ</span> <span style="font-size:0.8rem; margin-left:5px;">‚à®</span></div>
            <div class="class-info-edit">2Âπ¥6ÁµÑ / Ëã±Ë™ûA<br><span id="current-date">--</span></div>
        </div>
        
        <div class="trash-area" id="trash-btn" title="„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„Åß„Çµ„Éº„Éê„ÉºÂÆπÈáè„ÇíÁ©∫„Åë„Çã">
            <img src="gomi.png" class="trash-img" alt="„Ç¥„ÉüÁÆ±">
            <div class="saved-badge">‰øùÂ≠òÊ∏à„Åø</div>
        </div>

        <!-- ÊèêÂá∫ÁÆ±„ÉÄ„Éü„Éº -->
        <div id="chat-overlay">
            <div class="chat-header">ÊèêÂá∫ÁÆ±Ôºà„ÉÜ„Ç≠„Çπ„Éà„Ç´„Éº„ÉâÔºâ<span class="close-btn" id="close-chat-x">√ó</span></div>
            <div id="msg-list"></div>
            <div class="input-area">
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button id="photo-btn">üì∑</button>
                <input type="text" id="chat-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..." autocomplete="off">
                <button id="send-btn">ÈÄÅ‰ø°</button>
            </div>
        </div>

        <!-- „Ç´„É°„É© -->
        <div id="camera-overlay">
            <video id="webcam-video" autoplay playsinline></video>
            <div id="camera-ui-layer">
                <div class="cam-controls"><div class="cam-shutter"></div></div>
                <div class="cam-close" id="close-camera-btn">„Ç≠„É£„É≥„Çª„É´</div>
            </div>
        </div>

        <!-- Ëâ≤ÈÅ∏Êäû -->
        <div id="color-picker-overlay">
            <div class="color-grid">
                <div class="color-opt c-pink" onclick="openEditor('#ffcdd2')"></div>
                <div class="color-opt c-red" onclick="openEditor('#ef5350')"></div>
                <div class="color-opt c-yellow" onclick="openEditor('#fff9c4')"></div>
                <div class="color-opt c-orange" onclick="openEditor('#ffca28')"></div>
                <div class="color-opt c-green-l" onclick="openEditor('#c8e6c9')"></div>
                <div class="color-opt c-green-d" onclick="openEditor('#00897b')"></div>
                <div class="color-opt c-blue-l" onclick="openEditor('#b3e5fc')"></div>
                <div class="color-opt c-blue-d" onclick="openEditor('#1565c0')"></div>
                <div class="color-opt c-white" onclick="openEditor('#fff')"></div>
                <div class="color-opt c-black" onclick="openEditor('#222')"></div>
            </div>
        </div>

        <!-- „Ç´„Éº„Éâ„Ç®„Éá„Ç£„Çø -->
        <div id="card-editor-overlay">
            <div class="editor-toolbar">
                <div class="editor-back-btn" onclick="closeEditor()">‚Üê</div>
                <div class="editor-tools-center">
                    <div class="et-icon">üëÜ</div><div class="et-icon">üñäÔ∏è</div><div class="et-icon active">„ÅÇ</div><div class="et-icon">üé§</div><div class="et-icon">‚èπÔ∏è</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="et-icon">...</div>
                    <button class="editor-send-btn" onclick="sendCardFromEditor()">ÈÄÅ„Çã</button>
                </div>
            </div>
            <div class="editor-main">
                <textarea id="card-textarea" placeholder="„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ"></textarea>
            </div>
        </div>

    </div>

    <script type="module">
        let currentStream = null;
        let selectedColor = '#ffcdd2';

        window.goToEditMode = function() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-edit').style.display = 'block';
        };
        window.goToListMode = function() {
            document.getElementById('view-edit').style.display = 'none';
            document.getElementById('view-list').style.display = 'flex';
            toggleChat(false);
            closeCamera();
            closeColorPicker();
            closeEditor();
        };

        const now = new Date();
        document.getElementById("current-date").textContent = `${now.getFullYear()}Âπ¥${now.getMonth()+1}Êúà${now.getDate()}Êó•„ÅÆ„Éé„Éº„Éà`;
        
        let myName = localStorage.getItem('loilo_v2_name') || "„Åì„Åì„Å´ÂêçÂâç„ÇíÂÖ•Âäõ";
        document.getElementById("current-name").textContent = myName;
        document.querySelectorAll(".display-name-ref").forEach(el => el.textContent = myName);

        document.getElementById("user-name-display").addEventListener('click', () => {
            const newName = prompt("Ë°®Á§∫Âêç„ÇíÂ§âÊõ¥:", myName);
            if(newName && newName.trim() !== ""){
                myName = newName; 
                document.getElementById("current-name").textContent = myName; 
                localStorage.setItem('loilo_v2_name', myName);
                document.querySelectorAll(".display-name-ref").forEach(el => el.textContent = myName);
            }
        });

        // „Ç´„É°„É©
        const btnCamera = document.getElementById("btn-camera");
        const camOverlay = document.getElementById("camera-overlay");
        const camClose = document.getElementById("close-camera-btn");
        const videoEl = document.getElementById("webcam-video");

        btnCamera.addEventListener("click", async () => {
            camOverlay.style.display = "flex";
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoEl.srcObject = currentStream;
            } catch(e) { alert("„Ç´„É°„É©Ëµ∑ÂãïÂ§±Êïó"); camOverlay.style.display = "none"; }
        });
        function closeCamera() {
            camOverlay.style.display = "none";
            if(currentStream) { currentStream.getTracks().forEach(t => t.stop()); currentStream = null; }
        }
        camClose.addEventListener("click", closeCamera);

        // ÊèêÂá∫ÁÆ±Ôºà„ÉÅ„É£„ÉÉ„ÉàÔºâ
        const toggleChatBtn = document.getElementById("toggle-chat-btn");
        const chatOverlay = document.getElementById("chat-overlay");
        const closeChatX = document.getElementById("close-chat-x");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-btn");
        const msgList = document.getElementById("msg-list");

        function toggleChat(force) {
            let show = (chatOverlay.style.display === "flex");
            if(force !== undefined) show = !force;
            chatOverlay.style.display = show ? "none" : "flex";
        }
        toggleChatBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        closeChatX.addEventListener("click", () => toggleChat(false));

        sendBtn.addEventListener("click", () => {
            if(!chatInput.value.trim()) return;
            const div = document.createElement("div");
            div.classList.add("msg-wrapper", "wrapper-mine");
            div.innerHTML = `<div class="msg-card msg-mine">${escapeHtml(chatInput.value)}</div>`;
            msgList.appendChild(div);
            chatInput.value = "";
        });

        // „ÉÑ„Éº„É´Èñ¢ÈÄ£
        const btnText = document.getElementById("btn-text");
        const colorPicker = document.getElementById("color-picker-overlay");
        const cardEditor = document.getElementById("card-editor-overlay");
        const cardTextarea = document.getElementById("card-textarea");

        btnText.addEventListener("click", (e) => { e.stopPropagation(); colorPicker.style.display = "block"; });
        window.openEditor = function(c) {
            selectedColor = c;
            colorPicker.style.display = "none";
            cardEditor.style.background = c;
            cardEditor.style.display = "flex";
            cardTextarea.value = "";
            cardTextarea.focus();
        }
        window.closeEditor = function() { cardEditor.style.display = "none"; }
        window.closeColorPicker = function() { colorPicker.style.display = "none"; }
        window.sendCardFromEditor = function() {
            if(!cardTextarea.value.trim()) return;
            closeEditor();
            toggleChat(true);
            const div = document.createElement("div");
            div.classList.add("msg-wrapper", "wrapper-mine");
            div.innerHTML = `<div class="msg-card msg-mine" style="background:${selectedColor}">${escapeHtml(cardTextarea.value)}</div>`;
            msgList.appendChild(div);
        }

        document.body.addEventListener("click", (e) => {
            if(!colorPicker.contains(e.target) && !btnText.contains(e.target)) closeColorPicker();
        });

        function escapeHtml(str) { if(!str) return ""; return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    </script>
</body>
</html>
