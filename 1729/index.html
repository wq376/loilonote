<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- â†“ YouTubeå†ç”Ÿæ™‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼(153)ã‚’é˜²ããŸã‚ã«å¿…è¦ -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="loilo.ico" type="image/x-icon">
    <title>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆ ã‚¹ã‚¯ãƒ¼ãƒ«</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "BIZ UDGothic", sans-serif; overflow: hidden; height: 100vh; user-select: none; color: #333; background: #fff; }
        input, button, textarea { font-family: "BIZ UDGothic", sans-serif; }
        
        /* å…±é€šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #12264d; z-index: 2500; 
            display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }

        /* --- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« (ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢) --- */
        #view-portal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #12264d; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        .portal-logo-img { max-width: 300px; height: auto; margin-bottom: 30px; }
        .portal-btn {
            background: #fff; color: #333; width: 320px; height: 50px; border-radius: 4px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1rem;
            border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: opacity 0.2s;
        }
        .portal-btn:hover { opacity: 0.9; }
        .btn-icon-img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }
        .portal-links { margin-top: 10px; text-align: center; font-size: 0.9rem; }
        .portal-links a { color: #fff; text-decoration: underline; cursor: pointer; display: block; margin-bottom: 8px; }
        .portal-footer { margin-top: 40px; font-size: 0.8rem; opacity: 0.8; }
        .portal-footer span { margin: 0 5px; cursor: pointer; }

        /* å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ç³» */
        .login-box {
            background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 16px; text-align: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .pass-input-field { padding: 10px; font-size: 1.2rem; border-radius: 8px; border: none; text-align: center; width: 200px; margin-bottom: 20px; }
        .login-action-btn { padding: 10px 30px; font-size: 1.1rem; background: #007aff; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .back-link { margin-top: 20px; color: #aaa; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }
        .login-error-msg { color: #ff6b6b; margin-top: 15px; font-weight: bold; min-height: 20px; white-space: pre-wrap; line-height: 1.5; }

        /* --- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ --- */
        #view-list { display: none; width: 100%; height: 100%; background-color: #fff; }
        .list-sidebar { width: 260px; background-color: #f5f5f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding-top: 20px; }
        .class-title { padding: 0 20px 15px 20px; font-weight: bold; color: #555; font-size: 1rem; }
        .subject-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .subject-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 1rem; border-radius: 8px; transition: background 0.1s; }
        .subject-item:hover { background-color: rgba(0,0,0,0.05); }
        .subject-active { background-color: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .subject-menu-icon { color: #aaa; font-size: 1.2rem; font-weight: bold; }
        .sidebar-bottom { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f5f5f7; }
        .bottom-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; cursor: pointer; font-size: 0.95rem; color: #444; font-weight: bold; }
        .bottom-item img { width: 24px; height: 24px; object-fit: contain; }
        .code-item { color: #0099ff; } 
        .list-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .list-header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; position: relative; }
        .tab-container { display: flex; gap: 10px; margin: 0 auto; transform: translateX(50px); }
        .tab-btn { display: flex; align-items: center; gap: 6px; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: #666; }
        .tab-active { background-color: #e6f2ff; color: #007aff; }
        .tab-icon { width: 20px; height: 20px; object-fit: contain; }
        .header-right-area { display: flex; align-items: center; gap: 15px; color: #007aff; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .list-toolbar-area { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; }
        .new-note-btn { display: flex; align-items: center; gap: 8px; color: #0099ff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .plus-icon-img { width: 28px; height: 28px; }
        .tool-icons-right { display: flex; gap: 15px; align-items: center; }
        .tool-icon { width: 28px; height: 28px; cursor: pointer; opacity: 0.7; }
        .notes-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .note-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
        .note-item:hover { background-color: #f9f9f9; }
        .note-thumb { width: 60px; height: 45px; background-color: #12264d; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; }
        .note-info { flex: 1; }
        .note-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 4px; }
        .note-date { font-size: 0.85rem; color: #999; }
        .note-menu-dots { color: #bbb; font-size: 1.5rem; font-weight: bold; margin-left: 10px; }

        /* --- ç”»é¢2: ç·¨é›†ç”»é¢ --- */
        #view-edit { display: none; width: 100%; height: 100%; background-color: #12264d; color: #333; position: relative; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 70px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-upper { background-color: #f4f5f7; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .back-nav { width: 100%; display: flex; align-items: center; justify-content: center; color: #007aff; font-weight: bold; font-size: 0.8rem; cursor: pointer; margin: 10px 0; }
        .back-nav span { font-size: 1.1rem; margin-right: 2px; font-weight: normal; }
        .icon-btn { width: 54px; height: 54px; margin-bottom: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.1s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-lower { background-color: transparent; width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; gap: 12px; }
        .circle-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .circle-icon { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #fff; position: relative; z-index: 2; }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }
        .circle-wrapper::after { content: "â—€"; color: #fff; font-size: 0.9rem; position: absolute; right: -18px; top: 12px; font-weight: bold; }
        .icon-label-white { color: #fff; font-size: 0.65rem; margin-top: 3px; font-weight: bold; }
        .header-info-edit { position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        
        /* åå‰ã‚¨ãƒªã‚¢ */
        .user-name-area { 
            font-size: 1.1rem; font-weight: bold; cursor: pointer; 
            display: flex; align-items: center; 
            background: transparent; /* é€æ˜ */
            padding: 0; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã— */
            border-radius: 0; /* è§’ä¸¸ãªã— */
            color: #fff; margin-right: 10px;
        }
        .user-name-area:hover { opacity: 0.8; }
        
        .class-info-edit { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        .trash-area { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; color: #666; z-index: 50; cursor: pointer; transition: transform 0.1s; }
        .trash-area:active { transform: scale(0.95); }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge { background: #333; color: #fff; border: 1px solid #777; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px; }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .user-menu-dropdown {
            position: fixed; top: 60px; right: 20px; 
            background: #fff; color: #333;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 320px; display: none; z-index: 9999;
            overflow: hidden; border: 1px solid #ddd;
            font-family: "BIZ UDGothic", sans-serif;
            text-align: center;
        }
        .menu-header-info { padding: 20px; border-bottom: 1px solid #eee; background: #fcfcfc; }
        .p-school { font-size: 0.9rem; color: #555; margin-bottom: 8px; }
        .p-id { font-size: 1rem; color: #666; margin-bottom: 8px; font-family: monospace; }
        .p-name { font-size: 1.4rem; font-weight: bold; color: #333; }
        
        .profile-menu-item { padding: 15px 0; border-bottom: 1px solid #eee; color: #007aff; font-weight: bold; cursor: pointer; transition: background 0.1s; }
        .profile-menu-item:hover { background: #f0f8ff; }
        .profile-menu-item:last-child { border-bottom: none; }
        .sub-status { font-size: 0.7rem; color: #f00; font-weight: normal; margin-top: 3px; display: none; }

        /* ãƒãƒ£ãƒƒãƒˆ (æå‡ºç®±) */
        #chat-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 75%; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; overflow: hidden; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; font-size: 1.1rem; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; transition: background 0.2s; border-radius: 8px;}
        .wrapper-mine { align-self: flex-end; align-items: flex-end; }
        .wrapper-other { align-self: flex-start; align-items: flex-start; }
        .msg-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; border: 1px solid #eee; position: relative; width: 100%; cursor: pointer; transition: transform 0.1s; }
        .msg-card:active { transform: scale(0.98); }
        .msg-mine { background: #e6f2ff; border: 1px solid #cce5ff; }
        .msg-other { background: #fff; }
        .reply-ref { background: rgba(0,0,0,0.05); border-left: 3px solid #007aff; padding: 4px 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.8rem; color: #555; }
        #reply-status-bar { background: #e6f2ff; padding: 5px 15px; font-size: 0.8rem; display: none; justify-content: space-between; align-items: center; border-top: 1px solid #ccc; color: #007aff; font-weight: bold; }
        .cancel-reply { cursor: pointer; color: #f00; margin-left: 10px; font-weight: bold; }
        .input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; align-items: center; flex-direction: column; }
        .input-row { display: flex; width: 100%; gap: 10px; align-items: center; }
        #chat-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; padding: 0 20px; border:none; height:44px; border-radius:8px;}
        #loading-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #007aff; animation: load 1s infinite linear; display: none; z-index: 300; }
        @keyframes load { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }
        .read-label { font-size: 0.7rem; color: #888; margin-top: 2px; font-weight: bold; text-align: right; cursor: help; }
        .msg-unsend-btn { color: #888; cursor: pointer; margin-left: 10px; font-size: 0.8rem; border: none; background: none; font-weight: bold; }
        .msg-unsend-btn:hover { color: #f00; }

        /* ç®¡ç†è€…ãƒ‘ãƒãƒ« */
        #view-admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; color: #333; }
        .admin-header { background: #333; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.2rem; }
        .admin-close-btn { background: #555; border: 1px solid #777; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        
        .admin-layout { display: flex; flex: 1; overflow: hidden; }
        /* â˜…ä¿®æ­£: å·¦å´6ã€å³å´4ã«æˆ»ã™ */
        .admin-left-col { flex: 6; display: flex; flex-direction: column; border-right: 1px solid #eee; }
        .admin-right-col { flex: 4; display: flex; flex-direction: column; background: #f9f9f9; border-left: 1px solid #ddd; }
        
        .admin-tabs { display: flex; background: #eee; }
        .admin-tab { flex: 1; padding: 10px 4px; text-align: center; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; font-size: 0.85rem; white-space: nowrap; }
        .admin-tab.active { background: #fff; border-bottom: 2px solid #007aff; color: #007aff; }
        .admin-tab-content { flex: 1; overflow-y: auto; padding: 10px; display: none; }
        .admin-tab-content.active { display: block; }
        
        .add-user-area { padding: 20px; background: #eef2f5; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
        .admin-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .admin-btn { padding: 8px 16px; background: #007aff; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .admin-btn-secondary { padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .admin-btn.del { background: #ff3b30; }
        .admin-btn.csv { background: #28a745; margin-left: 10px; }

        .admin-user-list { flex: 1; overflow-y: auto; padding: 20px; }
        .user-control-row { width: 100%; display: flex; flex-direction: column; padding: 15px; border-bottom: 1px solid #eee; gap: 10px; }
        .user-info-row { display: flex; justify-content: space-between; align-items: center; }
        .user-settings-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .setting-block { display: flex; align-items: center; gap: 8px; background: #f5f5f7; padding: 5px 10px; border-radius: 6px; border: 1px solid #ddd; }
        .status-label { font-size: 0.8rem; font-weight: bold; color: #555; }
        .user-info-admin { font-size: 1.1rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .edit-icon, .delete-icon, .alert-icon { cursor: pointer; font-size: 1.2rem; opacity: 0.6; }
        .edit-icon:hover, .delete-icon:hover, .alert-icon:hover { opacity: 1; }
        .device-info { font-size: 0.8rem; color: #666; font-weight: normal; margin-left: 10px; }

        .log-entry { font-family: monospace; font-size: 0.8rem; border-bottom: 1px solid #e0e0e0; padding: 6px 0; line-height: 1.4; }
        .log-time { color: #007aff; font-weight: bold; margin-right: 8px; }
        .log-type { display: inline-block; padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 0.7rem; margin-right: 5px; }
        .log-login { background: #4caf50; } .log-warn { background: #ff9800; } .log-del { background: #f44336; } .log-change { background: #2196f3; } .log-chat { background: #9c27b0; } .log-add { background: #00bcd4; } .log-alert { background: #e91e63; }
        
        .admin-chat-item { background: #fff; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: flex-start; }
        .ac-info { font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .ac-content { font-size: 0.95rem; font-weight: bold; white-space: pre-wrap; word-break: break-all; }
        .ac-delete-btn { background: #ff3b30; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        
        .filter-item { background: #fff; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; display: inline-flex; align-items: center; margin: 4px; font-weight: bold; color: #333; }
        .filter-item .del-btn { margin-left: 8px; cursor: pointer; color: #ff3b30; font-weight: bold; font-size: 1.1rem; }
        .filter-item .del-btn:hover { opacity: 0.7; }

        /* ãã®ä»–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #camera-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #webcam-video { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        #camera-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; pading: 20px; }
        .cam-controls { pointer-events: auto; position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .cam-shutter { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #ccc; display: inline-block; cursor: pointer; }
        .cam-close { pointer-events: auto; position: absolute; bottom: 40px; right: 40px; background: #444; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        #color-picker-overlay { position: fixed; top: 0; left: 70px; width: 300px; height: auto; background: #fff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 400; display: none; padding: 10px; border: 1px solid #ccc; }
        .color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .color-opt { height: 60px; border: 1px solid #ccc; cursor: pointer; }
        .c-pink { background: #ffcdd2; } .c-red { background: #ef5350; } .c-yellow { background: #fff9c4; } .c-orange { background: #ffca28; } .c-green-l { background: #c8e6c9; } .c-green-d { background: #00897b; } .c-blue-l { background: #b3e5fc; } .c-blue-d { background: #1565c0; } .c-white { background: #fff; } .c-black { background: #000; }
        
        #card-editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffcdd2; z-index: 450; display: none; flex-direction: column; }
        .editor-toolbar { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .editor-tools-center { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 30px; }
        .et-icon { width: 36px; height: 36px; border-radius: 50%; background: #666; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .et-icon.active { background: #00bcd4; }
        .editor-send-btn { background: transparent; border: 2px solid #fff; border-radius: 20px; color: #fff; font-weight: bold; padding: 5px 20px; cursor: pointer; }
        .editor-back-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; color: #fff; cursor: pointer; font-size: 1.2rem; }
        .editor-main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #card-textarea { width: 80%; height: 80%; background: transparent; border: none; outline: none; font-size: 2rem; font-family: inherit; resize: none; text-align: center; color: #333; }

        /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ™‚é–“å‰²ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #view-schedule { display: none; }
        .schedule-box {
            background: #fff; width: 800px; max-width: 90%; max-height: 90%; overflow-y: auto;
            border-radius: 12px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center; color: #333;
        }
        .schedule-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 1.1rem; }
        .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 15px; text-align: center; }
        .schedule-table th { background: #f0f0f0; color: #555; }
        .schedule-table td { background: #fff; }
        .close-schedule-btn { padding: 10px 30px; background: #007aff; color: #fff; border: none; border-radius: 20px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .admin-schedule-input { width: 100%; border: none; text-align: center; font-family: inherit; font-size: 1rem; background: transparent; outline: none; }
        .admin-schedule-input:focus { background: #e6f2ff; }
        /* è¿½åŠ : æ™‚é–“å‰²è¨­å®šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .sch-type-select { width: 90%; padding: 2px; font-size: 0.8rem; }
        .sch-lunch-select { width: 90%; padding: 2px; font-size: 0.8rem; }
        .memo-area { width: 90%; height: 60px; margin-top: 15px; border: 1px solid #ccc; padding: 10px; font-family: inherit; border-radius: 4px; resize: none; }
        .memo-display-area { width: 90%; margin: 15px auto; padding: 15px; background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; text-align: left; font-size: 0.95rem; color: #333; white-space: pre-wrap; }

        /* ã‚¹ã‚¤ãƒƒãƒç³»å…±é€š */
        .toggle-switch { position: relative; width: 50px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34c759; } 
        input:checked + .slider:before { transform: translateX(20px); }

        /* ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        #view-settings { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .settings-modal { width: 600px; height: 80%; background: #f5f5f7; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .settings-header { background: #f5f5f7; padding: 15px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
        .settings-title { font-weight: bold; font-size: 1.1rem; flex: 1; text-align: center; }
        .settings-close-btn { color: #007aff; cursor: pointer; font-weight: bold; }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-section-title { font-size: 0.85rem; color: #666; margin: 20px 0 5px 15px; }
        .settings-group { background: #fff; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .settings-row { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        .settings-row:last-child { border-bottom: none; }
        .range-container { display: flex; align-items: center; gap: 10px; width: 50%; }
        .range-slider { width: 100%; }
        .setting-val { color: #666; }
        .version-text { color: #888; font-size: 0.9rem; margin-top: 20px; text-align: center; }

        /* --- æ–°è¦: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç”»é¢ --- */
        #view-service-status {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f7; z-index: 5000;
            display: none; flex-direction: column; overflow-y: auto;
            font-family: "BIZ UDGothic", sans-serif;
        }
        .status-header {
            background: #fff; padding: 20px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10;
        }
        .status-title-large { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .status-close-btn { 
            font-size: 1rem; color: #007aff; cursor: pointer; font-weight: bold; border: 1px solid #007aff; 
            padding: 5px 15px; border-radius: 4px; background: #fff; 
        }
        .status-content { max-width: 800px; margin: 0 auto; padding: 30px 20px; width: 100%; box-sizing: border-box; }

        .status-main-summary { margin-bottom: 40px; }
        .status-icon-large { font-size: 1.5rem; }
        .s-ok { color: #28a745; } .s-warn { color: #ffc107; } .s-error { color: #dc3545; }

        /* ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŠçŸ¥ã‚‰ã›ãƒœãƒƒã‚¯ã‚¹ */
        .maintenance-box {
            background: #fff9db; border: 1px solid #ffeeba; border-radius: 6px;
            padding: 20px; margin-bottom: 30px; text-align: center;
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
        }
        .maint-title { font-weight: bold; font-size: 1.1rem; color: #12264d; margin-bottom: 10px; }
        .maint-sub { font-weight: bold; margin-bottom: 5px; }
        .maint-time { font-size: 1.2rem; margin: 10px 0; }

        /* å„ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ */
        .status-item-card {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .status-check-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #fff; font-size: 0.9rem; font-weight: bold; }
        .sc-ok { background: #28a745; } .sc-warn { background: #ffc107; } .sc-error { background: #dc3545; }

        .status-text-area { flex: 1; }
        .status-label { font-weight: bold; font-size: 1rem; color: #333; }
        .status-desc { font-size: 0.85rem; color: #666; margin-top: 2px; }

        /* ç®¡ç†ç”»é¢ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š */
        .admin-status-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .admin-status-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }


/* è³‡æ–™ç®±ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
#view-material-box { display: none; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }

.material-box-modal {
    background: #f2f2f7; width: 600px; max-width: 90%; border-radius: 12px;
    overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    animation: popIn 0.2s ease-out;
}
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.material-header {
    background: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd;
    display: flex; justify-content: space-between; align-items: center;
    color: #333; font-weight: bold; font-size: 1.1rem;
}
.close-material-btn {
    font-size: 1.8rem; cursor: pointer; color: #888; line-height: 1;
}
.close-material-btn:hover { color: #333; }

.material-grid {
    padding: 30px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;
}

.material-btn {
    background: #fff; border-radius: 12px; padding: 20px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
    border: 1px solid #e0e0e0; height: 120px;
}
.material-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.material-btn:active { transform: scale(0.98); }

.m-icon { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; color: #333; }
.m-label { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 5px; }
.m-desc { font-size: 0.8rem; color: #888; }


/* è³‡æ–™ç®±å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒç”¨ã‚µã‚¤ã‚ºèª¿æ•´ */
.box-icon-img {
    width: 40px; 
    height: 40px; 
    object-fit: contain;
}


/* ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.update-list { display: flex; flex-direction: column; }
.update-item { border-bottom: 1px solid #eee; padding: 20px 0; }
.update-item:last-child { border-bottom: none; }

.u-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
.u-tag { font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #fff; }
.u-tag.new { background: #ff3b30; }
.u-date { font-size: 0.85rem; color: #888; font-family: monospace; }

.u-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 8px; }
.u-body { font-size: 0.95rem; color: #555; line-height: 1.6; }

/* ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç®¡ç†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.admin-upd-item {
    background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px;
    position: relative;
}
.admin-upd-header { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
.admin-upd-title { font-weight: bold; font-size: 1rem; color: #333; margin-bottom: 5px; }
.admin-upd-body { font-size: 0.9rem; color: #555; white-space: pre-wrap; }
.admin-upd-del {
    position: absolute; top: 10px; right: 10px;
    background: #ff3b30; color: #fff; border: none; border-radius: 4px; 
    padding: 3px 10px; cursor: pointer; font-size: 0.8rem;
}

    </style>
</head>
<body>

    <!-- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« -->
    <div id="view-portal">
        <img src="loilo.png" alt="LOILONOTE SCHOOL" class="portal-logo-img">
        <button class="portal-btn" onclick="goToUserLogin()"><img src="loi.png" class="btn-icon-img" alt=""> ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="google.png" class="btn-icon-img" alt=""> Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="mic.png" class="btn-icon-img" alt=""> Microsoftã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div class="portal-links">
            <a>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‹ã‚‰ãªã„å ´åˆ</a><br>
            <a onclick="goToAdminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
            <a>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã¨ã¯ï¼Ÿ</a>
        </div>
        <div class="portal-footer">
            <span style="text-decoration: underline;">æ—¥æœ¬èª</span> <span>ã²ã‚‰ãŒãª</span> <span>English</span> <span>ç¹é«”ä¸­æ–‡</span> <span>ç®€ä½“ä¸­æ–‡</span>
        </div>
    </div>

    <!-- ç”»é¢0.5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-user-login" class="overlay-screen">
        <div class="login-box">
            <div class="login-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div><br>
            <input type="password" id="user-pass-input" class="pass-input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="user-login-btn" class="login-action-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="user-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backToPortal()">æˆ»ã‚‹</div>
        </div>
    </div>

    <!-- ç”»é¢0.6: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-admin-login" class="overlay-screen">
        <div class="login-box" style="border: 2px solid #ffcc00;">
            <div class="login-title">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div><br>
            <input type="password" id="admin-pass-input" class="pass-input-field" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="admin-login-btn" class="login-action-btn">ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="admin-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backFromAdmin()">æˆ»ã‚‹</div>
        </div>
    </div>

    <!-- ç”»é¢0.7: ç®¡ç†è€…ãƒ‘ãƒãƒ« (æ‹¡å¼µ) -->
    <div id="view-admin-panel">
        <div class="admin-header">
            <span>ç®¡ç†è€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</span>
            <div>
                <button class="admin-btn-secondary" onclick="toggleIdVisibility()">IDè¡¨ç¤º</button>
                <span class="admin-close-btn" onclick="closeAdminPanel()">é–‰ã˜ã‚‹</span>
            </div>
        </div>
        
        <div class="add-user-area" id="admin-add-area">
            <strong>æ–°è¦è¿½åŠ :</strong>
            <input type="text" id="new-user-id" class="admin-input" placeholder="ID (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)" style="width:120px;">
            <input type="text" id="new-user-name" class="admin-input" placeholder="åå‰" style="width:150px;">
            <button class="admin-btn" onclick="addNewUser()">è¿½åŠ </button>
            <div style="flex:1;"></div>
            <button class="admin-btn csv" onclick="downloadChatCSV()">ğŸ“¥ CSVä¿å­˜</button>
            <button id="admin-delete-all-btn" class="admin-btn del">âš  å…¨æ¶ˆå»</button>
        </div>

        <div class="admin-layout">
            <div class="admin-left-col">
                <div class="admin-user-list" id="admin-user-list"></div>
            </div>
            <div class="admin-right-col">
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="switchAdminTab('log')">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div>
                    <div class="admin-tab" onclick="switchAdminTab('chat')">ãƒãƒ£ãƒƒãƒˆç®¡ç†</div>
                    <div class="admin-tab" onclick="switchAdminTab('filter')">NGãƒ¯ãƒ¼ãƒ‰</div>
                    <div class="admin-tab" onclick="switchAdminTab('schedule')">æ™‚é–“å‰²</div>
                    <div class="admin-tab" onclick="switchAdminTab('server')">ã‚µãƒ¼ãƒãƒ¼åˆ‡æ›¿</div>
                    <!-- æ–°è¦è¿½åŠ  -->
                    <div class="admin-tab" onclick="switchAdminTab('status')">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³</div>
                    <div class="admin-tab" onclick="switchAdminTab('update')">ãŠçŸ¥ã‚‰ã›ç®¡ç†</div>
                </div>
                                    <!-- ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç®¡ç†ã‚¿ãƒ–ã®å†…å®¹ -->
<div id="tab-content-update" class="admin-tab-content">
    <div style="padding: 15px; border-bottom: 1px solid #ddd; background: #f9f9f9;">
        <h4>æ–°è¦ãŠçŸ¥ã‚‰ã›è¿½åŠ </h4>
        <input type="text" id="upd-input-date" class="admin-input" placeholder="æ—¥ä»˜ (ä¾‹: 2025.12.25)" style="width: 120px; margin-bottom: 5px;">
        <label style="margin-left:10px;"><input type="checkbox" id="upd-input-new"> NEWã‚¿ã‚°ã‚’ã¤ã‘ã‚‹</label>
        <br>
        <input type="text" id="upd-input-title" class="admin-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: å†¬ã®å¤§å‹ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ)" style="width: 100%; margin-bottom: 5px;">
        <textarea id="upd-input-body" class="admin-input" placeholder="å†…å®¹ (æ”¹è¡Œã¯åæ˜ ã•ã‚Œã¾ã™)" style="width: 100%; height: 80px;"></textarea>
        <div style="text-align: right; margin-top: 5px;">
            <button class="admin-btn" onclick="addUpdateItem()">è¿½åŠ ã™ã‚‹</button>
        </div>
    </div>
    <div id="admin-update-list-container" style="padding: 15px;">
        <!-- JSã§ãƒªã‚¹ãƒˆç”Ÿæˆ -->
    </div>
</div>
                <div id="tab-content-log" class="admin-tab-content active">
                    <div id="system-log-container"></div>
                </div>
                <div id="tab-content-chat" class="admin-tab-content">
                    <div id="admin-chat-list-container">
                        <div style="text-align:center; padding:10px; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
                <div id="tab-content-filter" class="admin-tab-content">
                    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; gap:10px;">
                        <input type="text" id="new-filter-word" placeholder="ä¸é©åˆ‡ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ " class="admin-input" style="flex:1;">
                        <button class="admin-btn" onclick="addFilterWord()">è¿½åŠ </button>
                    </div>
                    <div id="filter-word-list" style="padding:15px;"></div>
                    <div style="padding:10px; color:#888; font-size:0.8rem;">â€» ã“ã“ã«è¿½åŠ ã•ã‚ŒãŸè¨€è‘‰ã¯é€ä¿¡æ™‚ã«ã€Œ***ã€ã«ç½®æ›ã•ã‚Œã¾ã™ã€‚</div>
                </div>
                <div id="tab-content-schedule" class="admin-tab-content">
                    <div style="padding:15px; text-align:right;">
                        <button class="admin-btn" onclick="saveSchedule()">ä¿å­˜</button>
                    </div>
                    <div id="admin-schedule-container" style="padding:0 15px;">
                        <table class="schedule-table">
                            <thead>
                                <tr><th></th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th></tr>
                                <!-- è¿½åŠ : æ™‚ç¨‹ã¨çµ¦é£Ÿã®è¨­å®šè¡Œ -->
                                <tr id="adm-sch-row-type"><th>æ™‚ç¨‹</th><!-- JSã§ç”Ÿæˆ --></tr>
                                <tr id="adm-sch-row-lunch"><th>çµ¦é£Ÿ</th><!-- JSã§ç”Ÿæˆ --></tr>
                            </thead>
                            <tbody id="admin-schedule-body"></tbody>
                        </table>
                        <div style="text-align:left; margin-top:10px; font-weight:bold;">å‚™è€ƒè¨­å®š</div>
                        <textarea id="admin-schedule-memo" class="memo-area" placeholder="ç”Ÿå¾’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹å‚™è€ƒã‚’å…¥åŠ›"></textarea>
                    </div>
                </div>
                <div id="tab-content-server" class="admin-tab-content">
                    <div style="padding: 15px; border-bottom: 1px solid #ddd; background: #f0f8ff;">
                        <h4>ç¾åœ¨ã®æ¥ç¶šå…ˆ: <span id="current-server-label" style="font-weight:bold; color:#007aff;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span></h4>
                        <p style="font-size:0.8rem; color:#666;">â€»åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ãƒšãƒ¼ã‚¸ãŒå†èª­ã¿è¾¼ã¿ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div style="padding: 15px; border-bottom: 1px solid #ddd;">
                        <strong>æ–°è¦ã‚µãƒ¼ãƒãƒ¼è¿½åŠ </strong><br>
                        <input type="text" id="server-label-input" class="admin-input" placeholder="è¡¨ç¤ºå (ä¾‹: 2çµ„ç”¨ã‚µãƒ¼ãƒãƒ¼)" style="width: 100%; margin-top:5px; margin-bottom:5px;">
                        <textarea id="server-json-input" class="admin-input" placeholder='Firebaseã® const firebaseConfig = {...} ã®ä¸­èº«ã€ã¾ãŸã¯JSONã‚’è²¼ã‚Šä»˜ã‘' style="width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem;"></textarea>
                        <button class="admin-btn" onclick="addServerConfig()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                    </div>
                    <div id="server-list-container" style="padding: 15px;"></div>
                </div>
                <!-- æ–°è¦: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç®¡ç†ã‚¿ãƒ– -->
<!-- ç®¡ç†è€…ãƒ‘ãƒãƒ«ã®ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ã‚¿ãƒ–å†… (ä¿®æ­£å¾Œ) -->
<div id="tab-content-status" class="admin-tab-content">
    <div style="padding:15px; background:#f9f9f9; border-bottom:1px solid #ddd;">
        <h4>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹è¡¨ç¤ºè¨­å®š</h4>
        <div style="margin-bottom:10px;">
            <label><input type="checkbox" id="adm-maint-active"> ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹</label>
        </div>
        <input type="text" id="adm-maint-title" class="admin-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›)" style="width:100%; margin-bottom:5px;">
        <input type="text" id="adm-maint-msg" class="admin-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã¯...)" style="width:100%; margin-bottom:5px;">
        <input type="text" id="adm-maint-time" class="admin-input" placeholder="æ—¥æ™‚ (ä¾‹: 2026/1/5 22:00 ã€œ 23:00)" style="width:100%; margin-bottom:10px;">
        
        <!-- â˜…ã“ã“ã‹ã‚‰è¿½åŠ  -->
        <hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">
        <label style="font-weight:bold; font-size:0.9rem;">è©³ç´°ã‚¨ãƒªã‚¢ã®è¨­å®š:</label>
        <input type="text" id="adm-maint-target-title" class="admin-input" placeholder="è¦‹å‡ºã— (ä¾‹: å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹)" style="width:100%; margin-bottom:5px;">
        <textarea id="adm-maint-target-msg" class="admin-input" placeholder="è©³ç´°æ–‡ (ä¾‹: ä¸‹è¨˜æ™‚é–“ã®ã©ã“ã‹ã§...)" style="width:100%; height:60px; font-family:inherit;"></textarea>
        <!-- â˜…ã“ã“ã¾ã§ -->
    </div>
    
    <div style="padding:15px;" id="admin-status-list">
        <h4>å„ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨¼åƒçŠ¶æ³</h4>
        <!-- JSã§è‡ªå‹•ç”Ÿæˆ -->
    </div>
    <div style="padding:15px; text-align:right;">
        <button class="admin-btn" onclick="saveServiceStatusConfig()">è¨­å®šã‚’ä¿å­˜ã—ã¦åæ˜ </button>
    </div>
</div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <div id="view-list">
        <div class="list-sidebar">
            <div class="class-title">2å¹´6çµ„</div>
            <div class="subject-list">
                <div class="subject-item subject-active">è‹±èªA <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">éŸ³æ¥½ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å®¶åº­ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å­¦æ´» <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æŠ€è¡“ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å›½èª <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç¤¾ä¼š <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æ•°å­¦ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç·åˆ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ä½“è‚² <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">é“å¾³ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç†ç§‘ <span class="subject-menu-icon">...</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="bottom-item code-item"><img src="purasu.png" alt="+"> ã‚¯ãƒ©ã‚¹å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
                <div class="bottom-item"><img src="hei.png" alt="é–‰è¬›"> é–‰è¬›ã—ãŸæˆæ¥­</div>
                <div class="bottom-item"><img src="jisyu.png" alt="è‡ªä¸»"> è‡ªä¸»å­¦ç¿’</div>
                <div class="bottom-item"><img src="sin.png" alt="æ–°"> æ–°æ©Ÿèƒ½</div>
                <div class="bottom-item"><img src="roiro.png" alt="i"> ãƒ­ã‚¤ãƒ­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
            </div>
        </div>
        <div class="list-main">
            <div class="list-header-top">
                <div class="tab-container">
                    <div class="tab-btn tab-active"><img src="no.png" class="tab-icon">ãƒãƒ¼ãƒˆ</div>
                    <!-- â†“â†“ å¤‰æ›´ç‚¹: ã€Œå…±æœ‰ãƒãƒ¼ãƒˆã€ã«onclickã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  -->
                    <div class="tab-btn" onclick="openYoutube()"><img src="kyo.png" class="tab-icon">å…±æœ‰ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="tei.png" class="tab-icon">æå‡ºç®±</div>
                    <div class="tab-btn"><img src="tai.png" class="tab-icon">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
                </div>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="header-right-area" id="header-user-area">
                    <span class="user-icon-mini"></span> 
                    <span class="display-name-ref">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span>âˆ¨</span>
                </div>
            </div>
            <div class="list-toolbar-area">
                <div class="new-note-btn"><img src="purasu.png" class="plus-icon-img" alt="+">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œã‚‹</div>
                <div class="tool-icons-right">
                    <img src="sika.png" class="tool-icon" title="ã‚°ãƒªãƒƒãƒ‰">
                    <img src="yaji.png" class="tool-icon" title="ä¸¦ã³æ›¿ãˆ">
                    <img src="riro.png" class="tool-icon" title="æ›´æ–°">
                    <img src="ten.png" class="tool-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                </div>
            </div>
            <div class="notes-container">
                <div class="note-item" onclick="goToEditMode()">
                    <div class="note-thumb"></div>
                    <div class="note-info"><div class="note-title">2025å¹´12æœˆ4æ—¥ã®ãƒãƒ¼ãƒˆ</div><div class="note-date">2025å¹´12æœˆ4æ—¥(æœ¨) 10:18</div></div>
                    <div class="note-menu-dots">...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢2: ç·¨é›†ç”»é¢ -->
    <div id="view-edit">
        <div class="sidebar">
            <div class="sidebar-upper">
                <div class="back-nav" onclick="goToListMode()"><span>ï¼œ</span> æˆ»ã‚‹</div>
                <div class="icon-btn" id="btn-camera"><img src="kamera.png" alt="ã‚«ãƒ¡ãƒ©"></div>
                <div class="icon-btn" id="btn-text"><img src="text.png" alt="ãƒ†ã‚­ã‚¹ãƒˆ"></div>
                <div class="icon-btn" onclick="window.open('https://school.loilo.tv/jp/web.html', '_blank')"><img src="web.png" alt="Web"></div>
                <div class="icon-btn" onclick="document.getElementById('file-input').click()"><img src="file.png" alt="ãƒ•ã‚¡ã‚¤ãƒ«"></div>
                <div class="icon-btn" onclick="window.open('https://wq376.github.io/loilonote/1729/reiwa7.png', '_blank')"><img src="think.png" alt="ãƒ„ãƒ¼ãƒ«"></div>
                <div class="icon-btn" onclick="openSchedule()"><img src="test.png" alt="ãƒ†ã‚¹ãƒˆ"></div>
            </div>
            <div class="sidebar-lower">
                <div class="circle-wrapper" onclick="openMaterialBox()">
                    <div class="circle-icon"><img src="si.png" alt="è³‡æ–™ç®±"></div><div class="icon-label-white">è³‡æ–™ç®±</div>
                </div>
                <div class="circle-wrapper" id="toggle-chat-btn"><div class="circle-icon"><img src="te.png" alt="æå‡º"></div><div class="icon-label-white">æå‡º</div></div>
                <div class="circle-wrapper" onclick="window.location.href='https://loilonote.app/_/'">
                    <div class="circle-icon"><img src="o.png" alt="é€ã‚‹"></div><div class="icon-label-white">é€ã‚‹</div>
                </div>
            </div>
        </div>
        <div class="header-info-edit">
            <div class="user-name-area" id="user-name-display"><span id="current-name">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span style="font-size:0.8rem; margin-left:5px;">âˆ¨</span></div>
            <div class="class-info-edit">2å¹´6çµ„ / è‹±èªA<br><span id="current-date">--</span></div>
        </div>
        <div class="trash-area" id="trash-btn" title="ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚µãƒ¼ãƒãƒ¼å®¹é‡ã‚’ç©ºã‘ã‚‹"><img src="gomi.png" class="trash-img" alt="ã‚´ãƒŸç®±"><div class="saved-badge">ä¿å­˜æ¸ˆã¿</div></div>

        <!-- æå‡ºç®± -->
        <div id="chat-overlay">
            <div id="loading-indicator"></div>
            <div class="chat-header">æå‡ºç®±ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼‰<span class="close-btn" id="close-chat-x">Ã—</span></div>
            <div id="msg-list"></div>
            <div class="input-area">
                <div id="reply-status-bar" style="width:100%; display:none; justify-content:space-between; margin-bottom:5px;">
                    <span id="reply-target-text">è¿”ä¿¡å…ˆ...</span><span class="cancel-reply" onclick="cancelReply()">Ã—</span>
                </div>
                <div class="input-row">
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <button id="photo-btn" title="å†™çœŸã‚’è¿½åŠ " style="display:none;">ğŸ“·</button>
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." autocomplete="off">
                    <button id="send-btn">é€ä¿¡</button>
                </div>
            </div>
        </div>

        <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½ç¾¤ -->
        <div id="camera-overlay"><video id="webcam-video" autoplay playsinline></video><div id="camera-ui-layer"><div class="cam-controls"><div class="cam-shutter"></div></div><div class="cam-close" id="close-camera-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>
        <div id="color-picker-overlay"><div class="color-grid"><div class="color-opt c-pink" onclick="openEditor('#ffcdd2')"></div><div class="color-opt c-red" onclick="openEditor('#ef5350')"></div><div class="color-opt c-yellow" onclick="openEditor('#fff9c4')"></div><div class="color-opt c-orange" onclick="openEditor('#ffca28')"></div><div class="color-opt c-green-l" onclick="openEditor('#c8e6c9')"></div><div class="color-opt c-green-d" onclick="openEditor('#00897b')"></div><div class="color-opt c-blue-l" onclick="openEditor('#b3e5fc')"></div><div class="color-opt c-blue-d" onclick="openEditor('#1565c0')"></div><div class="color-opt c-white" onclick="openEditor('#fff')"></div><div class="color-opt c-black" onclick="openEditor('#222')"></div></div></div>
        <div id="card-editor-overlay">
            <div class="editor-toolbar"><div class="editor-back-btn" onclick="closeEditor()">â†</div><div class="editor-tools-center"><div class="et-icon">ğŸ‘†</div><div class="et-icon">ğŸ–Šï¸</div><div class="et-icon active">ã‚</div><div class="et-icon">ğŸ¤</div><div class="et-icon">â¹ï¸</div></div><div style="display:flex; gap:10px;"><div class="et-icon">...</div><button class="editor-send-btn" onclick="sendCardFromEditor()">é€ã‚‹</button></div></div>
            <div class="editor-main"><textarea id="card-textarea" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea></div>
        </div>

        <!-- æ™‚é–“å‰²ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="view-schedule" class="overlay-screen" onclick="closeSchedule()">
            <div class="schedule-box" onclick="event.stopPropagation()">
                <h3 style="margin-bottom:20px;">ä»Šé€±ã®æ™‚é–“å‰²</h3>
                <table class="schedule-table">
                    <!-- è¿½åŠ : ç”Ÿå¾’å´æ™‚é–“å‰²ã®ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <thead id="student-schedule-head">
                        <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                    </thead>
                    <tbody id="student-schedule-body">
                        <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                    </tbody>
                </table>
                <div style="text-align:left; margin-top:10px; font-weight:bold;">å‚™è€ƒ</div>
                <!-- ä¿®æ­£: è¡¨ç¤ºå°‚ç”¨ã«å¤‰æ›´ -->
                <div id="student-schedule-memo" class="memo-display-area"></div>
                <button class="close-schedule-btn" onclick="closeSchedule()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="user-menu-dropdown" class="user-menu-dropdown">
        <div class="menu-header-info">
            <div class="p-school">æ¨ªæµœå¸‚ç«‹å¸‚å ´ä¸­å­¦æ ¡</div>
            <div class="p-id" id="p-user-id">---</div>
            <div class="p-name" id="p-user-realname">---</div>
        </div>
        <div class="profile-menu-item" onclick="window.open('https://help.loilonote.app/', '_blank')">ã‚µãƒãƒ¼ãƒˆ</div>
        <div class="profile-menu-item">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã‚‹</div>
        <div class="profile-menu-item" onclick="openSettings()">ã‚¢ãƒ—ãƒªè¨­å®š</div>
        <div class="profile-menu-item" onclick="openUpdateInfo()">
    ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±
    <div class="sub-status" style="display:block; color:#007aff;">æ–°æ©Ÿèƒ½ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ</div>
</div>
        <!-- â˜…ä¿®æ­£: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç”»é¢ã‚’é–‹ã -->
        <div class="profile-menu-item" onclick="openServiceStatus()">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³<div class="sub-status" id="menu-sub-status"></div></div>
        <div class="profile-menu-item" id="menu-change-name" onclick="changeNameAction()">åå‰ã‚’å¤‰æ›´</div>
        <div class="profile-menu-item" onclick="goToAdminLoginFromMenu()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="profile-menu-item" onclick="performLogout()" style="color:#ff3b30;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </div>

<!-- ä¿®æ­£å¾Œ: ä¸­èº«ã‚’ç©ºã«ã—ã¦IDã‚’æŒ¯ã‚‹ -->
<div id="view-update-info" class="overlay-screen" onclick="closeUpdateInfo()">
    <div class="settings-modal" onclick="event.stopPropagation()">
        <div class="settings-header">
            <span class="settings-close-btn" onclick="closeUpdateInfo()">é–‰ã˜ã‚‹</span>
            <span style="width:40px;"></span>
        </div>
        <div class="settings-content" style="padding: 0 20px;">
            <!-- ã“ã“ã«IDã‚’è¿½åŠ ã—ã€ä¸­èº«ã¯JSã§ç”Ÿæˆã™ã‚‹ã®ã§ç©ºã«ã™ã‚‹ -->
            <div class="update-list" id="user-update-list">
                <div style="padding:20px; text-align:center; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>
</div>


<!-- è³‡æ–™ç®±ï¼ˆAIãƒªãƒ³ã‚¯é›†ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="view-material-box" class="overlay-screen" onclick="closeMaterialBox()">
    <div class="material-box-modal" onclick="event.stopPropagation()">
        <div class="material-header">
            <h3>è³‡æ–™ç®± (AIãƒ„ãƒ¼ãƒ«)</h3>
            <span class="close-material-btn" onclick="closeMaterialBox()">Ã—</span>
        </div>
<div class="material-btn" onclick="window.open('https://grok.com/', '_blank')">
    <span class="m-icon">
        <img src="grok.png" alt="Grok" class="box-icon-img">
    </span>
    <span class="m-label">Grok</span>
    <span class="m-desc">xAI</span>
</div>
            <div class="material-btn" onclick="window.open('https://ai.rakuten.co.jp/chat', '_blank')">
    <span class="m-icon">
        <img src="rakuten.jpg" alt="Rakuten AI" class="box-icon-img">
    </span>
                <span class="m-label">Rakuten AI</span>
                <span class="m-desc">æ¥½å¤©</span>
            </div>
            <div class="material-btn" onclick="window.open('https://felo.ai/ja/search', '_blank')">
    <span class="m-icon">
        <img src="felo.jpg" alt="Felo" class="box-icon-img">
    </span>
                <span class="m-label">Felo</span>
                <span class="m-desc">æ¤œç´¢AI</span>
            </div>
            <div class="material-btn" onclick="window.open('https://www.perplexity.ai/', '_blank')">
    <span class="m-icon">
        <img src="Perplexity.png" alt="Perplexity" class="box-icon-img">
    </span>
                <span class="m-label">Perplexity</span>
                <span class="m-desc">å¯¾è©±å‹æ¤œç´¢</span>
            </div>
        </div>
    </div>
</div>

    <!-- ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="view-settings">
        <div class="settings-modal">
            <div class="settings-header">
                <span class="settings-close-btn" onclick="closeSettings()">é–‰ã˜ã‚‹</span>
                <span class="settings-title">ã‚¢ãƒ—ãƒªè¨­å®š</span>
                <span style="width:40px;"></span>
            </div>
            <div class="settings-content">
                <div class="settings-section-title">æ‹¡å¤§ãƒ»ç¸®å°</div>
                <div class="settings-group">
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã®æ–¹å‘ã‚’åè»¢ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div>
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                    <div class="settings-row"><span>ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                </div>
                <div class="settings-section-title">è¨€èªè¨­å®š</div>
                <div class="settings-group"><div class="settings-row"><span>æ—¥æœ¬èª</span><span style="color:#007aff; cursor:pointer;">å¤‰æ›´ âˆ¨</span></div></div>
                <div class="settings-section-title">æ‰‹æ›¸ã</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒšãƒ³å„ªå…ˆãƒ¢ãƒ¼ãƒ‰</span><label class="toggle-switch"><input type="checkbox" checked><span class="slider"></span></label></div></div>
                <div class="settings-section-title">éŒ²éŸ³ãƒ»éŒ²ç”»</div>
                <div class="settings-group"><div class="settings-row"><span>é›‘éŸ³ã‚’ä½æ¸›ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="settings-section-title">ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’</span><span style="color:#ccc;">></span></div></div>
                <div class="settings-section-title">è©¦é¨“ä¸­ã®æ©Ÿèƒ½</div>
                <div class="settings-group"><div class="settings-row"><span>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="version-text">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v23.27</div>
                <div class="version-text">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div>
            </div>
        </div>
    </div>

    <!-- æ–°è¦: ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç”»é¢ -->
    <div id="view-service-status">
        <div class="status-header">
            <div class="status-title-large">
                <span id="overall-icon" class="s-ok">â—</span>
                <span id="overall-text">20:25 ç¾åœ¨ã€ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™</span>
            </div>
            <button class="status-close-btn" onclick="document.getElementById('view-service-status').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
        <div class="status-content">
            <div class="status-main-summary">
                ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: JST (GMT+09:00)
            </div>

            <!-- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŠçŸ¥ã‚‰ã›ã‚¨ãƒªã‚¢ -->
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç”»é¢ (ä¿®æ­£å¾Œ) -->
<div id="status-maintenance-area" class="maintenance-box">
    <div class="maint-title" id="disp-maint-title">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›</div>
    <div class="maint-sub" id="disp-maint-msg">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã¯å¤šå°‘å‰å¾Œã™ã‚‹ã“ã¨ãŒã”ã–ã„ã¾ã™</div>
    
    <div style="background:#fff; padding:15px; border:1px solid #eee; margin-top:10px;">
        <!-- â˜…ã“ã“ã«IDã‚’è¿½åŠ  -->
        <strong id="disp-maint-target-title">å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹</strong>
        
        <!-- â˜…ã“ã“ã«ã‚‚IDã‚’è¿½åŠ  -->
        <p id="disp-maint-target-msg">ä¸‹è¨˜æ™‚é–“ã®ã©ã“ã‹ã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚ </p>
        
        <div class="maint-time" id="disp-maint-time">2026/1/5 22:00 ã€œ 23:00</div>
    </div>
</div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆ -->
            <div id="service-status-list">
                <!-- JSã§ç”Ÿæˆ -->
            </div>
        </div>
    </div>

<!-- â†“â†“â†“ æ–°è¦è¿½åŠ : YouTubeãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”»é¢ (å…±æœ‰ãƒãƒ¼ãƒˆ) â†“â†“â†“ -->
    <div id="view-youtube" class="overlay-screen">
        <div class="settings-modal" style="width: 800px; height: auto; background: #222; color: #fff;">
            <div class="settings-header" style="background: #333; border-bottom: 1px solid #444; color: #fff;">
                <span class="settings-close-btn" onclick="closeYoutube()" style="color: #fff;">é–‰ã˜ã‚‹</span>
                <!-- ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã€Œå¤–éƒ¨æ•™æãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã€ã«å¤‰æ›´ -->
                <span class="settings-title">å…±æœ‰ãƒãƒ¼ãƒˆ (å¤–éƒ¨æ•™æãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼)</span>
                <span style="width:40px;"></span>
            </div>
            <div class="settings-content" style="text-align: center;">
                <!-- èª¬æ˜æ–‡ã‚‚ä¸€èˆ¬çš„ãªè¡¨ç¾ã«å¤‰æ›´ -->
                <p>æ•™æå‹•ç”»ã®å…±æœ‰ãƒªãƒ³ã‚¯ã€ã¾ãŸã¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                
                <!-- placeholderã®URLä¾‹ã‹ã‚‰ã‚‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’éš ã™ -->
                <input type="text" id="yt-url-input" placeholder="å‹•ç”»ãƒªãƒ³ã‚¯ã‚’å…¥åŠ›..." style="width: 70%; padding: 10px; border-radius: 5px; border: none; margin-bottom: 20px;">
                <button onclick="playYoutubeVideo()" style="padding: 10px 20px; border-radius: 5px; border: none; background-color: #007aff; color: white; cursor: pointer; font-weight: bold;">å†ç”Ÿ</button>

                <div style="position: relative; padding-bottom: 56.25%; height: 0; margin-top: 20px; background: #000;">
                    <iframe id="yt-player-frame" 
                        src="" 
                        title="Material video player"
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        referrerpolicy="strict-origin-when-cross-origin"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, getDocs, deleteDoc, setDoc, limit, getDoc, deleteField } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const DEFAULT_CONFIG = {
          apiKey: "AIzaSyC9UgkUd62D79QfweQA1i0akH04kxwItD4",
          authDomain: "newchat-90c71.firebaseapp.com",
          projectId: "newchat-90c71",
          storageBucket: "newchat-90c71.firebasestorage.app",
          messagingSenderId: "633675964296",
          appId: "1:633675964296:web:89ea68a0c7de516a29a43d",
          measurementId: "G-7SM0B9KDXE"
        };

        let firebaseConfig = DEFAULT_CONFIG;
        let currentConfigLabel = "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (åˆæœŸè¨­å®š)";

        try {
            const savedActive = localStorage.getItem('loilo_active_server_config');
            if (savedActive) {
                const parsed = JSON.parse(savedActive);
                firebaseConfig = parsed.config;
                currentConfigLabel = parsed.label;
            }
        } catch(e) { console.error("è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const INITIAL_USERS = {
            "1726": { name: "ç”°ä¸­å¤§æ¨¹", isAllowed: true, isAdmin: true, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "6351": { name: "è¥¿å°¾é’è‘‰", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "7253": { name: "è¥¿æ‘æ‚ ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "8712": { name: "é´«åŸå®—æ¬¡éƒ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "8827": { name: "å¯Œæ°¸æ‚ æœˆ", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "sample12": { name: "ã‚µãƒ³ãƒ—ãƒ«1", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "sample25": { name: "ã‚µãƒ³ãƒ—ãƒ«2", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "sample726": { name: "ã‚µãƒ³ãƒ—ãƒ«3", isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true },
            "admin": { name: "ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ", isAllowed: true, isAdmin: true, canChangeName: false, showNickname: false, canUnsend: true, needReload: false, canChat: true, canImage: true }
        };
        const SUPER_ADMIN_ID = "1726";
        const SUPER_ADMIN_PASS = "1726";
        const ADMIN_PASS = "admin";

        let currentStream = null;
        let selectedColor = '#ffcdd2';
        let myName = localStorage.getItem('loilo_v2_name') || "ã“ã“ã«åå‰ã‚’å…¥åŠ›";
        let realName = "";
        let currentLoginId = ""; 
        let replyTargetId = null;
        let myPermissions = { isAllowed: true, isAdmin: false, canChangeName: true, canUnsend: true, canChat: true, canImage: true }; 
        let currentAdminSessionType = 'none'; 
        let areIdsVisible = false; 
        let ngWords = []; 

        const viewPortal = document.getElementById("view-portal");
        const viewUserLogin = document.getElementById("view-user-login");
        const viewAdminLogin = document.getElementById("view-admin-login");
        const viewAdminPanel = document.getElementById("view-admin-panel");
        const viewList = document.getElementById("view-list");
        const viewEdit = document.getElementById("view-edit");
        const viewSettings = document.getElementById("view-settings");

        const headerUserArea = document.getElementById("header-user-area");
        const editUserArea = document.getElementById("user-name-display");
        const userMenu = document.getElementById("user-menu-dropdown");
        const pUserId = document.getElementById("p-user-id");
        const pUserRealName = document.getElementById("p-user-realname");
        const menuChangeName = document.getElementById("menu-change-name");
        const adminAddArea = document.getElementById("admin-add-area");
        
        const photoBtn = document.getElementById("photo-btn");
        const fileInput = document.getElementById("file-input");
        const btnCamera = document.getElementById("btn-camera");
        const btnFile = document.querySelector(".icon-btn[onclick*='file-input']");
        const chatInput = document.getElementById("chat-input");
// --- â–¼ ã“ã“ã‚’æ›¸ãæ›ãˆ â–¼ ---
        
        // PHPã‚µãƒ¼ãƒãƒ¼ã®URL (ã‚ãªãŸã®ã‚·ãƒ³ãƒ•ãƒªãƒ¼ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’å…¥ã‚Œã¦ãã ã•ã„)
        // ä¾‹: "https://cf890473.cloudfree.jp/api.php"
        const PHP_API_URL = "https://cf890473.cloudfree.jp/api.php"; 

        document.getElementById("send-btn").onclick = async () => {
            const txt = document.getElementById("chat-input").value;
            const file = document.getElementById("file-input").files[0];
            if(!txt && !file) return;

            let imgUrl = null;
            
            // ç”»åƒãŒã‚ã‚‹å ´åˆ
            if(file) {
                // 1. ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã§Base64ã«ã™ã‚‹
                const base64 = await new Promise(r => {
                    const fr = new FileReader(); 
                    fr.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            // ã‚µã‚¤ã‚ºèª¿æ•´ (PHPã«é€ã‚‹ãŸã‚å°‘ã—å¤§ãã‚ã§ã‚‚OKã ãŒ1200pxãã‚‰ã„ã«åˆ¶é™)
                            const max = 1200;
                            let w = img.width, h = img.height;
                            if(w>h && w>max){ h*=max/w; w=max; } else if(h>max){ w*=max/h; h=max; }
                            cvs.width=w; cvs.height=h;
                            cvs.getContext('2d').drawImage(img,0,0,w,h);
                            r(cvs.toDataURL('image/jpeg', 0.8));
                        };
                        img.src = e.target.result;
                    };
                    fr.readAsDataURL(file);
                });

                // 2. ã‚·ãƒ³ãƒ•ãƒªãƒ¼ã‚µãƒ¼ãƒãƒ¼(PHP)ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                try {
                    const res = await fetch(PHP_API_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            cmd: "upload_image",
                            payload: { image: base64 }
                        })
                    });
                    const json = await res.json();
                    
                    if(json.status === "ok") {
                        imgUrl = json.url; // PHPã‹ã‚‰è¿”ã£ã¦ããŸç”»åƒã®URL
                    } else {
                        alert("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
                        return;
                    }
                } catch(e) {
                    console.error(e);
                    alert("ç”»åƒã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
                    return;
                }
                
                document.getElementById("file-input").value="";
            }

            // NGãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
            let safeTxt = txt;
            ngWords.forEach(w => { if(safeTxt.includes(w)) safeTxt = safeTxt.replace(new RegExp(w,'g'), "***"); });

            // 3. Firestoreã«ä¿å­˜ (ç”»åƒã¯URLã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹)
            await addDoc(collection(db, "fake_loilo_v2"), {
                text: safeTxt, 
                imageUrl: imgUrl, // ã“ã“ã« http://.../uploads/xxx.jpg ãŒå…¥ã‚‹
                name: (myName||"") + "ãƒ»" + (currentUserData?.name||"ä¸æ˜"),
                uid: myUid, 
                replyTo: replyTargetId, 
                createdAt: serverTimestamp(), 
                readBy: []
            });
            
            chatInput.value = ""; 
            window.cancelReply();
        };
        // --- â–² æ›¸ãæ›ãˆã“ã“ã¾ã§ â–² ---
        const replyStatusBar = document.getElementById("reply-status-bar");
        const replyTargetText = document.getElementById("reply-target-text");

        async function initDB() {
            try {
                const docRef = doc(db, "config", "users");
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    await setDoc(docRef, INITIAL_USERS);
                    console.log("åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ");
                }
                const filterRef = doc(db, "config", "filters");
                const filterSnap = await getDoc(filterRef);
                if (!filterSnap.exists()) {
                    await setDoc(filterRef, { words: ["æ­»ã­", "æ®ºã™", "ãƒã‚«", "ã‚¢ãƒ›", "ã†ã–ã„"] });
                    console.log("åˆæœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ");
                }
            } catch(e) { console.error("DBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼", e); }
        }
        initDB();

        onSnapshot(doc(db, "config", "filters"), (docSnap) => {
            if (docSnap.exists()) {
                ngWords = docSnap.data().words || [];
                renderFilterList(); 
            }
        });

        window.goToUserLogin = function() { viewPortal.style.display = "none"; viewUserLogin.style.display = "flex"; document.getElementById("user-pass-input").focus(); };
        window.goToAdminLogin = function() { viewPortal.style.display = "none"; viewAdminLogin.style.display = "flex"; document.getElementById("admin-pass-input").focus(); };
        
        window.backToPortal = function() { 
            viewUserLogin.style.display = "none"; 
            viewAdminLogin.style.display = "none"; 
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {} else { viewList.style.display = "flex"; }
            } else {
                viewPortal.style.display = "flex"; 
            }
            document.getElementById("user-pass-input").value = "";
            document.getElementById("admin-pass-input").value = "";
            document.getElementById("user-login-error").textContent = "";
            document.getElementById("admin-login-error").textContent = "";
        };
        
        window.backFromAdmin = function() {
            viewAdminLogin.style.display = "none";
            document.getElementById("admin-login-error").textContent = "";
            document.getElementById("admin-pass-input").value = "";
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {} else { viewList.style.display = "flex"; }
            } else {
                viewPortal.style.display = "flex";
            }
        };
        
        window.goToEditMode = function() { document.getElementById('view-list').style.display = 'none'; document.getElementById('view-edit').style.display = 'block'; };
        window.goToListMode = function() { document.getElementById('view-edit').style.display = 'none'; document.getElementById('view-list').style.display = 'flex'; toggleChat(false); closeCamera(); closeColorPicker(); closeEditor(); };

        document.getElementById("user-login-btn").addEventListener("click", performUserLogin);
        document.getElementById("user-pass-input").addEventListener("keypress", (e) => { if(e.key === "Enter") performUserLogin(); });

        async function performUserLogin() {
            const val = document.getElementById("user-pass-input").value;
            const docRef = doc(db, "config", "users");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const allUsers = docSnap.data();
                const user = allUsers[val];
                if (user) {
                    if(user.isAllowed === false) {
                        document.getElementById("user-login-error").textContent = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™";
                        return;
                    }
                    localStorage.setItem('loilo_saved_session_id', val);
                    currentUserData = user;
                    currentLoginId = val;
                    startUserListener(val);
                    logSystemEvent("ãƒ­ã‚°ã‚¤ãƒ³", "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ", val);
                    viewUserLogin.style.display = "none";
                    viewList.style.display = "flex";
                    updateNameDisplay();
                    return;
                }
            }
            document.getElementById("user-login-error").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            document.getElementById("user-pass-input").value = "";
        }

        let currentUserData = null; 
        function startUserListener(loginId) {
            onSnapshot(doc(db, "config", "users"), (docSnap) => {
                if (docSnap.exists()) {
                    const allUsers = docSnap.data();
                    const me = allUsers[loginId];
                    if (!me) return; 
                    currentUserData = me; 
                    if (me.canChat === undefined) me.canChat = true;
                    if (me.canImage === undefined) me.canImage = true;
                    myPermissions = me; 
                    if (me.isAllowed === false) {
                        alert("ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚\nå†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
                        localStorage.removeItem('loilo_saved_session_id');
                        location.reload(); 
                    }
                    if (me.canChangeName === false) {
                        menuChangeName.style.display = "none";
                    } else {
                        menuChangeName.style.display = "block";
                    }
                    if (me.canChat === false) {
                        chatInput.disabled = true; chatInput.placeholder = "é€ä¿¡ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™"; sendBtn.disabled = true; sendBtn.style.opacity = 0.5;
                    } else {
                        chatInput.disabled = false; chatInput.placeholder = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..."; sendBtn.disabled = false; sendBtn.style.opacity = 1;
                    }
                    if (me.canImage === false) {
                        photoBtn.style.display = "none"; if(btnCamera) btnCamera.style.display = "none"; if(btnFile) btnFile.style.display = "none";
                    } else {
                        if(btnCamera) btnCamera.style.display = "flex"; if(btnFile) btnFile.style.display = "flex";
                    }
                    if (me.alertMessage) {
                        alert("ã€ç®¡ç†è€…ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ã€‘\n" + me.alertMessage);
                        updateDoc(doc(db, "config", "users"), { [loginId + ".alertMessage"]: deleteField() });
                    }
                    if (currentAdminSessionType === 'user' && !me.isAdmin) {
                        alert("ç®¡ç†è€…æ¨©é™ãŒè§£é™¤ã•ã‚ŒãŸãŸã‚ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚");
                        closeAdminPanel();
                    }
                    if (me.needReload === true) {
                        alert("ç®¡ç†è€…ã«ã‚ˆã‚Šæ›´æ–°ãŒè¦æ±‚ã•ã‚Œã¾ã—ãŸã€‚");
                        setDoc(doc(db, "config", "users"), { [loginId]: { needReload: false } }, { merge: true }).then(() => { location.reload(); });
                    }
                    updateNameDisplay();
                }
            });
            updateDeviceInfo(loginId, navigator.userAgent);
        }
        
        async function updateDeviceInfo(id, ua) {
            try { await setDoc(doc(db, "config", "users"), { [id]: { lastDevice: ua } }, { merge: true }); } catch(e) {}
        }

        async function logSystemEvent(type, msg, user) {
            try {
                let dispName = user;
                if(currentUserData && currentUserData.name) dispName = currentUserData.name;
                await addDoc(collection(db, "system_logs"), { type: type, message: msg, user: dispName + `(${user})`, timestamp: serverTimestamp() });
            } catch(e) {}
        }

        const currentNameSpan = document.getElementById("current-name");
        const nameRefs = document.querySelectorAll(".display-name-ref");
        const dateSpan = document.getElementById("current-date");
        const now = new Date();
        dateSpan.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ã®ãƒãƒ¼ãƒˆ`;

        function updateNameDisplay() {
            if(!currentUserData) return;
            let displayName = currentUserData.name;
            if (currentUserData.showNickname && myName) { displayName = `${myName}ãƒ»${currentUserData.name}`; }
            currentNameSpan.textContent = displayName;
            nameRefs.forEach(el => el.textContent = displayName);
            pUserId.textContent = currentLoginId; 
            pUserRealName.textContent = currentUserData.name;
        }

        headerUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        editUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        function toggleUserMenu() { const isVisible = userMenu.style.display === 'block'; userMenu.style.display = isVisible ? 'none' : 'block'; }
        document.addEventListener('click', () => { userMenu.style.display = 'none'; });
        userMenu.addEventListener('click', (e) => { e.stopPropagation(); });

        window.changeNameAction = function() {
            userMenu.style.display = 'none';
            if (myPermissions.canChangeName === false) { alert("åå‰ã®å¤‰æ›´ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
            const newName = prompt("è¡¨ç¤ºåã‚’å¤‰æ›´:", myName);
            if(newName && newName.trim() !== ""){ myName = newName; localStorage.setItem('loilo_v2_name', myName); updateNameDisplay(); }
        };
        
        window.performLogout = function() { localStorage.removeItem('loilo_saved_session_id'); location.reload(); };
        window.openSettings = function() { userMenu.style.display = 'none'; viewSettings.style.display = "flex"; };
        window.closeSettings = function() { viewSettings.style.display = "none"; };
        window.goToAdminLoginFromMenu = function() { userMenu.style.display = 'none'; viewList.style.display = 'none'; viewEdit.style.display = 'none'; viewAdminLogin.style.display = 'flex'; }
        window.openSchedule = function() { document.getElementById('view-schedule').style.display = 'flex'; renderStudentSchedule(); }
        window.closeSchedule = function() { document.getElementById('view-schedule').style.display = 'none'; }
        
        // â˜…â˜…â˜… å‰Šé™¤ã•ã‚Œã¦ã„ãŸé–¢æ•°ã®å¾©å…ƒ â˜…â˜…â˜…
        window.openTestLinks = function() {
            window.open('https://wq376.github.io/loilonote/1729/kouki.png', '_blank');
            window.open('https://wq376.github.io/loilonote/1729/reiwa7.png', '_blank');
        };

        // --- è¿½åŠ : æ™‚é–“å‰²é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        async function renderStudentSchedule() {
            const thead = document.getElementById("student-schedule-head");
            const tbody = document.getElementById("student-schedule-body");
            tbody.innerHTML = "<tr><td colspan='6'>èª­ã¿è¾¼ã¿ä¸­...</td></tr>";
            
            try {
                const docRef = doc(db, "config", "schedule");
                const snap = await getDoc(docRef);
                let scheduleData = [];
                let dayInfo = [{},{},{},{},{}];
                let memo = "";

                if (snap.exists()) {
                    if (snap.data().data) scheduleData = snap.data().data;
                    if (snap.data().dayInfo) dayInfo = snap.data().dayInfo;
                    if (snap.data().memo) memo = snap.data().memo;
                } else {
                    scheduleData = [ "å›½èª", "æ•°å­¦", "ç†ç§‘", "è‹±èª", "ç¤¾ä¼š", "æ•°å­¦", "è‹±èª", "å›½èª", "ç¤¾ä¼š", "ç†ç§‘", "ä½“è‚²", "éŸ³æ¥½", "ç¾è¡“", "æŠ€è¡“", "å®¶åº­", "è‹±èª", "ç†ç§‘", "ç¤¾ä¼š", "å›½èª", "æ•°å­¦", "ç¤¾ä¼š", "å›½èª", "æ•°å­¦", "ç†ç§‘", "è‹±èª", "ç·åˆ", "å­¦æ´»", "é“å¾³", "é¸æŠ", "HR" ];
                }

                // å‚™è€ƒã‚’è¡¨ç¤º
                document.getElementById('student-schedule-memo').textContent = memo;

                // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ (æ›œæ—¥ã€æ™‚ç¨‹)
                let headHtml = `<tr><th></th><th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th></tr>`;
                
                // æ™‚ç¨‹è¡Œ
                headHtml += `<tr><th>æ™‚ç¨‹</th>`;
                for(let j=0; j<5; j++) {
                    const type = dayInfo[j].type || "none";
                    let label = "";
                    if(type === 'A') label = "Aæ™‚ç¨‹";
                    else if(type === 'B') label = "Bæ™‚ç¨‹";
                    else label = "-"; // ãªã—
                    headHtml += `<td>${label}</td>`;
                }
                headHtml += `</tr>`;
                thead.innerHTML = headHtml;

                // æœ¬ä½“ç”Ÿæˆ
                let bodyHtml = "";
                // 1-4é™
                for(let i=0; i<4; i++) { 
                    bodyHtml += `<tr><td>${i+1}</td>`; 
                    for(let j=0; j<5; j++) { bodyHtml += `<td>${escapeHtml(scheduleData[i * 5 + j]||"")}</td>`; } 
                    bodyHtml += "</tr>"; 
                }
                
                // â˜…çµ¦é£Ÿè¡Œã®æŒ¿å…¥ (4é™ã¨æ˜¼ä¼‘ã¿ã®é–“)
                bodyHtml += `<tr><th>çµ¦é£Ÿ</th>`;
                for(let j=0; j<5; j++) {
                    const hasLunch = dayInfo[j].lunch !== false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
                    bodyHtml += `<td>${hasLunch ? "â—‹" : "Ã—"}</td>`;
                }
                bodyHtml += `</tr>`;

                // æ˜¼ä¼‘ã¿
                bodyHtml += `<tr><td colspan="6" style="background:#fafafa; color:#888;">æ˜¼ä¼‘ã¿</td></tr>`;
                
                // 5-6é™
                for(let i=4; i<6; i++) { 
                    bodyHtml += `<tr><td>${i+1}</td>`; 
                    for(let j=0; j<5; j++) { bodyHtml += `<td>${escapeHtml(scheduleData[i * 5 + j]||"")}</td>`; } 
                    bodyHtml += "</tr>"; 
                }
                tbody.innerHTML = bodyHtml;

            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='6'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</td></tr>"; }
        }

        async function loadAdminSchedule() {
            const tbody = document.getElementById("admin-schedule-body");
            tbody.innerHTML = "<tr><td colspan='6'>èª­ã¿è¾¼ã¿ä¸­...</td></tr>";
            try {
                const docRef = doc(db, "config", "schedule");
                const snap = await getDoc(docRef);
                let scheduleData = [];
                let dayInfo = [{},{},{},{},{}];
                let memo = "";

                if (snap.exists()) {
                    if (snap.data().data) scheduleData = snap.data().data;
                    if (snap.data().dayInfo) dayInfo = snap.data().dayInfo;
                    if (snap.data().memo) memo = snap.data().memo;
                } else {
                    scheduleData = [ "å›½èª", "æ•°å­¦", "ç†ç§‘", "è‹±èª", "ç¤¾ä¼š", "æ•°å­¦", "è‹±èª", "å›½èª", "ç¤¾ä¼š", "ç†ç§‘", "ä½“è‚²", "éŸ³æ¥½", "ç¾è¡“", "æŠ€è¡“", "å®¶åº­", "è‹±èª", "ç†ç§‘", "ç¤¾ä¼š", "å›½èª", "æ•°å­¦", "ç¤¾ä¼š", "å›½èª", "æ•°å­¦", "ç†ç§‘", "è‹±èª", "ç·åˆ", "å­¦æ´»", "é“å¾³", "é¸æŠ", "HR" ];
                }

                // å‚™è€ƒå…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
                document.getElementById('admin-schedule-memo').value = memo;

                // ç®¡ç†ç”»é¢ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã¸ã®æ³¨å…¥
                const typeRow = document.getElementById('adm-sch-row-type');
                const lunchRow = document.getElementById('adm-sch-row-lunch');
                
                let typeHtml = "<th>æ™‚ç¨‹</th>";
                let lunchHtml = "<th>çµ¦é£Ÿ</th>";

                for(let j=0; j<5; j++) {
                    const info = dayInfo[j] || {};
                    // æ™‚ç¨‹ã‚»ãƒ¬ã‚¯ãƒˆ
                    typeHtml += `<td>
                        <select class="sch-type-select" data-col="${j}">
                            <option value="none" ${info.type==='none'?'selected':''}>ãªã—</option>
                            <option value="A" ${info.type==='A'?'selected':''}>Aæ™‚ç¨‹</option>
                            <option value="B" ${info.type==='B'?'selected':''}>Bæ™‚ç¨‹</option>
                        </select>
                    </td>`;
                    
                    // çµ¦é£Ÿã‚»ãƒ¬ã‚¯ãƒˆ
                    lunchHtml += `<td>
                        <select class="sch-lunch-select" data-col="${j}">
                            <option value="true" ${info.lunch!==false?'selected':''}>ã‚ã‚Š</option>
                            <option value="false" ${info.lunch===false?'selected':''}>ãªã—</option>
                        </select>
                    </td>`;
                }
                typeRow.innerHTML = typeHtml;
                lunchRow.innerHTML = lunchHtml;

                let html = "";
                for(let i=0; i<6; i++) { html += `<tr><td>${i+1}</td>`; for(let j=0; j<5; j++) { const val = scheduleData[i * 5 + j] || ""; html += `<td><input type="text" class="admin-schedule-input" value="${escapeHtml(val)}" data-row="${i}" data-col="${j}"></td>`; } html += "</tr>"; }
                tbody.innerHTML = html;
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='6'>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</td></tr>"; }
        }

        window.saveSchedule = async function() {
            // æ™‚é–“å‰²ãƒ‡ãƒ¼ã‚¿åé›†
            const inputs = document.querySelectorAll('.admin-schedule-input');
            let flatData = new Array(30).fill("");
            inputs.forEach(input => { const r = parseInt(input.dataset.row); const c = parseInt(input.dataset.col); flatData[r * 5 + c] = input.value; });
            
            // æ™‚ç¨‹ãƒ»çµ¦é£Ÿãƒ‡ãƒ¼ã‚¿åé›†
            let dayInfo = [];
            for(let j=0; j<5; j++) {
                const typeVal = document.querySelector(`.sch-type-select[data-col="${j}"]`).value;
                const lunchVal = document.querySelector(`.sch-lunch-select[data-col="${j}"]`).value === "true";
                dayInfo.push({ type: typeVal, lunch: lunchVal });
            }
            
            // å‚™è€ƒãƒ‡ãƒ¼ã‚¿åé›†
            const memo = document.getElementById('admin-schedule-memo').value;

            try { 
                await setDoc(doc(db, "config", "schedule"), { data: flatData, dayInfo: dayInfo, memo: memo }, { merge: true }); 
                alert("æ™‚é–“å‰²ã‚’ä¿å­˜ã—ã¾ã—ãŸ"); 
                logSystemEvent("è¨­å®šå¤‰æ›´", "æ™‚é–“å‰²ã‚’æ›´æ–°", currentLoginId || "admin"); 
            } catch(e) { alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };

        document.getElementById("admin-login-btn").addEventListener("click", performAdminLogin);
        async function performAdminLogin() {
            const inputId = document.getElementById("admin-pass-input").value;
            if (inputId === SUPER_ADMIN_PASS || inputId === ADMIN_PASS) {
                currentAdminSessionType = 'super';
                viewAdminLogin.style.display = "none"; viewAdminPanel.style.display = "flex"; 
                adminAddArea.style.display = "flex"; areIdsVisible = false; 
                renderAdminList(); renderSystemLogs(); renderAdminChatList(); renderFilterList(); loadAdminSchedule();
                logSystemEvent("ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹", "ç‰¹æ¨©ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³", "SUPER_ADMIN");
                return;
            }
            try {
                const docRef = doc(db, "config", "users");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const allUsers = docSnap.data();
                    const user = allUsers[inputId];
                    if (user) {
                        if (user.isAdmin === true) {
                            currentAdminSessionType = 'user';
                            viewAdminLogin.style.display = "none"; viewAdminPanel.style.display = "flex"; 
                            adminAddArea.style.display = "none"; areIdsVisible = false;
                            renderAdminList(); renderSystemLogs(); renderAdminChatList(); renderFilterList(); loadAdminSchedule();
                            logSystemEvent("ç®¡ç†ã‚¢ã‚¯ã‚»ã‚¹", "ç®¡ç†è€…æ¨©é™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³", inputId);
                        } else {
                            document.getElementById("admin-login-error").innerText = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é€šå¸¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚\nç®¡ç†è€…æ¨©é™ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                            logSystemEvent("è­¦å‘Š", "æ¨©é™ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ", inputId);
                        }
                        return;
                    }
                }
            } catch(e) { console.error(e); }
            document.getElementById("admin-login-error").innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
        }
        
        window.closeAdminPanel = function() { 
            viewAdminPanel.style.display = "none"; 
            document.getElementById("admin-pass-input").value = "";
            currentAdminSessionType = 'none';
            if(currentLoginId) { viewList.style.display = "flex"; } else { viewPortal.style.display = "flex"; }
        };

        window.switchAdminTab = function(tabName) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
            
            if(tabName === 'log') {
                document.querySelector('.admin-tab:nth-child(1)').classList.add('active');
                document.getElementById('tab-content-log').classList.add('active');
            } else if(tabName === 'chat') {
                document.querySelector('.admin-tab:nth-child(2)').classList.add('active');
                document.getElementById('tab-content-chat').classList.add('active');
            } else if(tabName === 'filter') {
                document.querySelector('.admin-tab:nth-child(3)').classList.add('active');
                document.getElementById('tab-content-filter').classList.add('active');
            } else if(tabName === 'schedule') {
                document.querySelector('.admin-tab:nth-child(4)').classList.add('active');
                document.getElementById('tab-content-schedule').classList.add('active');
            } else if(tabName === 'server') {
                document.querySelector('.admin-tab:nth-child(5)').classList.add('active');
                document.getElementById('tab-content-server').classList.add('active');
                renderServerList();
            } 
            // æ—¢å­˜ã®é–¢æ•°å†…ã«è¿½åŠ 
        // ... ä»–ã®else ifã®å¾Œ ...
        else if(tabName === 'update') {
            // HTMLã«è¿½åŠ ã—ãŸé †ç•ªã«åˆã‚ã›ã¦nth-childã®ç•ªå·ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
            // ä¾‹: ãƒ­ã‚°, ãƒãƒ£ãƒƒãƒˆ, NG, æ™‚é–“å‰², ã‚µãƒ¼ãƒãƒ¼, çŠ¶æ³, ãŠçŸ¥ã‚‰ã›(ã“ã‚Œ) => 7ç•ªç›®
            document.querySelectorAll('.admin-tab')[6].classList.add('active'); 
            document.getElementById('tab-content-update').classList.add('active');
            renderAdminUpdates();
            
            // æ—¥ä»˜å…¥åŠ›æ¬„ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
            const today = new Date();
            const y = today.getFullYear();
            const m = ('0' + (today.getMonth()+1)).slice(-2);
            const d = ('0' + today.getDate()).slice(-2);
            document.getElementById('upd-input-date').value = `${y}.${m}.${d}`;
        }else if(tabName === 'status') {
                document.querySelector('.admin-tab:nth-child(6)').classList.add('active');
                document.getElementById('tab-content-status').classList.add('active');
                loadAdminStatusSettings();
            }
        };

        window.addNewUser = async function() {
            if (currentAdminSessionType !== 'super') { alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            const newId = document.getElementById("new-user-id").value.trim();
            const newName = document.getElementById("new-user-name").value.trim();
            if(!newId || !newName) { alert("IDã¨åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            try {
                const newUser = { name: newName, isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, needReload: false, canChat: true, canImage: true, lastDevice: "" };
                await setDoc(doc(db, "config", "users"), { [newId]: newUser }, { merge: true });
                document.getElementById("new-user-id").value = ""; document.getElementById("new-user-name").value = "";
                logSystemEvent("è¨­å®šå¤‰æ›´", `æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ : ${newName} (${newId})`, currentLoginId || "admin");
            } catch(e) { alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: "+e.message); }
        };

        window.deleteUser = async function(id) {
            if (currentAdminSessionType !== 'super') { alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            if (id === SUPER_ADMIN_ID) { alert("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
            if(!confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${id} ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try { await updateDoc(doc(db, "config", "users"), { [id]: deleteField() }); logSystemEvent("è¨­å®šå¤‰æ›´", `ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤: ${id}`, currentLoginId || "admin"); } catch(e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: "+e.message); }
        };
        
        window.editUserName = async function(id, currentName) {
            if (id === SUPER_ADMIN_ID && currentAdminSessionType !== 'super') { alert("å¤‰æ›´ã§ãã¾ã›ã‚“"); return; }
            const newName = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›:", currentName);
            if(newName && newName !== currentName) { await setDoc(doc(db, "config", "users"), { [id]: { name: newName } }, { merge: true }); }
        };
        
        window.forceReloadUser = async function(id) {
            if (currentAdminSessionType !== 'super') { alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
            if(!confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¼·åˆ¶çš„ã«å†èª­ã¿è¾¼ã¿ã•ã›ã¾ã™ã‹ï¼Ÿ")) return;
            try { await setDoc(doc(db, "config", "users"), { [id]: { needReload: true } }, { merge: true }); alert("å†èª­ã¿è¾¼ã¿ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚"); } catch(e) { alert("é€ä¿¡å¤±æ•—: "+e.message); }
        };

        window.sendUserAlert = async function(id) {
            const msg = prompt("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›:");
            if(!msg) return;
            try { await setDoc(doc(db, "config", "users"), { [id]: { alertMessage: msg } }, { merge: true }); alert("é€ä¿¡ã—ã¾ã—ãŸ"); logSystemEvent("é€šçŸ¥", `é€šçŸ¥é€ä¿¡: ${id} -> ${msg}`, currentLoginId || "admin"); } catch(e) { alert("é€ä¿¡å¤±æ•—: " + e.message); }
        }
        
        window.addFilterWord = async function() {
            const input = document.getElementById('new-filter-word');
            const val = input.value.trim();
            if(!val) return;
            if(ngWords.includes(val)) { alert('æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™'); return; }
            try { await updateDoc(doc(db, "config", "filters"), { words: arrayUnion(val) }); input.value = ""; logSystemEvent("è¨­å®šå¤‰æ›´", `NGãƒ¯ãƒ¼ãƒ‰è¿½åŠ : ${val}`, currentLoginId || "admin"); } catch(e) { alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };
        
        window.deleteFilterWord = async function(word) {
            if(!confirm(`ã€Œ${word}ã€ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try { await updateDoc(doc(db, "config", "filters"), { words: arrayRemove(word) }); logSystemEvent("è¨­å®šå¤‰æ›´", `NGãƒ¯ãƒ¼ãƒ‰å‰Šé™¤: ${word}`, currentLoginId || "admin"); } catch(e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };
        
        function renderFilterList() {
            const listDiv = document.getElementById('filter-word-list');
            if(!listDiv) return;
            listDiv.innerHTML = "";
            ngWords.forEach(word => {
                const el = document.createElement("div"); el.className = "filter-item";
                el.innerHTML = `<span>${escapeHtml(word)}</span> <span class="del-btn" onclick="deleteFilterWord('${escapeHtml(word)}')">Ã—</span>`;
                listDiv.appendChild(el);
            });
        }

        window.toggleIdVisibility = function() {
            if(areIdsVisible) { areIdsVisible = false; renderAdminList(); return; }
            const pass = prompt("IDè¡¨ç¤ºç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:");
            if (pass === "2012") { areIdsVisible = true; renderAdminList(); } else { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); }
        };

        async function renderAdminList() {
            const listDiv = document.getElementById("admin-user-list"); 
            listDiv.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            onSnapshot(doc(db, "config", "users"), (docSnap) => {
                listDiv.innerHTML = "";
                const allUsers = docSnap.exists() ? docSnap.data() : {};
                const sortedIds = Object.keys(allUsers).sort();
                for (let id of sortedIds) {
                    const u = allUsers[id];
                    if (typeof u === 'boolean') { continue; }
                    const perm = { isAllowed: true, isAdmin: false, canChangeName: true, showNickname: true, canUnsend: true, canChat: true, canImage: true, ...u };
                    const isTargetProtected = (id === SUPER_ADMIN_ID || id === "admin");
                    const canEditProtected = (currentAdminSessionType === 'super');
                    const disabledAttr = (isTargetProtected && !canEditProtected) ? "disabled" : "";
                    const opacityStyle = (isTargetProtected && !canEditProtected) ? "opacity:0.5; cursor:not-allowed;" : "";
                    const clickAction = (isTargetProtected && !canEditProtected) ? `onclick="alert('å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚'); return false;"` : "";
                    const displayId = areIdsVisible ? id : "****";
                    let actionBtns = "";
                    actionBtns += `<span class="alert-icon" onclick="sendUserAlert('${id}')" title="é€šçŸ¥ã‚’é€ã‚‹">ğŸ””</span> `;
                    if (currentAdminSessionType === 'super') {
                         actionBtns += `<span class="refresh-icon" onclick="forceReloadUser('${id}')" title="å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰">ğŸ”„</span> `;
                         if(!isTargetProtected) { actionBtns += `<span class="delete-icon" onclick="deleteUser('${id}')" title="å‰Šé™¤">ğŸ—‘ï¸</span>`; }
                    }
                    const row = document.createElement("div"); row.className = "user-control-row";
                    row.innerHTML = `
                        <div class="user-info-row"><div class="user-info-admin">${escapeHtml(perm.name)} (${displayId}) <span class="edit-icon" onclick="editUserName('${id}', '${escapeHtml(perm.name)}')">âœï¸</span>${actionBtns}<br><span class="device-info">ç«¯æœ«: ${perm.lastDevice || "ä¸æ˜"}</span></div></div>
                        <div class="user-settings-row">
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">ãƒ­ã‚°ã‚¤ãƒ³</span><label class="toggle-switch"><input type="checkbox" ${perm.isAllowed ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'isAllowed', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">ç®¡ç†è€…</span><label class="toggle-switch"><input type="checkbox" ${perm.isAdmin ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'isAdmin', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">ãƒãƒ£ãƒƒãƒˆ</span><label class="toggle-switch"><input type="checkbox" ${perm.canChat ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'canChat', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">ç”»åƒ</span><label class="toggle-switch"><input type="checkbox" ${perm.canImage ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'canImage', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">åå‰å¤‰æ›´</span><label class="toggle-switch"><input type="checkbox" ${perm.canChangeName ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'canChangeName', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </span><label class="toggle-switch"><input type="checkbox" ${perm.showNickname ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'showNickname', this)"><span class="slider"></span></label></div>
                            <div class="setting-block" style="${opacityStyle}" ${clickAction}><span class="status-label">é€ä¿¡å–æ¶ˆ</span><label class="toggle-switch"><input type="checkbox" ${perm.canUnsend ? "checked" : ""} ${disabledAttr} onchange="togglePerm('${id}', 'canUnsend', this)"><span class="slider"></span></label></div>
                        </div>
                    `;
                    listDiv.appendChild(row);
                }
            });
        }

        window.togglePerm = async function(id, type, checkbox) {
            const val = checkbox.checked;
            if ((id === SUPER_ADMIN_ID || id === "admin") && currentAdminSessionType !== 'super') { checkbox.checked = !val; return; }
            try { await setDoc(doc(db, "config", "users"), { [id]: { [type]: val } }, { merge: true }); logSystemEvent("è¨­å®šå¤‰æ›´", `${id} ã® ${type} ã‚’ ${val} ã«å¤‰æ›´`, currentLoginId || "admin"); } catch(e) { alert("ä¿å­˜å¤±æ•—: " + e.message); checkbox.checked = !val; }
        };

        function renderSystemLogs() {
            const logDiv = document.getElementById("system-log-container");
            logDiv.innerHTML = "ãƒ­ã‚°èª­ã¿è¾¼ã¿ä¸­...";
            const q = query(collection(db, "system_logs"), orderBy("timestamp", "desc"), limit(50));
            onSnapshot(q, (snap) => {
                logDiv.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : "---";
                    let typeClass = "log-info";
                    if(data.type === "ãƒ­ã‚°ã‚¤ãƒ³") typeClass = "log-login"; if(data.type === "è­¦å‘Š") typeClass = "log-warn";
                    if(data.type === "å‰Šé™¤") typeClass = "log-del"; if(data.type === "è¨­å®šå¤‰æ›´") typeClass = "log-change";
                    if(data.type === "é€šçŸ¥") typeClass = "log-alert";
                    const el = document.createElement("div"); el.className = "log-entry";
                    el.innerHTML = `<span class="log-time">[${date}]</span> <span class="log-type ${typeClass}">${escapeHtml(data.type)}</span> <span class="log-user">${escapeHtml(data.user)}</span> : ${escapeHtml(data.message)}`;
                    logDiv.appendChild(el);
                });
            });
        }

        function renderAdminChatList() {
            const chatDiv = document.getElementById("admin-chat-list-container");
            const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                chatDiv.innerHTML = "";
                if (snap.empty) { chatDiv.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>å±¥æ­´ãªã—</div>"; return; }
                snap.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleString() : "---";
                    const content = data.text || (data.imageUrl ? "[ç”»åƒ]" : "[ä¸æ˜]");
                    const el = document.createElement("div"); el.className = "admin-chat-item";
                    el.innerHTML = `<div style="flex:1;"><div class="ac-info">${date} - ${escapeHtml(data.name)}</div><div class="ac-content">${escapeHtml(content)}</div></div><button class="ac-delete-btn" onclick="deleteChatMessage('${doc.id}')">å‰Šé™¤</button>`;
                    chatDiv.appendChild(el);
                });
            });
        }
        window.deleteChatMessage = async function(docId) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try { await deleteDoc(doc(db, "fake_loilo_v2", docId)); } catch(e) { alert("å‰Šé™¤å¤±æ•—: " + e.message); }
        };

        const chatOverlay = document.getElementById("chat-overlay");
        const msgList = document.getElementById("msg-list");
        const myUid = localStorage.getItem('loilo_v2_uid') || Math.random().toString(36).substring(7); localStorage.setItem('loilo_v2_uid', myUid);

        document.getElementById("toggle-chat-btn").addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        document.getElementById("close-chat-x").addEventListener("click", () => toggleChat(false));

        function toggleChat(force) {
            let show = (chatOverlay.style.display === "flex");
            if (force !== undefined) show = !force;
            chatOverlay.style.display = show ? "none" : "flex";
            if (!show) window.cancelReply();
            else msgList.scrollTop = msgList.scrollHeight;
        }

        window.cancelReply = function() { replyTargetId = null; replyStatusBar.style.display = "none"; }

        async function sendPayload(text="", file=null) {
            if(!text && !file) return;
            if (myPermissions.canChat === false && text) { alert("ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"); return; }
            if (myPermissions.canImage === false && file) { alert("ç”»åƒé€ä¿¡ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"); return; }
            let safeText = text;
            if(safeText) { ngWords.forEach(badWord => { if(badWord && safeText.includes(badWord)) { safeText = safeText.split(badWord).join("*".repeat(badWord.length)); } }); }
            let imageUrl = null;
            if(file) {
                imageUrl = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const scale = 800 / Math.max(img.width, img.height, 800);
                            canvas.width = img.width * scale; canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.5));
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(file);
                });
            }
            let senderName = currentUserData ? currentUserData.name : "Unknown";
            if (currentUserData && currentUserData.showNickname && myName) { senderName = `${myName}ãƒ»${currentUserData.name}`; }
            const payload = { text: safeText, imageUrl, name: senderName, uid: myUid, createdAt: serverTimestamp(), readBy: [] };
            if(replyTargetId) payload.replyTo = replyTargetId;
            await addDoc(collection(db, "fake_loilo_v2"), payload);
            chatInput.value = ""; window.cancelReply();
        }
        sendBtn.addEventListener("click", ()=>sendPayload(chatInput.value));
        chatInput.addEventListener("keypress", (e)=>{if(e.key==="Enter")sendPayload(chatInput.value)});
        document.getElementById("file-input").addEventListener("change", (e)=>sendPayload("", e.target.files[0]));

        const qMsg = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
        onSnapshot(qMsg, (snap) => {
            msgList.innerHTML = ""; const idMap = {}; const userMap = {}; 
            snap.forEach(d => { const data = d.data(); idMap[d.id] = data.text || "ç”»åƒ"; if(data.uid && data.name) { const parts = data.name.split('ãƒ»'); userMap[data.uid] = parts.length > 1 ? parts[1] : data.name; } });
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const docId = docSnap.id;
                if (data.uid !== myUid && (!data.readBy || !data.readBy.includes(myUid))) { updateDoc(doc(db, "fake_loilo_v2", docId), { readBy: arrayUnion(myUid) }); }
                const wrapper = document.createElement("div"); wrapper.className = "msg-wrapper " + (data.uid===myUid?"wrapper-mine":"wrapper-other");
                const card = document.createElement("div"); card.className = "msg-card " + (data.uid===myUid?"msg-mine":"msg-other");
                card.id = "msg-"+docId;
                card.addEventListener("dblclick", (e)=>{ e.stopPropagation(); replyTargetId=docId; replyTargetText.textContent="è¿”ä¿¡å…ˆ: "+(data.text||"ç”»åƒ"); replyStatusBar.style.display="flex"; chatInput.focus(); });
                let html = "";
                if(data.replyTo && idMap[data.replyTo]) html += `<div class="reply-ref" onclick="document.getElementById('msg-${data.replyTo}').scrollIntoView({behavior:'smooth'});">â†© ${escapeHtml(idMap[data.replyTo])}</div>`;
                if(data.imageUrl) html += `<img src="${data.imageUrl}" onclick="window.open(this.src)">`;
                if(data.text) html += `<div>${escapeHtml(data.text)}</div>`;
if (data.uid === myUid && data.createdAt) {
                    const diff = (new Date() - data.createdAt.toDate()) / 1000 / 60;
                    if (diff <= 5 && myPermissions.canUnsend) { html += `<button class="msg-unsend-btn" onclick="unsendMessage('${docId}')">Ã—</button>`; }
                }
                
                // --- â†“â†“â†“ è¿½åŠ : æ—¥æ™‚è¡¨ç¤ºå‡¦ç† â†“â†“â†“ ---
                let dateStr = "";
                if (data.createdAt) {
                    const d = data.createdAt.toDate();
                    // ä¾‹: 2026/1/23 15:45
                    dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                }
                // --- â†‘â†‘â†‘ è¿½åŠ ã“ã“ã¾ã§ â†‘â†‘â†‘ ---

                // msg-nameã®ä¸­ã« dateStr ã‚’è¡¨ç¤ºã™ã‚‹ span ã‚’è¿½åŠ 
                card.innerHTML = `<div class="msg-name">${escapeHtml(data.name)} <span style="font-size:0.75rem; color:#888; font-weight:normal; margin-left:8px;">${dateStr}</span></div><div class="msg-content">${html}</div>`;
                wrapper.appendChild(card);
                if(data.uid === myUid && data.readBy && data.readBy.length > 0) {
                    const read = document.createElement("div"); read.className = "read-label"; const count = data.readBy.length; read.textContent = "æ—¢èª­ " + count;
                    const readerNames = data.readBy.map(uid => userMap[uid] || "ä¸æ˜").join("ã€"); read.title = "æ—¢èª­: " + readerNames; wrapper.appendChild(read);
                }
                msgList.appendChild(wrapper);
            });
            msgList.scrollTop = msgList.scrollHeight;
        });

        window.unsendMessage = async function(docId) {
            if(!confirm("é€ä¿¡ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            try { await deleteDoc(doc(db, "fake_loilo_v2", docId)); } catch(e) { alert("å¤±æ•—: " + e.message); }
        };

        btnCamera.addEventListener("click", async () => {
            const cameraOverlay = document.getElementById("camera-overlay");
            const videoEl = document.getElementById("webcam-video");
            cameraOverlay.style.display = "flex";
            try { currentStream = await navigator.mediaDevices.getUserMedia({ video: true }); videoEl.srcObject = currentStream; } catch (err) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + err.message); cameraOverlay.style.display = "none"; }
        });
        window.closeCamera = function() { const cameraOverlay = document.getElementById("camera-overlay"); cameraOverlay.style.display = "none"; if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; } };
        document.getElementById("close-camera-btn").addEventListener("click", closeCamera);

        document.getElementById("btn-text").addEventListener("click", (e) => { e.stopPropagation(); document.getElementById("color-picker-overlay").style.display = "block"; });
        window.openEditor = function(c) { selectedColor=c; document.getElementById("color-picker-overlay").style.display="none"; document.getElementById("card-editor-overlay").style.background=c; document.getElementById("card-editor-overlay").style.display="flex"; document.getElementById("card-textarea").value=""; document.getElementById("card-textarea").focus(); };
        window.closeEditor = function() { document.getElementById("card-editor-overlay").style.display="none"; };
        window.sendCardFromEditor = function() { if(document.getElementById("card-textarea").value.trim()){ closeEditor(); toggleChat(true); sendPayload(document.getElementById("card-textarea").value); } };
        document.body.addEventListener("click", (e) => { if(!document.getElementById("color-picker-overlay").contains(e.target)&&!document.getElementById("btn-text").contains(e.target)) document.getElementById("color-picker-overlay").style.display="none"; });

        const trashBtn = document.getElementById("trash-btn");
        trashBtn.addEventListener("dblclick", async () => {
            if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try { const q = query(collection(db, "fake_loilo_v2")); const querySnapshot = await getDocs(q); const deletePromises = []; querySnapshot.forEach((document) => { deletePromises.push(deleteDoc(document.ref)); }); await Promise.all(deletePromises); alert("å‰Šé™¤ã—ã¾ã—ãŸ"); logSystemEvent("å‰Šé™¤", "å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤(ã‚´ãƒŸç®±)", currentLoginId); } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        });

        document.getElementById("admin-delete-all-btn").addEventListener("click", async () => {
            if (!confirm("ã€è­¦å‘Šã€‘\nã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¨ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
            if (!confirm("å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
            try { const q = query(collection(db, "fake_loilo_v2")); const querySnapshot = await getDocs(q); const deletePromises = []; querySnapshot.forEach((document) => { deletePromises.push(deleteDoc(document.ref)); }); await Promise.all(deletePromises); alert("å±¥æ­´ã‚’å…¨æ¶ˆå»ã—ã¾ã—ãŸã€‚"); logSystemEvent("å‰Šé™¤", "å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤(ç®¡ç†è€…)", currentLoginId); } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message); }
        });
        
        window.downloadChatCSV = async function() {
            try {
                const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
                const snap = await getDocs(q);
                let csvContent = "æ—¥æ™‚,åå‰,ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸,ç”»åƒURL\n";
                snap.forEach(doc => { const d = doc.data(); const date = d.createdAt ? d.createdAt.toDate().toLocaleString() : ""; const name = `"${(d.name || "").replace(/"/g, '""')}"`; const text = `"${(d.text || "").replace(/"/g, '""')}"`; const img = d.imageUrl ? "ã‚ã‚Š" : ""; csvContent += `${date},${name},${text},${img}\n`; });
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); const blob = new Blob([bom, csvContent], { type: "text/csv" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `chat_log_${new Date().getTime()}.csv`; a.click(); URL.revokeObjectURL(url);
            } catch(e) { alert("CSVä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };

        window.renderServerList = function() {
            const listContainer = document.getElementById('server-list-container');
            document.getElementById('current-server-label').textContent = currentConfigLabel;
            let serverList = [];
            try { serverList = JSON.parse(localStorage.getItem('loilo_server_list') || "[]"); } catch(e){}
            let html = `
                <div class="admin-chat-item" style="background:#e6f2ff; border:2px solid #007aff;">
                    <div style="flex:1;">
                        <div class="ac-info">åˆæœŸè¨­å®š</div>
                        <div class="ac-content">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (åˆæœŸè¨­å®š)</div>
                        <div style="font-size:0.7rem; color:#666; margin-top:2px;">${DEFAULT_CONFIG.projectId}</div>
                    </div>
                    <button class="admin-btn" onclick="activateServer(null)">ã“ã‚Œã«åˆ‡æ›¿</button>
                </div>
            `;
            serverList.forEach((srv, index) => {
                html += `<div class="admin-chat-item"><div style="flex:1;"><div class="ac-info">è¿½åŠ ã‚µãƒ¼ãƒãƒ¼ ${index + 1}</div><div class="ac-content">${escapeHtml(srv.label)}</div><div style="font-size:0.7rem; color:#666; margin-top:2px;">${escapeHtml(srv.config.projectId || "IDä¸æ˜")}</div></div><div style="display:flex; flex-direction:column; gap:5px;"><button class="admin-btn" onclick="activateServer(${index})">åˆ‡æ›¿</button><button class="admin-btn del" style="font-size:0.7rem; padding:2px 8px;" onclick="deleteServer(${index})">å‰Šé™¤</button></div></div>`;
            });
            listContainer.innerHTML = html;
        };

        window.addServerConfig = function() {
            const label = document.getElementById('server-label-input').value.trim();
            let jsonStr = document.getElementById('server-json-input').value.trim();
            if(!label || !jsonStr) { alert("è¡¨ç¤ºåã¨è¨­å®šã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            const start = jsonStr.indexOf('{'); const end = jsonStr.lastIndexOf('}');
            if(start !== -1 && end !== -1) { jsonStr = jsonStr.substring(start, end + 1); }
            try {
                let configObj; try { configObj = JSON.parse(jsonStr); } catch(e) { configObj = new Function("return " + jsonStr)(); }
                if(!configObj.apiKey || !configObj.projectId) { alert("æœ‰åŠ¹ãªFirebaseè¨­å®šã§ã¯ã‚ã‚Šã¾ã›ã‚“ (apiKeyãªã©ãŒä¸è¶³)"); return; }
                let serverList = JSON.parse(localStorage.getItem('loilo_server_list') || "[]");
                serverList.push({ label: label, config: configObj });
                localStorage.setItem('loilo_server_list', JSON.stringify(serverList));
                document.getElementById('server-label-input').value = ""; document.getElementById('server-json-input').value = "";
                renderServerList(); alert("ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ");
            } catch(e) { alert("è¨­å®šã‚³ãƒ¼ãƒ‰ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + e.message); }
        };

        window.deleteServer = function(index) {
            if(!confirm("ã“ã®è¨­å®šã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            let serverList = JSON.parse(localStorage.getItem('loilo_server_list') || "[]");
            serverList.splice(index, 1);
            localStorage.setItem('loilo_server_list', JSON.stringify(serverList));
            renderServerList();
        };

        window.activateServer = function(index) {
            if(index === null) {
                if(!confirm("åˆæœŸã‚µãƒ¼ãƒãƒ¼ã«æˆ»ã—ã¾ã™ã€‚ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
                localStorage.removeItem('loilo_active_server_config'); localStorage.removeItem('loilo_saved_session_id'); location.reload();
            } else {
                let serverList = JSON.parse(localStorage.getItem('loilo_server_list') || "[]");
                const target = serverList[index];
                if(!target) return;
                if(!confirm(`ã€Œ${target.label}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\nãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚`)) return;
                localStorage.setItem('loilo_active_server_config', JSON.stringify(target)); localStorage.removeItem('loilo_saved_session_id'); location.reload();
            }
        };
        
        // --- â˜…ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç®¡ç†æ©Ÿèƒ½ (è¿½åŠ ) ---
        const DEFAULT_STATUS_CONFIG = {
            showMaintenance: false,
            maintTitle: "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›",
            maintMsg: "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã¯å¤šå°‘å‰å¾Œã™ã‚‹ã“ã¨ãŒã”ã–ã„ã¾ã™",
            maintTime: "æœªå®š",
            services: {
                api: { label: "APIã‚µãƒ¼ãƒãƒ¼", status: "ok" },
                web: { label: "Webç‰ˆ", status: "ok" },
                admin: { label: "ç®¡ç†ç”»é¢", status: "ok" },
                chat: { label: "ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½", status: "ok" },
                contact1: { label: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼1", status: "ok" },
                contact2: { label: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼2", status: "ok" },
                contact3: { label: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼3", status: "ok" },
                image: { label: "ç”»åƒç”¨ã‚µãƒ¼ãƒãƒ¼", status: "ok" },
                srv1937: { label: "1937ã‚µãƒ¼ãƒãƒ¼", status: "ok" }
            }
        };

        async function initStatusDB() {
            try {
                const docRef = doc(db, "config", "service_status");
                const snap = await getDoc(docRef);
                if (!snap.exists()) { await setDoc(docRef, DEFAULT_STATUS_CONFIG); }
            } catch(e) { console.error(e); }
        }
        initStatusDB();

        window.openServiceStatus = function() {
            document.getElementById('user-menu-dropdown').style.display = 'none';
            document.getElementById('view-service-status').style.display = 'flex';
        };

        onSnapshot(doc(db, "config", "service_status"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                renderServiceStatusPage(data);
                const subStatusEl = document.getElementById("menu-sub-status");
                if (data.showMaintenance) { subStatusEl.textContent = "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šãŒã‚ã‚Šã¾ã™"; subStatusEl.style.display = "block"; } else { subStatusEl.style.display = "none"; }
            }
        });

        function renderServiceStatusPage(data) {
            let allOk = true; let hasWarn = false;
            Object.values(data.services).forEach(s => { if(s.status === 'error') allOk = false; if(s.status === 'warn') hasWarn = true; });

            const overallIcon = document.getElementById('overall-icon');
            const overallText = document.getElementById('overall-text');
            const nowTime = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});

            if (allOk && !hasWarn) { overallIcon.className = "status-icon-large s-ok"; overallIcon.textContent = "âœ”"; overallText.textContent = `${nowTime} ç¾åœ¨ã€ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™`; } 
            else if (!allOk) { overallIcon.className = "status-icon-large s-error"; overallIcon.textContent = "âœ–"; overallText.textContent = `${nowTime} ç¾åœ¨ã€ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã§éšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™`; } 
            else { overallIcon.className = "status-icon-large s-warn"; overallIcon.textContent = "â–²"; overallText.textContent = `${nowTime} ç¾åœ¨ã€ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸å®‰å®šã§ã™`; }

            const maintArea = document.getElementById('status-maintenance-area');
            if (data.showMaintenance) {
                maintArea.style.display = "block";
                document.getElementById('disp-maint-title').textContent = data.maintTitle;
                document.getElementById('disp-maint-msg').textContent = data.maintMsg;
                document.getElementById('disp-maint-time').textContent = data.maintTime;
                
                // â˜…è¿½åŠ : è©³ç´°ã‚¨ãƒªã‚¢ã®åæ˜ ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œã™ã‚‹ãŸã‚ || ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šï¼‰
                document.getElementById('disp-maint-target-title').textContent = data.maintTargetTitle || "å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹";
                document.getElementById('disp-maint-target-msg').textContent = data.maintTargetMsg || "ä¸‹è¨˜æ™‚é–“ã®ã©ã“ã‹ã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚";
            } else { maintArea.style.display = "none"; }

            const listDiv = document.getElementById('service-status-list');
            listDiv.innerHTML = "";
            const order = ['api', 'web', 'admin', 'chat', 'contact1', 'contact2', 'contact3', 'image', 'srv1937'];
            
            order.forEach(key => {
                const item = data.services[key];
                if(!item) return;
                let iconChar = "âœ”"; let iconClass = "sc-ok"; let statusText = "æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™";
                if (item.status === 'warn') { iconChar = "!"; iconClass = "sc-warn"; statusText = "é…å»¶ãƒ»ä¸å®‰å®šãªçŠ¶æ…‹ã§ã™"; } 
                else if (item.status === 'error') { iconChar = "Ã—"; iconClass = "sc-error"; statusText = "åœæ­¢ã—ã¦ã„ã¾ã™"; }
                const el = document.createElement('div'); el.className = "status-item-card";
                el.innerHTML = `<div class="status-check-icon ${iconClass}">${iconChar}</div><div class="status-text-area"><div class="status-label">${escapeHtml(item.label)}</div><div class="status-desc">${statusText}</div></div>`;
                listDiv.appendChild(el);
            });
        }

        async function loadAdminStatusSettings() {
            const docRef = doc(db, "config", "service_status");
            const snap = await getDoc(docRef);
            let data = DEFAULT_STATUS_CONFIG;
            if (snap.exists()) data = snap.data();

            document.getElementById('adm-maint-active').checked = data.showMaintenance;
            document.getElementById('adm-maint-title').value = data.maintTitle;
            document.getElementById('adm-maint-msg').value = data.maintMsg;
            document.getElementById('adm-maint-time').value = data.maintTime;
            
            // â˜…è¿½åŠ : æ–°ã—ã„å…¥åŠ›æ¬„ã¸ã®ã‚»ãƒƒãƒˆ
            document.getElementById('adm-maint-target-title').value = data.maintTargetTitle || "å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹";
            document.getElementById('adm-maint-target-msg').value = data.maintTargetMsg || "ä¸‹è¨˜æ™‚é–“ã®ã©ã“ã‹ã§ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ããªã„ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚";

            const listDiv = document.getElementById('admin-status-list');
            listDiv.innerHTML = "<h4>å„ã‚µãƒ¼ãƒ“ã‚¹ã®ç¨¼åƒçŠ¶æ³</h4>";
            const order = ['api', 'web', 'admin', 'chat', 'contact1', 'contact2', 'contact3', 'image', 'srv1937'];
            
            order.forEach(key => {
                const item = data.services[key] || { label: key, status: 'ok' };
                const div = document.createElement('div');
                div.className = 'admin-status-row';
                div.innerHTML = `<span style="font-weight:bold;">${item.label}</span><select class="admin-status-select" id="status-select-${key}"><option value="ok" ${item.status==='ok'?'selected':''}>æ­£å¸¸ (ç·‘)</option><option value="warn" ${item.status==='warn'?'selected':''}>ä¸å®‰å®š (é»„)</option><option value="error" ${item.status==='error'?'selected':''}>åœæ­¢ (èµ¤)</option></select>`;
                listDiv.appendChild(div);
            });
        }

        window.saveServiceStatusConfig = async function() {
            const showMaintenance = document.getElementById('adm-maint-active').checked;
            const maintTitle = document.getElementById('adm-maint-title').value;
            const maintMsg = document.getElementById('adm-maint-msg').value;
            const maintTime = document.getElementById('adm-maint-time').value;
            
            // â˜…è¿½åŠ : æ–°ã—ã„é …ç›®ã®å–å¾—
            const maintTargetTitle = document.getElementById('adm-maint-target-title').value;
            const maintTargetMsg = document.getElementById('adm-maint-target-msg').value;

            const services = {};
            const order = ['api', 'web', 'admin', 'chat', 'contact1', 'contact2', 'contact3', 'image', 'srv1937'];
            const labels = {
                api: "APIã‚µãƒ¼ãƒãƒ¼", web: "Webç‰ˆ", admin: "ç®¡ç†ç”»é¢",
                chat: "ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½", contact1: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼1", contact2: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼2", 
                contact3: "é€£çµ¡ç”¨ã‚µãƒ¼ãƒãƒ¼3", image: "ç”»åƒç”¨ã‚µãƒ¼ãƒãƒ¼", srv1937: "1937ã‚µãƒ¼ãƒãƒ¼"
            };
            order.forEach(key => { const val = document.getElementById(`status-select-${key}`).value; services[key] = { label: labels[key], status: val }; });
            
            // â˜…è¿½åŠ : ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã‚‹
            const newData = { showMaintenance, maintTitle, maintMsg, maintTime, maintTargetTitle, maintTargetMsg, services };
            
            try { await setDoc(doc(db, "config", "service_status"), newData); alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); } catch(e) { alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼: " + e.message); }
        };

        async function checkAutoLogin() {
            const savedId = localStorage.getItem('loilo_saved_session_id');
            if(!savedId) return;
            const docRef = doc(db, "config", "users");
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                 const allUsers = docSnap.data();
                 const user = allUsers[savedId];
                 if(user && user.isAllowed !== false){
                     console.log("ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å¸°: " + savedId);
                     currentUserData = user;
                     currentLoginId = savedId;
                     startUserListener(savedId);
                     viewPortal.style.display = "none";
                     viewList.style.display = "flex";
                     updateNameDisplay();
                     logSystemEvent("å†æ¥ç¶š", "è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ", savedId);
                 } else { localStorage.removeItem('loilo_saved_session_id'); }
            }
        }
        checkAutoLogin();

        function escapeHtml(str) { if(!str)return""; return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

        // â†“â†“â†“ æ–°è¦è¿½åŠ : YouTubeãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â†“â†“â†“
        window.openYoutube = function() {
            document.getElementById('view-youtube').style.display = 'flex';
        };
        window.closeYoutube = function() {
            document.getElementById('view-youtube').style.display = 'none';
            // é–‰ã˜ãŸã¨ãã«å‹•ç”»ã‚’åœæ­¢ã™ã‚‹ãŸã‚ã«srcã‚’ç©ºã«ã™ã‚‹
            document.getElementById('yt-player-frame').src = "";
        };
window.playYoutubeVideo = function() {
            const input = document.getElementById('yt-url-input').value;
            let videoId = "";
            
            // ãƒ•ã‚£ãƒ«ã‚¿å¯¾ç­–: "youtube" ã¨ã„ã†æ–‡å­—åˆ—ã‚’ç›´æ¥æ›¸ã‹ãšã«åˆ†å‰²ã—ã¦çµåˆã™ã‚‹
            // "y" + "ou" + "tu" + "be"
            const keyParts = ["y", "ou", "tu", "be"];
            const keyword = keyParts.join(""); // "youtube"
            const shortKey = keyParts[0] + keyParts[1] + keyParts[2] + ".be/"; // "youtu.be/"

            if (input.includes("v=")) {
                videoId = input.split('v=')[1];
                const ampersandPosition = videoId.indexOf('&');
                if (ampersandPosition != -1) { videoId = videoId.substring(0, ampersandPosition); }
            } else if (input.includes(shortKey)) {
                videoId = input.split(shortKey)[1];
            } else {
                // IDç›´å…¥åŠ›ã€ã¾ãŸã¯ä»–ã®å½¢å¼ã¨ã¿ãªã™
                videoId = input;
            }

            if (videoId && videoId.length > 5) { // IDã®é•·ã•ãƒã‚§ãƒƒã‚¯ã§èª¤ä½œå‹•é˜²æ­¢
                // ãƒ‰ãƒ¡ã‚¤ãƒ³ç”Ÿæˆ: "https://www.youtube-nocookie.com/embed/" ã‚’åˆ†å‰²ç”Ÿæˆ
                const p1 = "https://www.";
                const p2 = "-nocookie.com/embed/";
                const targetSrc = p1 + keyword + p2 + videoId;
                
                document.getElementById('yt-player-frame').src = targetSrc;
            } else {
                alert("æœ‰åŠ¹ãªãƒªãƒ³ã‚¯ã¾ãŸã¯IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            }
        };
    </script>
</body>
</html>

