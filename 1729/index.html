<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" href="loilo.ico" type="image/x-icon">
    <!-- UDãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    
    <title>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆ ã‚¹ã‚¯ãƒ¼ãƒ« (AIãƒ¢ãƒ¼ãƒ‰æ­è¼‰)</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "BIZ UDGothic", sans-serif; overflow: hidden; height: 100vh; user-select: none; color: #333; }
        
        /* =========================================
           ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ç”»é¢
           ========================================= */
        #view-list { display: flex; width: 100%; height: 100%; background-color: #fff; }

        .list-sidebar { width: 260px; background-color: #f5f5f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding-top: 20px; }
        .class-title { padding: 0 20px 15px 20px; font-weight: bold; color: #555; font-size: 1rem; }
        .subject-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .subject-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 1rem; border-radius: 8px; transition: background 0.1s; }
        .subject-item:hover { background-color: rgba(0,0,0,0.05); }
        .subject-active { background-color: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .subject-menu-icon { color: #aaa; font-size: 1.2rem; font-weight: bold; }
        .sidebar-bottom { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f5f5f7; }
        .bottom-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; cursor: pointer; font-size: 0.95rem; color: #444; font-weight: bold; }
        .bottom-item img { width: 24px; height: 24px; object-fit: contain; }
        .code-item { color: #0099ff; } 
        .list-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .list-header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; }
        .tab-container { display: flex; gap: 10px; margin: 0 auto; transform: translateX(50px); }
        .tab-btn { display: flex; align-items: center; gap: 6px; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: #666; }
        .tab-active { background-color: #e6f2ff; color: #007aff; }
        .tab-icon { width: 20px; height: 20px; object-fit: contain; }
        .header-right-area { display: flex; align-items: center; gap: 15px; color: #007aff; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .list-toolbar-area { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; }
        .new-note-btn { display: flex; align-items: center; gap: 8px; color: #0099ff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .plus-icon-img { width: 28px; height: 28px; }
        .tool-icons-right { display: flex; gap: 15px; align-items: center; }
        .tool-icon { width: 28px; height: 28px; cursor: pointer; opacity: 0.7; }
        .tool-icon:hover { opacity: 1; }
        .notes-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .note-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
        .note-item:hover { background-color: #f9f9f9; }
        .note-thumb { width: 60px; height: 45px; background-color: #12264d; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; }
        .note-info { flex: 1; }
        .note-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 4px; }
        .note-date { font-size: 0.85rem; color: #999; }
        .note-menu-dots { color: #bbb; font-size: 1.5rem; font-weight: bold; margin-left: 10px; }

        /* =========================================
           ç”»é¢2: ç·¨é›†ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ç”»é¢
           ========================================= */
        #view-edit { display: none; width: 100%; height: 100%; background-color: #12264d; color: #333; position: relative; }

        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 70px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-upper { background-color: #f4f5f7; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .back-nav { width: 100%; display: flex; align-items: center; justify-content: center; color: #007aff; font-weight: bold; font-size: 0.8rem; cursor: pointer; margin: 10px 0; }
        .back-nav span { font-size: 1.1rem; margin-right: 2px; font-weight: normal; }
        .icon-btn { width: 54px; height: 54px; margin-bottom: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.1s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-lower { background-color: transparent; width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; gap: 12px; }
        .circle-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .circle-icon { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #fff; position: relative; z-index: 2; }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }
        .circle-wrapper::after { content: "â—€"; color: #fff; font-size: 0.9rem; position: absolute; right: -18px; top: 12px; font-weight: bold; }
        .icon-label-white { color: #fff; font-size: 0.65rem; margin-top: 3px; font-weight: bold; }
        
        .header-info-edit { position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .user-name-area { font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; }
        .user-name-area:hover { background: rgba(255,255,255,0.2); }
        .class-info-edit { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        .trash-area { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; color: #666; z-index: 50; cursor: pointer; transition: transform 0.1s; }
        .trash-area:active { transform: scale(0.95); }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge { background: #333; color: #fff; border: 1px solid #777; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px; }

        /* --- ãƒãƒ£ãƒƒãƒˆ(æå‡ºç®±)ç”»é¢ --- */
        #chat-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 75%; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; overflow: hidden; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; font-size: 1.1rem; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }
        .close-btn:hover { color: #f00; }
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .wrapper-mine { align-self: flex-end; align-items: flex-end; }
        .wrapper-other { align-self: flex-start; align-items: flex-start; }
        .msg-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; border: 1px solid #eee; position: relative; width: 100%; }
        .msg-mine { background: #e6f2ff; border: 1px solid #cce5ff; }
        .msg-other { background: #fff; }
        .msg-name { font-size: 0.7rem; color: #888; margin-bottom: 4px; font-weight: bold; }
        .msg-content img { max-width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; border: 1px solid #ddd; }
        .read-label { font-size: 0.7rem; color: #888; margin-top: 2px; font-weight: bold; }
        .input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; align-items: center; }
        #chat-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; font-family: inherit; transition: border 0.2s; }
        #chat-input:focus { border-color: #007aff; }
        #photo-btn, #send-btn { background: #f0f0f0; color: #555; border: none; width: 44px; height: 44px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; width: auto; padding: 0 20px; font-size: 1rem; }
        #loading-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #007aff; animation: load 1s infinite linear; display: none; z-index: 300; }
        @keyframes load { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

        /* =========================================
           æ–°æ©Ÿèƒ½ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
           ========================================= */
        
        /* 1. ã‚«ãƒ¡ãƒ©ç”»é¢ */
        #camera-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #webcam-video {
            width: 100%; height: 100%; object-fit: contain;
            transform: scaleX(-1); /* é¡ã®ã‚ˆã†ã«åè»¢ */
        }
        #camera-ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* ä¸‹ã®ãƒ“ãƒ‡ã‚ªã‚’ã‚¯ãƒªãƒƒã‚¯ã•ã›ãªã„ãŸã‚ */
            display: flex; flex-direction: column; justify-content: space-between; pading: 20px;
        }
        .cam-controls {
            pointer-events: auto;
            position: absolute; bottom: 30px; width: 100%; text-align: center;
        }
        .cam-shutter {
            width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #ccc;
            display: inline-block; cursor: pointer;
        }
        .cam-close {
            pointer-events: auto;
            position: absolute; bottom: 40px; right: 40px;
            background: #444; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer;
        }

        /* 2. è‰²é¸æŠãƒ‘ãƒ¬ãƒƒãƒˆ */
        #color-picker-overlay {
            position: fixed; top: 0; left: 70px; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ¨ª */
            width: 300px; height: auto;
            background: #fff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 400; display: none;
            padding: 10px; border: 1px solid #ccc;
        }
        .color-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .color-opt {
            height: 60px; border: 1px solid #ccc; cursor: pointer;
        }
        .c-pink { background: #ffcdd2; }
        .c-red { background: #ef5350; }
        .c-yellow { background: #fff9c4; }
        .c-orange { background: #ffca28; }
        .c-green-l { background: #c8e6c9; }
        .c-green-d { background: #00897b; }
        .c-blue-l { background: #b3e5fc; }
        .c-blue-d { background: #1565c0; }
        .c-white { background: #fff; }
        .c-black { background: #000; }

        /* 3. ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ (ãƒ”ãƒ³ã‚¯ç­‰ã®ç”»é¢) */
        #card-editor-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffcdd2; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ”ãƒ³ã‚¯ */
            z-index: 450; display: none;
            flex-direction: column;
        }
        .editor-toolbar {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px;
        }
        .editor-tools-center {
            display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 30px;
        }
        .et-icon {
            width: 36px; height: 36px; border-radius: 50%; background: #666; color: #fff;
            display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem;
        }
        .et-icon.active { background: #00bcd4; }
        
        .editor-send-btn {
            background: transparent; border: 2px solid #fff; border-radius: 20px;
            color: #fff; font-weight: bold; padding: 5px 20px; cursor: pointer;
        }
        .editor-back-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff;
            display: flex; justify-content: center; align-items: center; color: #fff; cursor: pointer; font-size: 1.2rem;
        }
        
        .editor-main {
            flex: 1; display: flex; justify-content: center; align-items: center; position: relative;
        }
        #card-textarea {
            width: 80%; height: 80%;
            background: transparent; border: none; outline: none;
            font-size: 2rem; font-family: inherit; resize: none; text-align: center; color: #333;
        }

        /* 4. AIãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ–°è¨­ï¼‰ */
        #ai-overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 600px; height: 75%; background: #fff; border-radius: 12px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; 
            z-index: 460; overflow: hidden; border: 2px solid #10a37f;
        }
        .ai-header {
            padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #fff; 
            display: flex; justify-content: space-between; align-items: center; 
            background: #10a37f; /* ChatGPTã£ã½ã„ç·‘ */ font-size: 1.1rem;
        }
        #ai-msg-list {
            flex: 1; padding: 20px; overflow-y: auto; background: #f0fdf4; 
            display: flex; flex-direction: column; gap: 15px;
        }
        .msg-ai {
            background: #fff; border: 1px solid #d1e7dd; 
        }
        .msg-user-ai {
            background: #e6f2ff; border: 1px solid #cce5ff; align-self: flex-end;
        }
        .ai-avatar {
            width: 30px; height: 30px; border-radius: 50%; background: #10a37f; 
            display: flex; align-items: center; justify-content: center; color: #fff; margin-right: 8px; font-size: 0.8rem;
        }

    </style>
</head>
<body>

    <!-- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <div id="view-list">
        <div class="list-sidebar">
            <div class="class-title">2å¹´6çµ„</div>
            <div class="subject-list">
                <div class="subject-item subject-active">è‹±èªA <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">éŸ³æ¥½ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å®¶åº­ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å­¦æ´» <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æŠ€è¡“ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å›½èª <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç¤¾ä¼š <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æ•°å­¦ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç·åˆ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ä½“è‚² <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">é“å¾³ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç†ç§‘ <span class="subject-menu-icon">...</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="bottom-item code-item"><img src="purasu.png" alt="+"> ã‚¯ãƒ©ã‚¹å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
                <div class="bottom-item"><img src="hei.png" alt="é–‰è¬›"> é–‰è¬›ã—ãŸæˆæ¥­</div>
                <div class="bottom-item"><img src="jisyu.png" alt="è‡ªä¸»"> è‡ªä¸»å­¦ç¿’</div>
                <div class="bottom-item"><img src="sin.png" alt="æ–°"> æ–°æ©Ÿèƒ½</div>
                <div class="bottom-item"><img src="roiro.png" alt="i"> ãƒ­ã‚¤ãƒ­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
            </div>
        </div>
        <div class="list-main">
            <div class="list-header-top">
                <div class="tab-container">
                    <div class="tab-btn tab-active"><img src="no.png" class="tab-icon">ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="kyo.png" class="tab-icon">å…±æœ‰ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="tei.png" class="tab-icon">æå‡ºç®±</div>
                    <div class="tab-btn"><img src="tai.png" class="tab-icon">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
                </div>
                <div class="header-right-area"><span class="user-icon-mini"></span> <span class="display-name-ref">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span>âˆ¨</span></div>
            </div>
            <div class="list-toolbar-area">
                <div class="new-note-btn"><img src="purasu.png" class="plus-icon-img" alt="+">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œã‚‹</div>
                <div class="tool-icons-right">
                    <img src="sika.png" class="tool-icon" title="ã‚°ãƒªãƒƒãƒ‰">
                    <img src="yaji.png" class="tool-icon" title="ä¸¦ã³æ›¿ãˆ">
                    <img src="riro.png" class="tool-icon" title="æ›´æ–°">
                    <img src="ten.png" class="tool-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                </div>
            </div>
            <div class="notes-container">
                <div class="note-item" onclick="goToEditMode()">
                    <div class="note-thumb"></div>
                    <div class="note-info"><div class="note-title">2025å¹´12æœˆ4æ—¥ã®ãƒãƒ¼ãƒˆ</div><div class="note-date">2025å¹´12æœˆ4æ—¥(æœ¨) 10:18</div></div>
                    <div class="note-menu-dots">...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢2: ãƒãƒ¼ãƒˆç·¨é›†ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ç”»é¢ -->
    <div id="view-edit">
        <div class="sidebar">
            <div class="sidebar-upper">
                <div class="back-nav" onclick="goToListMode()"><span>ï¼œ</span> æˆ»ã‚‹</div>
                <div class="icon-btn" id="btn-camera"><img src="kamera.png" alt="ã‚«ãƒ¡ãƒ©"></div>
                <!-- ãƒ†ã‚­ã‚¹ãƒˆãƒœã‚¿ãƒ³ï¼šè‰²é¸æŠã¸ -->
                <div class="icon-btn" id="btn-text"><img src="text.png" alt="ãƒ†ã‚­ã‚¹ãƒˆ"></div>
                
                <!-- Webãƒœã‚¿ãƒ³: ãƒªãƒ³ã‚¯ã¸ -->
                <div class="icon-btn" onclick="window.open('https://school.loilo.tv/jp/web.html', '_blank')"><img src="web.png" alt="Web"></div>
                
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="icon-btn" onclick="document.getElementById('file-input').click()"><img src="file.png" alt="ãƒ•ã‚¡ã‚¤ãƒ«"></div>
                
                <div class="icon-btn"><img src="think.png" alt="ãƒ„ãƒ¼ãƒ«"></div>
                <div class="icon-btn"><img src="test.png" alt="ãƒ†ã‚¹ãƒˆ"></div>
            </div>
            <div class="sidebar-lower">
                <!-- â˜…è³‡æ–™ç®± -> AIãƒ¢ãƒ¼ãƒ‰èµ·å‹•ã«å¤‰æ›´ â˜… -->
                <div class="circle-wrapper" id="btn-open-ai">
                    <div class="circle-icon"><img src="si.png" alt="è³‡æ–™ç®±"></div>
                    <div class="icon-label-white">è³‡æ–™ç®±</div>
                </div>
                
                <!-- æå‡ºãƒœã‚¿ãƒ³ï¼šãƒãƒ£ãƒƒãƒˆã‚’é–‹ã -->
                <div class="circle-wrapper" id="toggle-chat-btn"><div class="circle-icon"><img src="te.png" alt="æå‡º"></div><div class="icon-label-white">æå‡º</div></div>
                
                <!-- é€ã‚‹ -> ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆæœ¬å®¶URLã¸ç§»å‹• -->
                <div class="circle-wrapper" onclick="window.location.href='https://loilonote.app/_/'">
                    <div class="circle-icon"><img src="o.png" alt="é€ã‚‹"></div>
                    <div class="icon-label-white">é€ã‚‹</div>
                </div>
            </div>
        </div>
        <div class="header-info-edit">
            <div class="user-name-area" id="user-name-display"><span id="current-name">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span style="font-size:0.8rem; margin-left:5px;">âˆ¨</span></div>
            <div class="class-info-edit">2å¹´6çµ„ / è‹±èªA<br><span id="current-date">--</span></div>
        </div>
        
        <div class="trash-area" id="trash-btn" title="ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚µãƒ¼ãƒãƒ¼å®¹é‡ã‚’ç©ºã‘ã‚‹">
            <img src="gomi.png" class="trash-img" alt="ã‚´ãƒŸç®±">
            <div class="saved-badge">ä¿å­˜æ¸ˆã¿</div>
        </div>

        <!-- æå‡ºç®±ï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="chat-overlay">
            <div id="loading-indicator"></div>
            <div class="chat-header">æå‡ºç®±ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼‰<span class="close-btn" id="close-chat-x">Ã—</span></div>
            <div id="msg-list"></div>
            <div class="input-area">
                <input type="file" id="file-input" accept="image/*" style="display: none;">
                <button id="photo-btn" title="å†™çœŸã‚’è¿½åŠ " style="display:none;">ğŸ“·</button>
                <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." autocomplete="off">
                <button id="send-btn">é€ä¿¡</button>
            </div>
        </div>

        <!-- â˜… æ–°æ©Ÿèƒ½ 4: AIãƒãƒ£ãƒƒãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… -->
        <div id="ai-overlay">
            <div class="ai-header">AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ (AI Mode)<span class="close-btn" id="close-ai-x" style="color:#fff;">Ã—</span></div>
            <div id="ai-msg-list">
                <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div class="msg-wrapper wrapper-other">
                    <div class="msg-card msg-ai" style="display:flex; align-items:flex-start;">
                        <div class="ai-avatar">AI</div>
                        <div>ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹ãŠæ‰‹ä¼ã„ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</div>
                    </div>
                </div>
            </div>
            <div class="input-area">
                <input type="text" id="ai-input" placeholder="AIã«è³ªå•ã™ã‚‹..." autocomplete="off">
                <button id="ai-send-btn" style="background:#10a37f; color:#fff;">é€ä¿¡</button>
            </div>
        </div>


        <!-- â˜… æ–°æ©Ÿèƒ½ 1: ã‚«ãƒ¡ãƒ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â˜… -->
        <div id="camera-overlay">
            <video id="webcam-video" autoplay playsinline></video>
            <div id="camera-ui-layer">
                <div class="cam-controls">
                    <div class="cam-shutter" title="æ’®å½±ï¼ˆé£¾ã‚Šï¼‰"></div>
                </div>
                <div class="cam-close" id="close-camera-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
            </div>
        </div>

        <!-- â˜… æ–°æ©Ÿèƒ½ 2: è‰²é¸æŠãƒ‘ãƒ¬ãƒƒãƒˆ â˜… -->
        <div id="color-picker-overlay">
            <div class="color-grid">
                <div class="color-opt c-pink" onclick="openEditor('#ffcdd2')"></div>
                <div class="color-opt c-red" onclick="openEditor('#ef5350')"></div>
                <div class="color-opt c-yellow" onclick="openEditor('#fff9c4')"></div>
                <div class="color-opt c-orange" onclick="openEditor('#ffca28')"></div>
                <div class="color-opt c-green-l" onclick="openEditor('#c8e6c9')"></div>
                <div class="color-opt c-green-d" onclick="openEditor('#00897b')"></div>
                <div class="color-opt c-blue-l" onclick="openEditor('#b3e5fc')"></div>
                <div class="color-opt c-blue-d" onclick="openEditor('#1565c0')"></div>
                <div class="color-opt c-white" onclick="openEditor('#fff')"></div>
                <div class="color-opt c-black" onclick="openEditor('#222')"></div>
            </div>
        </div>

        <!-- â˜… æ–°æ©Ÿèƒ½ 3: ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ â˜… -->
        <div id="card-editor-overlay">
            <div class="editor-toolbar">
                <div class="editor-back-btn" onclick="closeEditor()">â†</div>
                <!-- ãƒ„ãƒ¼ãƒ«é¡ -->
                <div class="editor-tools-center">
                    <div class="et-icon">ğŸ‘†</div>
                    <div class="et-icon">ğŸ–Šï¸</div>
                    <div class="et-icon active">ã‚</div>
                    <div class="et-icon">ğŸ¤</div>
                    <div class="et-icon">â¹ï¸</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="et-icon">...</div>
                    <button class="editor-send-btn" onclick="sendCardFromEditor()">é€ã‚‹</button>
                </div>
            </div>
            <div class="editor-main">
                <textarea id="card-textarea" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDocs, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyC9UgkUd62D79QfweQA1i0akH04kxwItD4",
          authDomain: "newchat-90c71.firebaseapp.com",
          projectId: "newchat-90c71",
          storageBucket: "newchat-90c71.firebasestorage.app",
          messagingSenderId: "633675964296",
          appId: "1:633675964296:web:89ea68a0c7de516a29a43d",
          measurementId: "G-7SM0B9KDXE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- å¤‰æ•° ---
        let currentStream = null;
        let selectedColor = '#ffcdd2';

        // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
        window.goToEditMode = function() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-edit').style.display = 'block';
        };

        window.goToListMode = function() {
            document.getElementById('view-edit').style.display = 'none';
            document.getElementById('view-list').style.display = 'flex';
            toggleChat(false);
            toggleAI(false); // AIã‚‚é–‰ã˜ã‚‹
            closeCamera();
            closeColorPicker();
            closeEditor();
        };

        // --- åŸºæœ¬UIè¦ç´  ---
        const toggleBtn = document.getElementById("toggle-chat-btn");
        const chatOverlay = document.getElementById("chat-overlay");
        const closeX = document.getElementById("close-chat-x");
        const nameDisplay = document.getElementById("user-name-display");
        const currentNameSpan = document.getElementById("current-name");
        const dateSpan = document.getElementById("current-date");
        const msgList = document.getElementById("msg-list");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-btn");
        const fileInput = document.getElementById("file-input");
        const loadingBar = document.getElementById("loading-indicator");
        const trashBtn = document.getElementById("trash-btn");
        const nameRefs = document.querySelectorAll(".display-name-ref");

        // æ—¥ä»˜ãƒ»åå‰è¨­å®š
        const now = new Date();
        dateSpan.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ã®ãƒãƒ¼ãƒˆ`;
        let myName = localStorage.getItem('loilo_v2_name') || "ã“ã“ã«åå‰ã‚’å…¥åŠ›";
        currentNameSpan.textContent = myName;
        nameRefs.forEach(el => el.textContent = myName);

        nameDisplay.addEventListener('click', () => {
            const newName = prompt("è¡¨ç¤ºåã‚’å¤‰æ›´:", myName);
            if(newName && newName.trim() !== ""){
                myName = newName; 
                currentNameSpan.textContent = myName; 
                localStorage.setItem('loilo_v2_name', myName);
                nameRefs.forEach(el => el.textContent = myName);
            }
        });
        const myUid = localStorage.getItem('loilo_v2_uid') || Math.random().toString(36).substring(7);
        localStorage.setItem('loilo_v2_uid', myUid);

        // --- ãƒãƒ£ãƒƒãƒˆï¼ˆæå‡ºç®±ï¼‰ãƒ­ã‚¸ãƒƒã‚¯ ---
        function toggleChat(forceState) {
            let isChatOpen = (chatOverlay.style.display === "flex");
            if (forceState !== undefined) isChatOpen = !forceState; 
            
            if (forceState === true) {
                chatOverlay.style.display = "flex";
                msgList.scrollTop = msgList.scrollHeight;
            } else if (forceState === false) {
                chatOverlay.style.display = "none";
            } else {
                chatOverlay.style.display = (chatOverlay.style.display === "flex") ? "none" : "flex";
                if (chatOverlay.style.display === "flex") msgList.scrollTop = msgList.scrollHeight;
            }
        }
        toggleBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        closeX.addEventListener("click", () => toggleChat(false));

        // --- ç”»åƒåœ§ç¸®ãƒ»é€ä¿¡ ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5));
                    };
                    img.onerror = (error) => reject(error);
                };
            });
        }

        async function sendPayload(text = "", file = null) {
            if (!text && !file) return;
            loadingBar.style.display = "block";
            let imageUrl = null;
            try {
                if (file) {
                    imageUrl = await compressImage(file);
                }
                await addDoc(collection(db, "fake_loilo_v2"), {
                    text: text, imageUrl: imageUrl, name: myName, uid: myUid, createdAt: serverTimestamp(), readBy: []
                });
                chatInput.value = "";
            } catch (e) {
                console.error(e);
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼");
            } finally {
                loadingBar.style.display = "none";
            }
        }

        sendBtn.addEventListener("click", () => sendPayload(chatInput.value));
        chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendPayload(chatInput.value); });
        
        fileInput.addEventListener("change", async (e) => {
            const file = e.target.files[0]; if (!file) return;
            sendPayload("", file); fileInput.value = "";
        });

        // --- å…¨æ¶ˆå» ---
        trashBtn.addEventListener("dblclick", async () => {
            if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            loadingBar.style.display = "block";
            try {
                const q = query(collection(db, "fake_loilo_v2"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((doc) => { deletePromises.push(deleteDoc(doc.ref)); });
                await Promise.all(deletePromises);
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            } catch (e) { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼"); } finally { loadingBar.style.display = "none"; }
        });

        // --- å—ä¿¡ ---
        const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            msgList.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                if (data.uid !== myUid && (!data.readBy || !data.readBy.includes(myUid))) {
                    try { updateDoc(doc(db, "fake_loilo_v2", docSnap.id), { readBy: arrayUnion(myUid) }); } catch(e){}
                }
                const wrapper = document.createElement("div"); wrapper.classList.add("msg-wrapper");
                const div = document.createElement("div"); div.classList.add("msg-card");
                if (data.uid === myUid) { wrapper.classList.add("wrapper-mine"); div.classList.add("msg-mine"); } else { wrapper.classList.add("wrapper-other"); div.classList.add("msg-other"); }
                let contentHtml = "";
                if (data.imageUrl) contentHtml += `<img src="${data.imageUrl}" onclick="window.open(this.src)">`;
                if (data.text) contentHtml += `<div>${escapeHtml(data.text)}</div>`;
                div.innerHTML = `<div class="msg-name">${escapeHtml(data.name)}</div><div class="msg-content">${contentHtml}</div>`;
                wrapper.appendChild(div);
                if (data.uid === myUid && data.readBy && data.readBy.length > 0) {
                    const readLabel = document.createElement("div"); readLabel.classList.add("read-label"); readLabel.textContent = "æ—¢èª­"; wrapper.appendChild(readLabel);
                }
                msgList.appendChild(wrapper);
            });
            msgList.scrollTop = msgList.scrollHeight;
        });

        // ===============================================
        // â˜… æ–°æ©Ÿèƒ½ãƒ­ã‚¸ãƒƒã‚¯ â˜…
        // ===============================================

        // 1. ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½
        const btnCamera = document.getElementById("btn-camera");
        const cameraOverlay = document.getElementById("camera-overlay");
        const videoEl = document.getElementById("webcam-video");
        const closeCameraBtn = document.getElementById("close-camera-btn");

        btnCamera.addEventListener("click", async () => {
            cameraOverlay.style.display = "flex";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoEl.srcObject = stream;
                currentStream = stream;
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
                cameraOverlay.style.display = "none";
            }
        });

        function closeCamera() {
            cameraOverlay.style.display = "none";
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        closeCameraBtn.addEventListener("click", closeCamera);


        // 2. ãƒ†ã‚­ã‚¹ãƒˆæ©Ÿèƒ½ & AIæ©Ÿèƒ½
        const btnText = document.getElementById("btn-text");
        const colorPicker = document.getElementById("color-picker-overlay");
        const cardEditor = document.getElementById("card-editor-overlay");
        const cardTextarea = document.getElementById("card-textarea");
        
        // AIé–¢é€£è¦ç´ 
        const btnOpenAI = document.getElementById("btn-open-ai");
        const aiOverlay = document.getElementById("ai-overlay");
        const closeAIX = document.getElementById("close-ai-x");
        const aiMsgList = document.getElementById("ai-msg-list");
        const aiInput = document.getElementById("ai-input");
        const aiSendBtn = document.getElementById("ai-send-btn");

        // --- AIãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡ ---
        function toggleAI(forceState) {
            let isOpen = (aiOverlay.style.display === "flex");
            if (forceState !== undefined) isOpen = !forceState;

            if (!isOpen) {
                aiOverlay.style.display = "flex";
                aiInput.focus();
            } else {
                aiOverlay.style.display = "none";
            }
        }
        
        btnOpenAI.addEventListener("click", (e) => { e.stopPropagation(); toggleAI(true); });
        closeAIX.addEventListener("click", () => toggleAI(false));

        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ã€Œã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰AIã€ã‚³ãƒ¼ãƒ‰ â˜…â˜…â˜…
        async function sendToAI() {
            const text = aiInput.value;
            if(!text.trim()) return;

            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const userWrapper = document.createElement("div");
            userWrapper.classList.add("msg-wrapper", "wrapper-mine");
            userWrapper.innerHTML = `<div class="msg-card msg-user-ai">${escapeHtml(text)}</div>`;
            aiMsgList.appendChild(userWrapper);
            aiMsgList.scrollTop = aiMsgList.scrollHeight;
            aiInput.value = "";

            // 2. ã€Œè€ƒãˆä¸­...ã€ã‚’è¡¨ç¤º
            const loadingDiv = document.createElement("div");
            loadingDiv.classList.add("msg-wrapper", "wrapper-other");
            loadingDiv.innerHTML = `<div class="msg-card msg-ai" style="color:#888;">AIãŒè€ƒãˆä¸­...</div>`;
            aiMsgList.appendChild(loadingDiv);
            aiMsgList.scrollTop = aiMsgList.scrollHeight;

            try {
                // æœ¬ç‰©ã®APIã‚­ãƒ¼ã‚’è©¦ã™
                const apiKey = "AIzaSyC2-3MhoExfJ49CRrowO86qhCPXvAFewFI"; 
                
                // æœ¬ç‰©ã®AI (Gemini) ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });

                if (!response.ok) {
                    throw new Error("AIé€šä¿¡ã‚¨ãƒ©ãƒ¼: " + response.status);
                }

                const data = await response.json();
                let aiText = "";
                if (data.candidates && data.candidates[0].content) {
                    aiText = data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("Empty response");
                }

                // æˆåŠŸã—ãŸã‚‰è¡¨ç¤º
                aiMsgList.removeChild(loadingDiv);
                displayAIResponse(aiText);

            } catch (error) {
                // â˜…å¤±æ•—ã—ãŸã‚‰ã€Œè³¢ã„å½AIã€ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯ã—ãªã„ï¼ï¼‰
                console.warn("Real AI failed, switching to fake mode:", error);
                
                // å°‘ã—ã ã‘å¾…ã£ã¦ã‹ã‚‰å½å›ç­”ã‚’è¡¨ç¤º
                setTimeout(() => {
                    if(loadingDiv.parentNode) aiMsgList.removeChild(loadingDiv);
                    
                    // è³¢ã„å½å›ç­”ãƒ­ã‚¸ãƒƒã‚¯
                    let fakeResponse = "ãªã‚‹ã»ã©ã€ãã‚Œã¯é‹­ã„è¦–ç‚¹ã§ã™ã­ã€‚æ•™ç§‘æ›¸ã®æ¬¡ã®ãƒšãƒ¼ã‚¸ã«é–¢é€£ã™ã‚‹ã“ã¨ãŒè¼‰ã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚";
                    
                    if(text.includes("ç­”ãˆ") || text.includes("æ•™ãˆã¦")) {
                        fakeResponse = "ç­”ãˆã‚’æ•™ãˆã‚‹ã®ã¯ç°¡å˜ã§ã™ãŒã€ã¾ãšã¯è‡ªåˆ†ã®è€ƒãˆã‚’ãƒãƒ¼ãƒˆã«ã¾ã¨ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼";
                    } else if(text.includes("ã“ã‚“ã«ã¡ã¯") || text.includes("hello")) {
                        fakeResponse = "ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã®å­¦ç¿’ã®èª¿å­ã¯ã©ã†ã§ã™ã‹ï¼Ÿ";
                    } else if(text.includes("æ„å‘³") || text.includes("ã¨ã¯")) {
                        fakeResponse = "ãã‚Œã¯é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã™ã­ã€‚è¾æ›¸ã§èª¿ã¹ãŸæ„å‘³ã¨ã€è‡ªåˆ†ã®è¨€è‘‰ã§ã®èª¬æ˜ã‚’æ¯”ã¹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
                    } else if(text.includes("ã‚ã‚ŠãŒã¨ã†")) {
                        fakeResponse = "ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ã¾ãŸã„ã¤ã§ã‚‚è³ªå•ã—ã¦ãã ã•ã„ã€‚";
                    } else if(text.length > 10) {
                        fakeResponse = "éå¸¸ã«èˆˆå‘³æ·±ã„è³ªå•ã§ã™ã€‚ãã®ä»¶ã«ã¤ã„ã¦ã€ã‚¯ãƒ©ã‚¹ã®ã¿ã‚“ãªã¯ã©ã†è€ƒãˆã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ";
                    }

                    displayAIResponse(fakeResponse);
                }, 500);
            }
        }

        function displayAIResponse(content) {
            const aiWrapper = document.createElement("div");
            aiWrapper.classList.add("msg-wrapper", "wrapper-other");
            aiWrapper.innerHTML = `
                <div class="msg-card msg-ai" style="display:flex; align-items:flex-start;">
                    <div class="ai-avatar">AI</div>
                    <div style="white-space: pre-wrap;">${escapeHtml(content)}</div>
                </div>`;
            aiMsgList.appendChild(aiWrapper);
            aiMsgList.scrollTop = aiMsgList.scrollHeight;
        }
        // â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜…

        aiSendBtn.addEventListener("click", sendToAI);
        aiInput.addEventListener("keypress", (e) => { if(e.key === "Enter") sendToAI(); });


        // --- ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿é–¢é€£ ---
        btnText.addEventListener("click", (e) => {
            e.stopPropagation();
            colorPicker.style.display = (colorPicker.style.display === "block") ? "none" : "block";
        });
        
        window.openEditor = function(color) {
            selectedColor = color;
            colorPicker.style.display = "none";
            cardEditor.style.background = color;
            if (color === "#000" || color === "#222" || color === "#1565c0" || color === "#00897b") {
                cardTextarea.style.color = "#fff";
            } else {
                cardTextarea.style.color = "#333";
            }
            cardEditor.style.display = "flex";
            cardTextarea.value = "";
            cardTextarea.focus();
        };

        window.closeColorPicker = function() { colorPicker.style.display = "none"; };
        window.closeEditor = function() { cardEditor.style.display = "none"; };

        window.sendCardFromEditor = async function() {
            const text = cardTextarea.value;
            if (!text.trim()) return;
            closeEditor();
            toggleChat(true);
            sendPayload(text);
        };

        document.body.addEventListener("click", (e) => {
            if (!colorPicker.contains(e.target) && !btnText.contains(e.target)) {
                closeColorPicker();
            }
        });

        function escapeHtml(str) { if(!str) return ""; return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    </script>
</body>
</html>
