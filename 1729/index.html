<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="loilo.ico" type="image/x-icon">
    <title>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆ ã‚¹ã‚¯ãƒ¼ãƒ«</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
        body { margin: 0; padding: 0; font-family: "BIZ UDGothic", sans-serif; overflow: hidden; height: 100vh; user-select: none; color: #333; background: #fff; }
        input, button, textarea { font-family: "BIZ UDGothic", sans-serif; }
        
        /* å…±é€šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: #12264d; z-index: 2500; 
            display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }

        /* --- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« (ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢) --- */
        #view-portal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #12264d; z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        .portal-logo-img { max-width: 300px; height: auto; margin-bottom: 30px; }
        .portal-btn {
            background: #fff; color: #333; width: 320px; height: 50px; border-radius: 4px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1rem;
            border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: opacity 0.2s;
        }
        .portal-btn:hover { opacity: 0.9; }
        .btn-icon-img { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }
        .portal-links { margin-top: 10px; text-align: center; font-size: 0.9rem; }
        .portal-links a { color: #fff; text-decoration: underline; cursor: pointer; display: block; margin-bottom: 8px; }
        .portal-footer { margin-top: 40px; font-size: 0.8rem; opacity: 0.8; }
        .portal-footer span { margin: 0 5px; cursor: pointer; }

        /* å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ç³» */
        .login-box {
            background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 16px; text-align: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .pass-input-field { padding: 10px; font-size: 1.2rem; border-radius: 8px; border: none; text-align: center; width: 200px; margin-bottom: 20px; }
        .login-action-btn { padding: 10px 30px; font-size: 1.1rem; background: #007aff; color: #fff; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .back-link { margin-top: 20px; color: #aaa; cursor: pointer; text-decoration: underline; font-size: 0.9rem; }
        .login-error-msg { color: #ff6b6b; margin-top: 10px; font-weight: bold; min-height: 20px;}

        /* --- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ --- */
        #view-list { display: none; width: 100%; height: 100%; background-color: #fff; }
        .list-sidebar { width: 260px; background-color: #f5f5f7; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding-top: 20px; }
        .class-title { padding: 0 20px 15px 20px; font-weight: bold; color: #555; font-size: 1rem; }
        .subject-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .subject-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #333; font-size: 1rem; border-radius: 8px; transition: background 0.1s; }
        .subject-item:hover { background-color: rgba(0,0,0,0.05); }
        .subject-active { background-color: #fff; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .sidebar-bottom { padding: 15px 20px; border-top: 1px solid #e0e0e0; background: #f5f5f7; }
        .bottom-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; cursor: pointer; font-size: 0.95rem; color: #444; font-weight: bold; }
        .bottom-item img { width: 24px; height: 24px; object-fit: contain; }
        .code-item { color: #0099ff; } 
        .list-main { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .list-header-top { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; position: relative; }
        .tab-container { display: flex; gap: 10px; margin: 0 auto; transform: translateX(50px); }
        .tab-btn { display: flex; align-items: center; gap: 6px; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 0.95rem; cursor: pointer; color: #666; }
        .tab-active { background-color: #e6f2ff; color: #007aff; }
        .tab-icon { width: 20px; height: 20px; object-fit: contain; }
        .header-right-area { display: flex; align-items: center; gap: 15px; color: #007aff; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .list-toolbar-area { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; }
        .new-note-btn { display: flex; align-items: center; gap: 8px; color: #0099ff; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .plus-icon-img { width: 28px; height: 28px; }
        .tool-icons-right { display: flex; gap: 15px; align-items: center; }
        .tool-icon { width: 28px; height: 28px; cursor: pointer; opacity: 0.7; }
        .notes-container { flex: 1; overflow-y: auto; padding: 0 20px; }
        .note-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.1s; }
        .note-item:hover { background-color: #f9f9f9; }
        .note-thumb { width: 60px; height: 45px; background-color: #12264d; border-radius: 4px; margin-right: 15px; border: 1px solid #ccc; }
        .note-info { flex: 1; }
        .note-title { font-weight: bold; font-size: 1.1rem; color: #333; margin-bottom: 4px; }
        .note-date { font-size: 0.85rem; color: #999; }
        .note-menu-dots { color: #bbb; font-size: 1.5rem; font-weight: bold; margin-left: 10px; }

        /* --- ç”»é¢2: ç·¨é›†ç”»é¢ --- */
        #view-edit { display: none; width: 100%; height: 100%; background-color: #12264d; color: #333; position: relative; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 70px; display: flex; flex-direction: column; z-index: 100; }
        .sidebar-upper { background-color: #f4f5f7; width: 100%; display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .back-nav { width: 100%; display: flex; align-items: center; justify-content: center; color: #007aff; font-weight: bold; font-size: 0.8rem; cursor: pointer; margin: 10px 0; }
        .back-nav span { font-size: 1.1rem; margin-right: 2px; font-weight: normal; }
        .icon-btn { width: 54px; height: 54px; margin-bottom: 4px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; transition: background 0.1s; }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn img { width: 100%; height: 100%; object-fit: contain; }
        .sidebar-lower { background-color: transparent; width: 100%; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 15px; gap: 12px; }
        .circle-wrapper { display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .circle-icon { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #fff; position: relative; z-index: 2; }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }
        .circle-wrapper::after { content: "â—€"; color: #fff; font-size: 0.9rem; position: absolute; right: -18px; top: 12px; font-weight: bold; }
        .icon-label-white { color: #fff; font-size: 0.65rem; margin-top: 3px; font-weight: bold; }
        .header-info-edit { position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; }
        .user-name-area { font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; position: relative;}
        .user-name-area:hover { background: rgba(255,255,255,0.2); }
        .class-info-edit { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        .trash-area { position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; color: #666; z-index: 50; cursor: pointer; transition: transform 0.1s; }
        .trash-area:active { transform: scale(0.95); }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge { background: #333; color: #fff; border: 1px solid #777; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px; }

        /* ----------------------------------------------------
           â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰
           ---------------------------------------------------- */
        .user-menu-dropdown {
            position: fixed; /* å›ºå®šä½ç½®ã«å¤‰æ›´ */
            top: 60px; right: 20px; 
            background: #fff; color: #333;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 320px; display: none; z-index: 9999;
            overflow: hidden; border: 1px solid #ddd;
            font-family: "BIZ UDGothic", sans-serif;
            text-align: center;
        }
        .menu-header-info {
            padding: 20px; border-bottom: 1px solid #eee; background: #fcfcfc;
        }
        .p-school { font-size: 0.9rem; color: #555; margin-bottom: 8px; }
        .p-id { font-size: 1rem; color: #666; margin-bottom: 8px; font-family: monospace; }
        .p-name { font-size: 1.4rem; font-weight: bold; color: #333; }
        
        .profile-menu-item {
            padding: 15px 0; border-bottom: 1px solid #eee; color: #007aff; font-weight: bold; cursor: pointer; transition: background 0.1s;
        }
        .profile-menu-item:hover { background: #f0f8ff; }
        .profile-menu-item:last-child { border-bottom: none; }
        .sub-status { font-size: 0.7rem; color: #f00; font-weight: normal; margin-top: 3px; }

        /* ----------------------------------------------------
           â˜… ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
           ---------------------------------------------------- */
        #view-settings {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 4000;
            display: none; align-items: center; justify-content: center;
        }
        .settings-modal {
            width: 600px; height: 80%; background: #f5f5f7;
            border-radius: 12px; display: flex; flex-direction: column;
            overflow: hidden; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .settings-header {
            background: #f5f5f7; padding: 15px; border-bottom: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
        }
        .settings-title { font-weight: bold; font-size: 1.1rem; flex: 1; text-align: center; }
        .settings-close-btn { color: #007aff; cursor: pointer; font-weight: bold; }
        .settings-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-section-title { font-size: 0.85rem; color: #666; margin: 20px 0 5px 15px; }
        .settings-group { background: #fff; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        .settings-row {
            padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1rem;
        }
        .settings-row:last-child { border-bottom: none; }
        .toggle-switch { position: relative; width: 50px; height: 30px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #34c759; } 
        input:checked + .slider:before { transform: translateX(20px); }
        .range-container { display: flex; align-items: center; gap: 10px; width: 50%; }
        .range-slider { width: 100%; }
        .setting-val { color: #666; }
        .version-text { color: #888; font-size: 0.9rem; margin-top: 20px; text-align: center; }

        /* ãƒãƒ£ãƒƒãƒˆ (æå‡ºç®±) */
        #chat-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 75%; background: #fff; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: none; flex-direction: column; z-index: 200; overflow: hidden; }
        .chat-header { padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; font-size: 1.1rem; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }
        #msg-list { flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 70%; transition: background 0.2s; border-radius: 8px;}
        .wrapper-mine { align-self: flex-end; align-items: flex-end; }
        .wrapper-other { align-self: flex-start; align-items: flex-start; }
        .msg-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; border: 1px solid #eee; position: relative; width: 100%; cursor: pointer; transition: transform 0.1s; }
        .msg-card:active { transform: scale(0.98); }
        .msg-mine { background: #e6f2ff; border: 1px solid #cce5ff; }
        .msg-other { background: #fff; }
        .reply-ref { background: rgba(0,0,0,0.05); border-left: 3px solid #007aff; padding: 4px 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.8rem; color: #555; }
        #reply-status-bar { background: #e6f2ff; padding: 5px 15px; font-size: 0.8rem; display: none; justify-content: space-between; align-items: center; border-top: 1px solid #ccc; color: #007aff; font-weight: bold; }
        .cancel-reply { cursor: pointer; color: #f00; margin-left: 10px; font-weight: bold; }
        .input-area { padding: 15px; border-top: 1px solid #eee; background: #fff; display: flex; gap: 10px; align-items: center; flex-direction: column; }
        .input-row { display: flex; width: 100%; gap: 10px; align-items: center; }
        #chat-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; padding: 0 20px; border:none; height:44px; border-radius:8px;}
        #loading-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #007aff; animation: load 1s infinite linear; display: none; z-index: 300; }
        @keyframes load { 0% { width: 0%; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

        /* ç®¡ç†è€…ãƒ‘ãƒãƒ« */
        #view-admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 3000; display: none; flex-direction: column; color: #333; }
        .admin-header { background: #333; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.2rem; }
        .admin-close-btn { background: #555; border: 1px solid #777; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .admin-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .user-control-row { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .user-info-admin { font-size: 1.1rem; font-weight: bold; }
        .status-label { font-size: 0.8rem; margin-left: 10px; font-weight: bold; color: #666; }

        /* ãã®ä»–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #camera-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #webcam-video { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        #camera-ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; pading: 20px; }
        .cam-controls { pointer-events: auto; position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .cam-shutter { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 4px solid #ccc; display: inline-block; cursor: pointer; }
        .cam-close { pointer-events: auto; position: absolute; bottom: 40px; right: 40px; background: #444; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        
        #color-picker-overlay { position: fixed; top: 0; left: 70px; width: 300px; height: auto; background: #fff; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 400; display: none; padding: 10px; border: 1px solid #ccc; }
        .color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .color-opt { height: 60px; border: 1px solid #ccc; cursor: pointer; }
        .c-pink { background: #ffcdd2; } .c-red { background: #ef5350; } .c-yellow { background: #fff9c4; } .c-orange { background: #ffca28; } .c-green-l { background: #c8e6c9; } .c-green-d { background: #00897b; } .c-blue-l { background: #b3e5fc; } .c-blue-d { background: #1565c0; } .c-white { background: #fff; } .c-black { background: #000; }
        
        #card-editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffcdd2; z-index: 450; display: none; flex-direction: column; }
        .editor-toolbar { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .editor-tools-center { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 5px 15px; border-radius: 30px; }
        .et-icon { width: 36px; height: 36px; border-radius: 50%; background: #666; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .et-icon.active { background: #00bcd4; }
        .editor-send-btn { background: transparent; border: 2px solid #fff; border-radius: 20px; color: #fff; font-weight: bold; padding: 5px 20px; cursor: pointer; }
        .editor-back-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; display: flex; justify-content: center; align-items: center; color: #fff; cursor: pointer; font-size: 1.2rem; }
        .editor-main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #card-textarea { width: 80%; height: 80%; background: transparent; border: none; outline: none; font-size: 2rem; font-family: inherit; resize: none; text-align: center; color: #333; }

    </style>
</head>
<body>

    <!-- ç”»é¢0: ãƒãƒ¼ã‚¿ãƒ« -->
    <div id="view-portal">
        <img src="loilo.png" alt="LOILONOTE SCHOOL" class="portal-logo-img">
        <button class="portal-btn" onclick="goToUserLogin()"><img src="loi.png" class="btn-icon-img" alt=""> ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="google.png" class="btn-icon-img" alt=""> Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="portal-btn"><img src="mic.png" class="btn-icon-img" alt=""> Microsoftã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div class="portal-links">
            <a>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‹ã‚‰ãªã„å ´åˆ</a><br>
            <a onclick="goToAdminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</a>
            <a>ãƒ­ã‚¤ãƒ­ãƒãƒ¼ãƒˆã¨ã¯ï¼Ÿ</a>
        </div>
        <div class="portal-footer">
            <span style="text-decoration: underline;">æ—¥æœ¬èª</span> <span>ã²ã‚‰ãŒãª</span> <span>English</span> <span>ç¹é«”ä¸­æ–‡</span> <span>ç®€ä½“ä¸­æ–‡</span>
        </div>
    </div>

    <!-- ç”»é¢0.5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-user-login" class="overlay-screen">
        <div class="login-box">
            <div class="login-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div><br>
            <input type="password" id="user-pass-input" class="pass-input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="user-login-btn" class="login-action-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="user-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backToPortal()">æˆ»ã‚‹</div>
        </div>
    </div>

    <!-- ç”»é¢0.6: ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ -->
    <div id="view-admin-login" class="overlay-screen">
        <div class="login-box" style="border: 2px solid #ffcc00;">
            <div class="login-title">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div><br>
            <input type="password" id="admin-pass-input" class="pass-input-field" placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="off">
            <br><button id="admin-login-btn" class="login-action-btn">ç®¡ç†ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div id="admin-login-error" class="login-error-msg"></div>
            <div class="back-link" onclick="backFromAdmin()">æˆ»ã‚‹</div>
        </div>
    </div>

<!-- ç”»é¢0.7: ç®¡ç†è€…ãƒ‘ãƒãƒ« -->
    <div id="view-admin-panel">
        <div class="admin-header"><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†</span><span class="admin-close-btn" onclick="closeAdminPanel()">é–‰ã˜ã‚‹</span></div>
        
        <!-- â–¼â–¼â–¼ ã“ã“ã«è¿½åŠ  â–¼â–¼â–¼ -->
        <div style="padding: 20px; text-align: center; border-bottom: 1px solid #eee;">
            <button id="admin-delete-all-btn" style="background: #ff3b30; color: #fff; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                âš  ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å…¨æ¶ˆå»
            </button>
        </div>
        <!-- â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–² -->

        <div class="admin-content" id="admin-user-list"></div>
    </div>

    <!-- ç”»é¢1: ãƒãƒ¼ãƒˆä¸€è¦§ -->
    <div id="view-list">
        <div class="list-sidebar">
            <div class="class-title">2å¹´6çµ„</div>
            <div class="subject-list">
                <div class="subject-item subject-active">è‹±èªA <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">éŸ³æ¥½ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å®¶åº­ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å­¦æ´» <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æŠ€è¡“ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">å›½èª <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç¤¾ä¼š <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">æ•°å­¦ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç·åˆ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ä½“è‚² <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">é“å¾³ <span class="subject-menu-icon">...</span></div>
                <div class="subject-item">ç†ç§‘ <span class="subject-menu-icon">...</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="bottom-item code-item"><img src="purasu.png" alt="+"> ã‚¯ãƒ©ã‚¹å‚åŠ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</div>
                <div class="bottom-item"><img src="hei.png" alt="é–‰è¬›"> é–‰è¬›ã—ãŸæˆæ¥­</div>
                <div class="bottom-item"><img src="jisyu.png" alt="è‡ªä¸»"> è‡ªä¸»å­¦ç¿’</div>
                <div class="bottom-item"><img src="sin.png" alt="æ–°"> æ–°æ©Ÿèƒ½</div>
                <div class="bottom-item"><img src="roiro.png" alt="i"> ãƒ­ã‚¤ãƒ­ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
            </div>
        </div>
        <div class="list-main">
            <div class="list-header-top">
                <div class="tab-container">
                    <div class="tab-btn tab-active"><img src="no.png" class="tab-icon">ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="kyo.png" class="tab-icon">å…±æœ‰ãƒãƒ¼ãƒˆ</div>
                    <div class="tab-btn"><img src="tei.png" class="tab-icon">æå‡ºç®±</div>
                    <div class="tab-btn"><img src="tai.png" class="tab-icon">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
                </div>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
                <div class="header-right-area" id="header-user-area">
                    <span class="user-icon-mini"></span> 
                    <span class="display-name-ref">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span>âˆ¨</span>
                </div>
            </div>
            <div class="list-toolbar-area">
                <div class="new-note-btn"><img src="purasu.png" class="plus-icon-img" alt="+">æ–°ã—ã„ãƒãƒ¼ãƒˆã‚’ä½œã‚‹</div>
                <div class="tool-icons-right">
                    <img src="sika.png" class="tool-icon" title="ã‚°ãƒªãƒƒãƒ‰">
                    <img src="yaji.png" class="tool-icon" title="ä¸¦ã³æ›¿ãˆ">
                    <img src="riro.png" class="tool-icon" title="æ›´æ–°">
                    <img src="ten.png" class="tool-icon" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
                </div>
            </div>
            <div class="notes-container">
                <div class="note-item" onclick="goToEditMode()">
                    <div class="note-thumb"></div>
                    <div class="note-info"><div class="note-title">2025å¹´12æœˆ4æ—¥ã®ãƒãƒ¼ãƒˆ</div><div class="note-date">2025å¹´12æœˆ4æ—¥(æœ¨) 10:18</div></div>
                    <div class="note-menu-dots">...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”»é¢2: ç·¨é›†ç”»é¢ -->
    <div id="view-edit">
        <div class="sidebar">
            <div class="sidebar-upper">
                <div class="back-nav" onclick="goToListMode()"><span>ï¼œ</span> æˆ»ã‚‹</div>
                <div class="icon-btn" id="btn-camera"><img src="kamera.png" alt="ã‚«ãƒ¡ãƒ©"></div>
                <div class="icon-btn" id="btn-text"><img src="text.png" alt="ãƒ†ã‚­ã‚¹ãƒˆ"></div>
                <div class="icon-btn" onclick="window.open('https://school.loilo.tv/jp/web.html', '_blank')"><img src="web.png" alt="Web"></div>
                <div class="icon-btn" onclick="document.getElementById('file-input').click()"><img src="file.png" alt="ãƒ•ã‚¡ã‚¤ãƒ«"></div>
                <div class="icon-btn"><img src="think.png" alt="ãƒ„ãƒ¼ãƒ«"></div>
                <div class="icon-btn"><img src="test.png" alt="ãƒ†ã‚¹ãƒˆ"></div>
            </div>
            <div class="sidebar-lower">
                <div class="circle-wrapper" onclick="window.open('https://copilot.microsoft.com', '_blank')">
                    <div class="circle-icon"><img src="si.png" alt="è³‡æ–™ç®±"></div><div class="icon-label-white">è³‡æ–™ç®±</div>
                </div>
                <div class="circle-wrapper" id="toggle-chat-btn"><div class="circle-icon"><img src="te.png" alt="æå‡º"></div><div class="icon-label-white">æå‡º</div></div>
                <div class="circle-wrapper" onclick="window.location.href='https://loilonote.app/_/'">
                    <div class="circle-icon"><img src="o.png" alt="é€ã‚‹"></div><div class="icon-label-white">é€ã‚‹</div>
                </div>
            </div>
        </div>
        <div class="header-info-edit">
            <div class="user-name-area" id="user-name-display"><span id="current-name">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> <span style="font-size:0.8rem; margin-left:5px;">âˆ¨</span></div>
            <div class="class-info-edit">2å¹´6çµ„ / è‹±èªA<br><span id="current-date">--</span></div>
        </div>
        <div class="trash-area" id="trash-btn" title="ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ã‚µãƒ¼ãƒãƒ¼å®¹é‡ã‚’ç©ºã‘ã‚‹"><img src="gomi.png" class="trash-img" alt="ã‚´ãƒŸç®±"><div class="saved-badge">ä¿å­˜æ¸ˆã¿</div></div>

        <!-- æå‡ºç®± -->
        <div id="chat-overlay">
            <div id="loading-indicator"></div>
            <div class="chat-header">æå‡ºç®±ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ï¼‰<span class="close-btn" id="close-chat-x">Ã—</span></div>
            <div id="msg-list"></div>
            <div class="input-area">
                <div id="reply-status-bar" style="width:100%; display:none; justify-content:space-between; margin-bottom:5px;">
                    <span id="reply-target-text">è¿”ä¿¡å…ˆ...</span><span class="cancel-reply" onclick="cancelReply()">Ã—</span>
                </div>
                <div class="input-row">
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <button id="photo-btn" title="å†™çœŸã‚’è¿½åŠ " style="display:none;">ğŸ“·</button>
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." autocomplete="off">
                    <button id="send-btn">é€ä¿¡</button>
                </div>
            </div>
        </div>

        <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ©Ÿèƒ½ç¾¤ -->
        <div id="camera-overlay"><video id="webcam-video" autoplay playsinline></video><div id="camera-ui-layer"><div class="cam-controls"><div class="cam-shutter"></div></div><div class="cam-close" id="close-camera-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div></div></div>
        <div id="color-picker-overlay"><div class="color-grid"><div class="color-opt c-pink" onclick="openEditor('#ffcdd2')"></div><div class="color-opt c-red" onclick="openEditor('#ef5350')"></div><div class="color-opt c-yellow" onclick="openEditor('#fff9c4')"></div><div class="color-opt c-orange" onclick="openEditor('#ffca28')"></div><div class="color-opt c-green-l" onclick="openEditor('#c8e6c9')"></div><div class="color-opt c-green-d" onclick="openEditor('#00897b')"></div><div class="color-opt c-blue-l" onclick="openEditor('#b3e5fc')"></div><div class="color-opt c-blue-d" onclick="openEditor('#1565c0')"></div><div class="color-opt c-white" onclick="openEditor('#fff')"></div><div class="color-opt c-black" onclick="openEditor('#222')"></div></div></div>
        <div id="card-editor-overlay">
            <div class="editor-toolbar"><div class="editor-back-btn" onclick="closeEditor()">â†</div><div class="editor-tools-center"><div class="et-icon">ğŸ‘†</div><div class="et-icon">ğŸ–Šï¸</div><div class="et-icon active">ã‚</div><div class="et-icon">ğŸ¤</div><div class="et-icon">â¹ï¸</div></div><div style="display:flex; gap:10px;"><div class="et-icon">...</div><button class="editor-send-btn" onclick="sendCardFromEditor()">é€ã‚‹</button></div></div>
            <div class="editor-main"><textarea id="card-textarea" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea></div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="user-menu-dropdown" class="user-menu-dropdown">
        <div class="menu-header-info">
            <div class="p-school">æ¨ªæµœå¸‚ç«‹å¸‚å ´ä¸­å­¦æ ¡</div>
            <div class="p-id" id="p-user-id">---</div>
            <div class="p-name" id="p-user-realname">---</div>
        </div>
        <div class="profile-menu-item" onclick="window.open('https://help.loilonote.app/', '_blank')">ã‚µãƒãƒ¼ãƒˆ</div>
        <div class="profile-menu-item">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã‚‹</div>
        <div class="profile-menu-item" onclick="openSettings()">ã‚¢ãƒ—ãƒªè¨­å®š</div>
        <div class="profile-menu-item" onclick="alert('ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™ã€‚\nå¿œç­”æ™‚é–“: 12ms')">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³<div class="sub-status">ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆå®šãŒã‚ã‚Šã¾ã™</div></div>
        <div class="profile-menu-item" onclick="changeNameAction()">åå‰ã‚’å¤‰æ›´</div>
        <div class="profile-menu-item" onclick="goToAdminLoginFromMenu()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
        <div class="profile-menu-item" onclick="location.reload()" style="color:#ff3b30;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="view-settings">
        <div class="settings-modal">
            <div class="settings-header">
                <span class="settings-close-btn" onclick="closeSettings()">é–‰ã˜ã‚‹</span>
                <span class="settings-title">ã‚¢ãƒ—ãƒªè¨­å®š</span>
                <span style="width:40px;"></span>
            </div>
            <div class="settings-content">
                <div class="settings-section-title">æ‹¡å¤§ãƒ»ç¸®å°</div>
                <div class="settings-group">
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã®æ–¹å‘ã‚’åè»¢ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div>
                    <div class="settings-row"><span>ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                    <div class="settings-row"><span>ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ã®ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ æ„Ÿåº¦</span><div class="range-container"><input type="range" class="range-slider"><span class="setting-val">100%</span></div></div>
                </div>
                <div class="settings-section-title">è¨€èªè¨­å®š</div>
                <div class="settings-group"><div class="settings-row"><span>æ—¥æœ¬èª</span><span style="color:#007aff; cursor:pointer;">å¤‰æ›´ âˆ¨</span></div></div>
                <div class="settings-section-title">æ‰‹æ›¸ã</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒšãƒ³å„ªå…ˆãƒ¢ãƒ¼ãƒ‰</span><label class="toggle-switch"><input type="checkbox" checked><span class="slider"></span></label></div></div>
                <div class="settings-section-title">éŒ²éŸ³ãƒ»éŒ²ç”»</div>
                <div class="settings-group"><div class="settings-row"><span>é›‘éŸ³ã‚’ä½æ¸›ã™ã‚‹</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="settings-section-title">ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£</div>
                <div class="settings-group"><div class="settings-row"><span>ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’</span><span style="color:#ccc;">></span></div></div>
                <div class="settings-section-title">è©¦é¨“ä¸­ã®æ©Ÿèƒ½</div>
                <div class="settings-group"><div class="settings-row"><span>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ</span><label class="toggle-switch"><input type="checkbox"><span class="slider"></span></label></div></div>
                <div class="version-text">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ v2.35</div>
                <div class="version-text">ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, getDocs, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyC9UgkUd62D79QfweQA1i0akH04kxwItD4",
          authDomain: "newchat-90c71.firebaseapp.com",
          projectId: "newchat-90c71",
          storageBucket: "newchat-90c71.firebasestorage.app",
          messagingSenderId: "633675964296",
          appId: "1:633675964296:web:89ea68a0c7de516a29a43d",
          measurementId: "G-7SM0B9KDXE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
        const USERS = {
            "6351": "è¥¿å°¾é’è‘‰",
            "7253": "è¥¿æ‘æ‚ ",
            "8712": "é´«åŸå®—æ¬¡éƒ",
            "8827": "å¯Œæ°¸æ‚ æœˆ",
            "1726": "ç”°ä¸­å¤§æ¨¹",
            "sample12": "ã‚µãƒ³ãƒ—ãƒ«1",
            "sample25": "ã‚µãƒ³ãƒ—ãƒ«2",
            "sample726": "ã‚µãƒ³ãƒ—ãƒ«3",
            "admin": "ç®¡ç†è€…ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ",
            "testuser": "ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼"
        };
        const ADMIN_PASS = ["1726", "admin"];

        // ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        const PERM_KEY = "loilo_fake_permissions";
        let permissions = JSON.parse(localStorage.getItem(PERM_KEY)) || {};
        for (let id in USERS) { if (permissions[id] === undefined) permissions[id] = true; }
        localStorage.setItem(PERM_KEY, JSON.stringify(permissions));
        function savePermissions() { localStorage.setItem(PERM_KEY, JSON.stringify(permissions)); }

        // å¤‰æ•°
        let currentStream = null;
        let selectedColor = '#ffcdd2';
        let myName = localStorage.getItem('loilo_v2_name') || "ã“ã“ã«åå‰ã‚’å…¥åŠ›";
        let realName = "";
        let currentLoginId = ""; 
        let replyTargetId = null;

        // ç”»é¢è¦ç´ 
        const viewPortal = document.getElementById("view-portal");
        const viewUserLogin = document.getElementById("view-user-login");
        const viewAdminLogin = document.getElementById("view-admin-login");
        const viewAdminPanel = document.getElementById("view-admin-panel");
        const viewList = document.getElementById("view-list");
        const viewEdit = document.getElementById("view-edit");
        const viewSettings = document.getElementById("view-settings");

        const headerUserArea = document.getElementById("header-user-area");
        const editUserArea = document.getElementById("user-name-display");
        const userMenu = document.getElementById("user-menu-dropdown"); // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
        const pUserId = document.getElementById("p-user-id");
        const pUserRealName = document.getElementById("p-user-realname");

        // ç”»é¢é·ç§»
        window.goToUserLogin = function() { viewPortal.style.display = "none"; viewUserLogin.style.display = "flex"; document.getElementById("user-pass-input").focus(); };
        window.goToAdminLogin = function() { viewPortal.style.display = "none"; viewAdminLogin.style.display = "flex"; document.getElementById("admin-pass-input").focus(); };
        
        window.backToPortal = function() { 
            viewUserLogin.style.display = "none"; 
            viewAdminLogin.style.display = "none"; 
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {
                    // nop (stay in edit view)
                } else {
                    viewList.style.display = "flex"; 
                }
            } else {
                viewPortal.style.display = "flex"; 
            }
            document.getElementById("user-pass-input").value = "";
            document.getElementById("admin-pass-input").value = "";
            document.getElementById("user-login-error").textContent = "";
            document.getElementById("admin-login-error").textContent = "";
        };
        
        window.backFromAdmin = function() {
            viewAdminLogin.style.display = "none";
            document.getElementById("admin-login-error").textContent = "";
            document.getElementById("admin-pass-input").value = "";
            if (currentLoginId) {
                if (viewEdit.style.display === "block") {
                    // ç·¨é›†ç”»é¢ç¶­æŒ
                } else {
                    viewList.style.display = "flex";
                }
            } else {
                viewPortal.style.display = "flex";
            }
        };
        
        window.goToEditMode = function() { document.getElementById('view-list').style.display = 'none'; document.getElementById('view-edit').style.display = 'block'; };
        window.goToListMode = function() { document.getElementById('view-edit').style.display = 'none'; document.getElementById('view-list').style.display = 'flex'; toggleChat(false); closeCamera(); closeColorPicker(); closeEditor(); };

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById("user-login-btn").addEventListener("click", performUserLogin);
        document.getElementById("user-pass-input").addEventListener("keypress", (e) => { if(e.key === "Enter") performUserLogin(); });

        function performUserLogin() {
            const val = document.getElementById("user-pass-input").value;
            if (USERS[val]) {
                if (permissions[val] === false) {
                    document.getElementById("user-login-error").textContent = "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™";
                    return;
                }
                realName = USERS[val];
                currentLoginId = val;
                viewUserLogin.style.display = "none";
                viewList.style.display = "flex";
                updateNameDisplay();
            } else {
                document.getElementById("user-login-error").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
                document.getElementById("user-pass-input").value = "";
            }
        }

        // åå‰æ›´æ–°
        const currentNameSpan = document.getElementById("current-name");
        const nameRefs = document.querySelectorAll(".display-name-ref");
        const dateSpan = document.getElementById("current-date");
        const now = new Date();
        dateSpan.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ã®ãƒãƒ¼ãƒˆ`;

        function updateNameDisplay() {
            const fullName = `${myName}ãƒ»${realName}`;
            currentNameSpan.textContent = fullName;
            nameRefs.forEach(el => el.textContent = fullName);
            pUserId.textContent = currentLoginId; 
            pUserRealName.textContent = realName;
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰åˆ¶å¾¡ ---
        headerUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        editUserArea.addEventListener('click', (e) => { e.stopPropagation(); toggleUserMenu(); });
        
        function toggleUserMenu() {
            const isVisible = userMenu.style.display === 'block';
            userMenu.style.display = isVisible ? 'none' : 'block';
        }
        
        // ç”»é¢ã®ã©ã“ã‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        document.addEventListener('click', () => {
            userMenu.style.display = 'none';
        });
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†…éƒ¨ã‚¯ãƒªãƒƒã‚¯ã¯é–‰ã˜ãªã„
        userMenu.addEventListener('click', (e) => { e.stopPropagation(); });


        window.changeNameAction = function() {
            userMenu.style.display = 'none';
            const newName = prompt("è¡¨ç¤ºåã‚’å¤‰æ›´:", myName);
            if(newName && newName.trim() !== ""){
                myName = newName; localStorage.setItem('loilo_v2_name', myName); updateNameDisplay();
            }
        };
        
        window.openSettings = function() { userMenu.style.display = 'none'; viewSettings.style.display = "flex"; };
        window.closeSettings = function() { viewSettings.style.display = "none"; };
        
        window.goToAdminLoginFromMenu = function() {
            userMenu.style.display = 'none';
            // ç¾åœ¨ã®ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
            viewList.style.display = 'none'; 
            // viewEditã‚’ã“ã“ã§éè¡¨ç¤ºã«ã™ã‚‹ã¨å¾©å¸°ãŒé¢å€’ãªã®ã§ã€z-indexã§ä¸Šæ›¸ãã™ã‚‹ãŒ
            // ä»Šå›ã®æ§‹é€ ä¸Šã€display:noneã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            // ãŸã ã—ã€æˆ»ã‚‹ã¨ãã«çŠ¶æ…‹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€currentLoginIdã§åˆ¤å®šã™ã‚‹
            viewEdit.style.display = 'none'; 
            viewAdminLogin.style.display = 'flex';
        }

        // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById("admin-login-btn").addEventListener("click", performAdminLogin);
        function performAdminLogin() {
            // å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒªã‚¹ãƒˆã®ä¸­ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
            if (ADMIN_PASS.includes(document.getElementById("admin-pass-input").value)) {
                viewAdminLogin.style.display = "none"; viewAdminPanel.style.display = "flex"; renderAdminList();
            } else { document.getElementById("admin-login-error").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"; }
        }
        
        window.closeAdminPanel = function() { 
            viewAdminPanel.style.display = "none"; 
            document.getElementById("admin-pass-input").value = "";
            if(currentLoginId) {
                // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãªã‚‰ä¸€è¦§ã«æˆ»ã™ï¼ˆç°¡æ˜“çš„ï¼‰
                // ç·¨é›†ç”»é¢ã‹ã‚‰æ¥ãŸå ´åˆã§ã‚‚ä¸€è¦§ã«æˆ»ã‚‹ã®ã¯ä»•æ§˜ã¨ã™ã‚‹
                viewList.style.display = "flex"; 
            } else {
                viewPortal.style.display = "flex"; 
            }
        };

        function renderAdminList() {
            const listDiv = document.getElementById("admin-user-list"); listDiv.innerHTML = "";
            for (let id in USERS) {
                const row = document.createElement("div"); row.className = "user-control-row";
                row.innerHTML = `<div class="user-info-admin">${USERS[id]} (${id})</div><div style="display:flex; align-items:center;"><label class="toggle-switch"><input type="checkbox" ${permissions[id]?"checked":""} onchange="togglePermission('${id}', this)"><span class="slider"></span></label><span class="status-label">${permissions[id]?"è¨±å¯":"ç¦æ­¢"}</span></div>`;
                listDiv.appendChild(row);
            }
        }
        window.togglePermission = function(id, cb) { permissions[id] = cb.checked; savePermissions(); cb.parentElement.nextElementSibling.textContent = permissions[id]?"è¨±å¯":"ç¦æ­¢"; };

        // ãƒãƒ£ãƒƒãƒˆ & Firebase
        const chatOverlay = document.getElementById("chat-overlay");
        const msgList = document.getElementById("msg-list");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-btn");
        const replyStatusBar = document.getElementById("reply-status-bar");
        const replyTargetText = document.getElementById("reply-target-text");
        const myUid = localStorage.getItem('loilo_v2_uid') || Math.random().toString(36).substring(7); localStorage.setItem('loilo_v2_uid', myUid);

        document.getElementById("toggle-chat-btn").addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        document.getElementById("close-chat-x").addEventListener("click", () => toggleChat(false));

        function toggleChat(force) {
            let show = (chatOverlay.style.display === "flex");
            if (force !== undefined) show = !force;
            chatOverlay.style.display = show ? "none" : "flex";
            if (!show) window.cancelReply();
            else msgList.scrollTop = msgList.scrollHeight;
        }

        window.cancelReply = function() { replyTargetId = null; replyStatusBar.style.display = "none"; }

        async function sendPayload(text="", file=null) {
            if(!text && !file) return;
            let imageUrl = null;
            if(file) {
                // ç°¡æ˜“åœ§ç¸®
                imageUrl = await new Promise(r=>{const fr=new FileReader();fr.onload=e=>r(e.target.result);fr.readAsDataURL(file);});
            }
            const payload = { text, imageUrl, name: `${myName}ãƒ»${realName}`, uid: myUid, createdAt: serverTimestamp(), readBy: [] };
            if(replyTargetId) payload.replyTo = replyTargetId;
            await addDoc(collection(db, "fake_loilo_v2"), payload);
            chatInput.value = ""; window.cancelReply();
        }
        sendBtn.addEventListener("click", ()=>sendPayload(chatInput.value));
        chatInput.addEventListener("keypress", (e)=>{if(e.key==="Enter")sendPayload(chatInput.value)});
        document.getElementById("file-input").addEventListener("change", (e)=>sendPayload("", e.target.files[0]));

        // å—ä¿¡
        const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
            msgList.innerHTML = ""; const idMap = {};
            snap.forEach(d => idMap[d.id] = d.data().text || "ç”»åƒ");
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement("div"); div.className = "msg-wrapper " + (data.uid===myUid?"wrapper-mine":"wrapper-other");
                const card = document.createElement("div"); card.className = "msg-card " + (data.uid===myUid?"msg-mine":"msg-other");
                card.id = "msg-"+d.id;
                card.addEventListener("dblclick", ()=>{ replyTargetId=d.id; replyTargetText.textContent="è¿”ä¿¡å…ˆ: "+(data.text||"ç”»åƒ"); replyStatusBar.style.display="flex"; });
                
                let html = "";
                if(data.replyTo && idMap[data.replyTo]) html += `<div class="reply-ref" onclick="document.getElementById('msg-${data.replyTo}').scrollIntoView({behavior:'smooth'});">â†© ${escapeHtml(idMap[data.replyTo])}</div>`;
                if(data.imageUrl) html += `<img src="${data.imageUrl}" onclick="window.open(this.src)">`;
                if(data.text) html += `<div>${escapeHtml(data.text)}</div>`;
                card.innerHTML = `<div class="msg-name">${escapeHtml(data.name)}</div><div class="msg-content">${html}</div>`;
                div.appendChild(card);
                if(data.uid===myUid && data.readBy && data.readBy.length>0) {
                    const read = document.createElement("div"); read.className="read-label"; read.textContent="æ—¢èª­"; div.appendChild(read);
                }
                msgList.appendChild(div);
            });
            msgList.scrollTop = msgList.scrollHeight;
        });

        // ãƒ„ãƒ¼ãƒ«é¡ (ã‚«ãƒ¡ãƒ©ã€ã‚¨ãƒ‡ã‚£ã‚¿)
        const btnText = document.getElementById("btn-text");
        const colorPicker = document.getElementById("color-picker-overlay");
        const cardEditor = document.getElementById("card-editor-overlay");
        const cardTextarea = document.getElementById("card-textarea");
        
        // ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã®ä¿®æ­£ (ç¢ºå®Ÿã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«)
        const btnCamera = document.getElementById("btn-camera");
        const cameraOverlay = document.getElementById("camera-overlay");
        const videoEl = document.getElementById("webcam-video");
        const closeCameraBtn = document.getElementById("close-camera-btn");

        btnCamera.addEventListener("click", async () => {
            cameraOverlay.style.display = "flex";
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoEl.srcObject = currentStream;
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
                cameraOverlay.style.display = "none";
            }
        });

        window.closeCamera = function() {
            cameraOverlay.style.display = "none";
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        };
        closeCameraBtn.addEventListener("click", closeCamera);


        btnText.addEventListener("click", (e) => { e.stopPropagation(); colorPicker.style.display = "block"; });
        window.openEditor = function(c) { selectedColor=c; colorPicker.style.display="none"; cardEditor.style.background=c; cardEditor.style.display="flex"; cardTextarea.value=""; cardTextarea.focus(); };
        window.closeEditor = function() { cardEditor.style.display="none"; };
        window.sendCardFromEditor = function() { if(cardTextarea.value.trim()){ closeEditor(); toggleChat(true); sendPayload(cardTextarea.value); } };
        document.body.addEventListener("click", (e) => { if(!colorPicker.contains(e.target)&&!btnText.contains(e.target)) colorPicker.style.display="none"; });

        // --- å…¨æ¶ˆå» (Trash Bin) ---
// --- ç®¡ç†è€…ç”¨ï¼šå±¥æ­´å…¨æ¶ˆå»ãƒœã‚¿ãƒ³ ---
        document.getElementById("admin-delete-all-btn").addEventListener("click", async () => {
            if (!confirm("ã€è­¦å‘Šã€‘\nã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¨ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
            
            // å¿µã®ãŸã‚ã‚‚ã†ä¸€åº¦ç¢ºèª
            if (!confirm("å‰Šé™¤ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;

            loadingBar.style.display = "block";
            try {
                // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
                const q = query(collection(db, "fake_loilo_v2"));
                const querySnapshot = await getDocs(q);
                
                // ä¸€æ‹¬å‰Šé™¤å‡¦ç†
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(document.ref));
                });
                await Promise.all(deletePromises);
                
                alert("å±¥æ­´ã‚’å…¨æ¶ˆå»ã—ã¾ã—ãŸã€‚");
            } catch (e) {
                console.error(e);
                alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                loadingBar.style.display = "none";
            }
        });

        // æ—¢å­˜ã®ã‚´ãƒŸç®±ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‰Šé™¤æ©Ÿèƒ½
        trashBtn.addEventListener("dblclick", async () => {
            if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            loadingBar.style.display = "block";
            try {
                const q = query(collection(db, "fake_loilo_v2"));
                const querySnapshot = await getDocs(q);
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(document.ref));
                });
                await Promise.all(deletePromises);
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
            } catch (e) {
                console.error(e);
                alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                loadingBar.style.display = "none";
            }
        });

        function escapeHtml(str) { if(!str)return""; return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    </script>
</body>
</html>
