<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- æ¤œç´¢é¿ã‘ -->
    <meta name="robots" content="noindex, nofollow">
    <!-- UDãƒ•ã‚©ãƒ³ãƒˆï¼ˆGoogle Fontsï¼‰ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    
    <title>è‹±èªA - ãƒãƒ¼ãƒˆ</title>
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { 
            margin: 0; padding: 0; 
            font-family: "BIZ UDGothic", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; 
            overflow: hidden; 
            background-color: #12264d; /* å…¨ä½“ã®èƒŒæ™¯è‰²ï¼ˆæ¿ƒã„ç´ºè‰²ï¼‰ */ 
            color: #333; height: 100vh; user-select: none; 
        }
        
        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼å…¨ä½“ --- */
        .sidebar {
            position: absolute; left: 0; top: 0; bottom: 0; width: 85px;
            display: flex; flex-direction: column; 
            z-index: 100;
        }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸Šéƒ¨ï¼ˆç™½ã‚¨ãƒªã‚¢ï¼‰ --- */
        .sidebar-upper {
            background-color: #f4f5f7; /* è–„ã„ã‚°ãƒ¬ãƒ¼ç™½ */
            width: 100%;
            display: flex; flex-direction: column; align-items: center;
            padding-bottom: 20px;
        }

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-nav {
            width: 100%; display: flex; align-items: center; justify-content: center;
            color: #007aff; font-weight: bold; font-size: 0.9rem; cursor: pointer;
            margin: 10px 0;
        }
        .back-nav span { font-size: 1.2rem; margin-right: 2px; font-weight: normal; }

        /* ä¸Šéƒ¨ã‚¢ã‚¤ã‚³ãƒ³å…±é€š */
        .icon-btn {
            width: 60px; height: 60px;
            margin-bottom: 5px;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px;
            transition: background 0.1s;
        }
        .icon-btn:hover { background-color: rgba(0,0,0,0.05); }
        .icon-btn:active { background-color: rgba(0,0,0,0.1); }
        
        .icon-btn img {
            width: 100%; height: 100%; object-fit: contain;
        }

        /* --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ä¸‹éƒ¨ï¼ˆç´ºã‚¨ãƒªã‚¢ï¼‰ --- */
        .sidebar-lower {
            background-color: transparent; /* èƒŒæ™¯è‰²ã¯bodyã®ç´ºè‰²ãŒé€ã‘ã‚‹ */
            width: 100%;
            flex: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’åŸ‹ã‚ã‚‹ */
            display: flex; flex-direction: column; align-items: center;
            justify-content: flex-end; /* ä¸‹ã«å¯„ã›ã‚‹ */
            padding-bottom: 20px;
            gap: 15px;
        }

        /* ä¸‹éƒ¨ä¸¸å‹ã‚¢ã‚¤ã‚³ãƒ³ */
        .circle-wrapper {
            display: flex; flex-direction: column; align-items: center;
            position: relative;
            cursor: pointer;
        }
        
        .circle-icon {
            width: 55px; height: 55px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 2;
        }
        .circle-icon img { width: 100%; height: 100%; object-fit: cover; }

        /* ç”»åƒã«ã‚ã‚‹å·¦å‘ãçŸ¢å°ï¼ˆâ—€ï¼‰ã®å†ç¾ */
        .arrow-indicator {
            position: absolute;
            right: -15px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®å³å´ã«é…ç½®ï¼ˆç”»åƒã§ã¯å·¦å´ã«è¦‹ãˆã¾ã™ãŒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸Šã‚¢ã‚¤ã‚³ãƒ³ã®å³ã‹ã‚‰å‡ºã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹ãŸã‚èª¿æ•´ï¼‰ */
            top: 50%; transform: translateY(-50%);
            color: #fff; font-size: 1.5rem;
            display: none; /* ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚éè¡¨ç¤ºã€å¿…è¦ãªã‚‰blockã« */
        }
        
        /* ã‚¢ã‚¤ã‚³ãƒ³æ¨ªã®ç™½ã„çŸ¢å° */
        .circle-wrapper::after {
            content: "â—€";
            color: #fff;
            font-size: 1.2rem;
            position: absolute;
            right: -25px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®å³å´ã«é…ç½® */
            top: 15px;
            font-weight: bold;
        }

        .icon-label-white {
            color: #fff; font-size: 0.75rem; margin-top: 4px; font-weight: bold;
        }


        /* --- å³ä¸Šã®æƒ…å ±ã‚¨ãƒªã‚¢ --- */
        .header-info {
            position: absolute; top: 15px; right: 20px; text-align: right; color: #fff; z-index: 50;
            display: flex; flex-direction: column; align-items: flex-end;
        }
        .user-name-area {
            font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center;
            background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px;
        }
        .user-name-area:hover { background: rgba(255,255,255,0.2); }
        .user-icon-mini { margin-right: 8px; font-size: 1.2rem; }
        .class-info { font-size: 0.85rem; margin-top: 5px; opacity: 0.9; }
        
        /* --- å³ä¸‹ã®ã‚´ãƒŸç®± --- */
        .trash-area {
            position: absolute; bottom: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end;
            color: #666; z-index: 50; cursor: pointer;
        }
        .trash-img { width: 50px; opacity: 0.6; }
        .saved-badge {
            background: #333; color: #fff; border: 1px solid #777;
            font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; margin-top: 2px;
        }

        /* --- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ --- */
        #chat-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 600px; height: 75%;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            flex-direction: column;
            z-index: 200;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 12px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #444;
            display: flex; justify-content: space-between; align-items: center; background: #fcfcfc;
            font-size: 1.1rem;
        }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; padding: 0 10px; }
        .close-btn:hover { color: #f00; }
        
        #msg-list {
            flex: 1; padding: 20px; overflow-y: auto; background: #f7f9fb;
            display: flex; flex-direction: column; gap: 15px;
            background-image: radial-gradient(#ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .msg-card {
            background: #fff; padding: 12px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1rem; max-width: 70%;
            border: 1px solid #eee; position: relative;
        }
        .msg-mine { align-self: flex-end; background: #e6f2ff; border: 1px solid #cce5ff; }
        .msg-other { align-self: flex-start; background: #fff; }
        
        .msg-name { font-size: 0.7rem; color: #888; margin-bottom: 4px; font-weight: bold; }
        .msg-content img { max-width: 100%; border-radius: 4px; margin-top: 5px; cursor: pointer; }

        .input-area {
            padding: 15px; border-top: 1px solid #eee; background: #fff;
            display: flex; gap: 10px; align-items: center;
        }
        #chat-input { 
            flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; 
            outline: none; font-size: 1rem; font-family: inherit; transition: border 0.2s;
        }
        #chat-input:focus { border-color: #007aff; }

        #photo-btn, #send-btn { 
            background: #f0f0f0; color: #555; border: none; 
            width: 44px; height: 44px; border-radius: 8px; 
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        #send-btn { background: #007aff; color: #fff; font-weight: bold; width: auto; padding: 0 20px; font-size: 1rem; }
        #photo-btn:hover { background: #e0e0e0; }
        #send-btn:hover { background: #0060c0; }

    </style>
</head>
<body>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼å…¨ä½“ -->
    <div class="sidebar">
        
        <!-- ä¸ŠåŠåˆ†ï¼šç™½èƒŒæ™¯ã‚¨ãƒªã‚¢ -->
        <div class="sidebar-upper">
            <!-- æˆ»ã‚‹ -->
            <div class="back-nav"><span>ï¼œ</span> æˆ»ã‚‹</div>
            
            <!-- â˜…ã‚«ãƒ¡ãƒ© (ç”»åƒURLã‚’å…¥ã‚Œã¦ãã ã•ã„)â˜… -->
            <div class="icon-btn">
                <img src="kamera.png" alt="ã‚«ãƒ¡ãƒ©">
            </div>

            <!-- â˜…ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒãƒ£ãƒƒãƒˆã‚¹ã‚¤ãƒƒãƒï¼‰â˜… -->
            <div class="icon-btn" id="toggle-chat-btn">
                <img src="text.png" alt="ãƒ†ã‚­ã‚¹ãƒˆ">
            </div>

            <!-- â˜…Webâ˜… -->
            <div class="icon-btn">
                <img src="web.png" alt="Web">
            </div>
            
            <!-- â˜…ãƒ•ã‚¡ã‚¤ãƒ«â˜… -->
            <div class="icon-btn">
                <img src="file.png" alt="ãƒ•ã‚¡ã‚¤ãƒ«">
            </div>
            
            <!-- â˜…ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«â˜… -->
            <div class="icon-btn">
                <img src="think.png" alt="ã‚·ãƒ³ã‚­ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«">
            </div>
            
            <!-- â˜…ãƒ†ã‚¹ãƒˆâ˜… -->
            <div class="icon-btn">
                <img src="test.png" alt="ãƒ†ã‚¹ãƒˆ">
            </div>
        </div>

        <!-- ä¸‹åŠåˆ†ï¼šç´ºèƒŒæ™¯ã‚¨ãƒªã‚¢ï¼ˆbodyã®è‰²ãŒé€ã‘ã‚‹ï¼‰ -->
        <div class="sidebar-lower">
            <!-- è³‡æ–™ç®± -->
            <div class="circle-wrapper">
                <div class="circle-icon">
                    <img src="si.png" alt="è³‡æ–™ç®±">
                </div>
                <div class="icon-label-white">è³‡æ–™ç®±</div>
            </div>

            <!-- æå‡º -->
            <div class="circle-wrapper">
                <div class="circle-icon">
                    <img src="te.png" alt="æå‡º">
                </div>
                <div class="icon-label-white">æå‡º</div>
            </div>

            <!-- é€ã‚‹ -->
            <div class="circle-wrapper">
                <div class="circle-icon">
                    <img src="o.png" alt="é€ã‚‹">
                </div>
                <div class="icon-label-white">é€ã‚‹</div>
            </div>
        </div>

    </div>

    <!-- å³ä¸Šã®æƒ…å ± -->
    <div class="header-info">
        <div class="user-name-area" id="user-name-display">
            <span class="user-icon-mini"></span> 
            <span id="current-name">ã“ã“ã«åå‰ã‚’å…¥åŠ›</span> 
            <span style="font-size:0.8rem; margin-left:5px;">âˆ¨</span>
        </div>
        <div class="class-info">
            2å¹´6çµ„ / è‹±èªA<br>
            <span id="current-date">--</span>
        </div>
    </div>

    <!-- å³ä¸‹ã®ã‚´ãƒŸç®± -->
    <div class="trash-area">
        <img src="gomi.png" class="trash-img" alt="ã‚´ãƒŸç®±">
        <div class="saved-badge">ä¿å­˜æ¸ˆã¿</div>
    </div>

    <!-- ä¸­å¤®ã®ãƒãƒ£ãƒƒãƒˆç”»é¢ï¼ˆæœ€åˆã¯éš ã‚Œã¦ã„ã‚‹ï¼‰ -->
    <div id="chat-overlay">
        <div class="chat-header">
            ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            <span class="close-btn" id="close-chat-x">Ã—</span>
        </div>
        <div id="msg-list">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        <div class="input-area">
            <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼ˆéš ã—è¦ç´ ï¼‰ -->
            <input type="file" id="file-input" accept="image/*" style="display: none;">
            
            <button id="photo-btn" title="å†™çœŸã‚’è¿½åŠ ">ğŸ“·</button>
            <input type="text" id="chat-input" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›..." autocomplete="off">
            <button id="send-btn">å®Œäº†</button>
        </div>
    </div>

    <!-- Firebaseå‡¦ç† -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ã‚ãªãŸã®Firebaseè¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyD-ZjLNRLuQt5H_cEjIW7pz2sqb7_fOXIc",
          authDomain: "my-chat-web-dd1e0.firebaseapp.com",
          projectId: "my-chat-web-dd1e0",
          storageBucket: "my-chat-web-dd1e0.firebasestorage.app",
          messagingSenderId: "305254951478",
          appId: "1:305254951478:web:2e53276498acd388e14697",
          measurementId: "G-M84CV53JEK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // UIè¦ç´ 
        const toggleBtn = document.getElementById("toggle-chat-btn");
        const chatOverlay = document.getElementById("chat-overlay");
        const closeX = document.getElementById("close-chat-x");
        const nameDisplay = document.getElementById("user-name-display");
        const currentNameSpan = document.getElementById("current-name");
        const dateSpan = document.getElementById("current-date");
        const msgList = document.getElementById("msg-list");
        const chatInput = document.getElementById("chat-input");
        const sendBtn = document.getElementById("send-btn");
        const photoBtn = document.getElementById("photo-btn");
        const fileInput = document.getElementById("file-input");

        // æ—¥ä»˜è¨­å®š
        const now = new Date();
        dateSpan.textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ã®ãƒãƒ¼ãƒˆ`;

        // åå‰ã®ç®¡ç†
        let myName = localStorage.getItem('loilo_v2_name') || "ã“ã“ã«åå‰ã‚’å…¥åŠ›";
        currentNameSpan.textContent = myName;

        nameDisplay.addEventListener('click', () => {
            const newName = prompt("è¡¨ç¤ºåã‚’å¤‰æ›´:", myName);
            if(newName && newName.trim() !== ""){
                myName = newName;
                currentNameSpan.textContent = myName;
                localStorage.setItem('loilo_v2_name', myName);
            }
        });

        // è‡ªåˆ†ã®ID
        const myUid = localStorage.getItem('loilo_v2_uid') || Math.random().toString(36).substring(7);
        localStorage.setItem('loilo_v2_uid', myUid);

        // ãƒãƒ£ãƒƒãƒˆé–‹é–‰
        let isChatOpen = false;
        function toggleChat(forceState) {
            if (forceState !== undefined) isChatOpen = forceState;
            else isChatOpen = !isChatOpen;
            
            chatOverlay.style.display = isChatOpen ? "flex" : "none";
            if(isChatOpen) {
                chatInput.focus();
                msgList.scrollTop = msgList.scrollHeight;
            }
        }
        toggleBtn.addEventListener("click", (e) => { e.stopPropagation(); toggleChat(); });
        closeX.addEventListener("click", () => toggleChat(false));
        document.body.addEventListener("click", (e) => {
            if (!chatOverlay.contains(e.target) && !toggleBtn.contains(e.target)) toggleChat(false);
        });

        // é€ä¿¡å‡¦ç†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ or ç”»åƒï¼‰
        async function sendPayload(text = "", imageUrl = null) {
            if (!text && !imageUrl) return;

            try {
                await addDoc(collection(db, "fake_loilo_v2"), {
                    text: text,
                    imageUrl: imageUrl, 
                    name: myName,
                    uid: myUid,
                    createdAt: serverTimestamp()
                });
                chatInput.value = "";
            } catch (e) {
                console.error("Error:", e);
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼");
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
        sendBtn.addEventListener("click", () => sendPayload(chatInput.value));
        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendPayload(chatInput.value);
        });

        // å†™çœŸãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
        photoBtn.addEventListener("click", () => {
            fileInput.click();
        });

        // ç”»åƒé¸æŠæ™‚
        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 2000000) { // 2MBåˆ¶é™
                alert("ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚");
                return;
            }
            const reader = new FileReader();
            reader.onload = function(evt) {
                sendPayload("", evt.target.result);
            };
            reader.readAsDataURL(file);
            fileInput.value = "";
        });

        // å—ä¿¡
        const q = query(collection(db, "fake_loilo_v2"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            msgList.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const div = document.createElement("div");
                div.classList.add("msg-card");
                
                if (data.uid === myUid) div.classList.add("msg-mine");
                else div.classList.add("msg-other");

                let contentHtml = "";
                if (data.imageUrl) {
                    contentHtml += `<img src="${data.imageUrl}" onclick="window.open(this.src)">`;
                }
                if (data.text) {
                    contentHtml += `<div>${escapeHtml(data.text)}</div>`;
                }

                div.innerHTML = `
                    <div class="msg-name">${escapeHtml(data.name)}</div>
                    <div class="msg-content">${contentHtml}</div>
                `;
                msgList.appendChild(div);
            });
            msgList.scrollTop = msgList.scrollHeight;
        });

        function escapeHtml(str) {
            if(!str) return "";
            return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
        }
    </script>
</body>
</html>